
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>utool.util_cache &#8212; wbia-vtool 3.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for utool.util_cache</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module needs serious refactoring and testing</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">shelve</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># import lru</span>
<span class="c1"># git+https://github.com/amitdev/lru-dict</span>
<span class="c1"># import atexit</span>
<span class="c1"># import inspect</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">cPickle</span> <span class="k">as</span> <span class="n">pickle</span>  <span class="c1"># NOQA</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">normpath</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_arg</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_hash</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_inject</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_path</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_io</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_str</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_cplat</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_inspect</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_list</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_class</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_type</span>

<span class="c1"># from utool import util_decor</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dict</span>
<span class="kn">from</span> <span class="nn">utool._internal</span> <span class="kn">import</span> <span class="n">meta_util_constants</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">util_inject</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># TODO: Remove globalness</span>

<span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">VERBOSE</span>
<span class="n">QUIET</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">QUIET</span>
<span class="n">VERBOSE_CACHE</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">NOT_QUIET</span>
<span class="n">USE_CACHE</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--nocache&#39;</span><span class="p">)</span>
<span class="n">__APPNAME__</span> <span class="o">=</span> <span class="n">meta_util_constants</span><span class="o">.</span><span class="n">default_appname</span>  <span class="c1"># the global application name</span>


<div class="viewcode-block" id="CacheMissException"><a class="viewcode-back" href="../../utool.html#utool.util_cache.CacheMissException">[docs]</a><span class="k">class</span> <span class="nc">CacheMissException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="c1"># class YACacher(object):</span>
<span class="c1"># @six.add_metaclass(util_class.ReloadingMetaclass)</span>
<div class="viewcode-block" id="ShelfCacher"><a class="viewcode-back" href="../../utool.html#utool.util_cache.ShelfCacher">[docs]</a><span class="nd">@util_class</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">ShelfCacher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;yet another cacher&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[shelfcache] initializing()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">enabled</span> <span class="k">else</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cachekey</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cachekey</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="ShelfCacher.keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.ShelfCacher.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="ShelfCacher.load"><a class="viewcode-back" href="../../utool.html#utool.util_cache.ShelfCacher.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[shelfcache] loading </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cachekey</span><span class="p">,))</span>

        <span class="n">cachekey</span> <span class="o">=</span> <span class="n">cachekey</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cachekey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CacheMissException</span><span class="p">(</span>
                <span class="s1">&#39;Cache miss cachekey=</span><span class="si">%r</span><span class="s1"> self.fpath=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cachekey</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="p">[</span><span class="n">cachekey</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShelfCacher.save"><a class="viewcode-back" href="../../utool.html#utool.util_cache.ShelfCacher.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachekey</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[shelfcache] saving </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cachekey</span><span class="p">,))</span>

        <span class="n">cachekey</span> <span class="o">=</span> <span class="n">cachekey</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="p">[</span><span class="n">cachekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span></div>

<div class="viewcode-block" id="ShelfCacher.clear"><a class="viewcode-back" href="../../utool.html#utool.util_cache.ShelfCacher.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[shelfcache] clearing cache&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span></div>

<div class="viewcode-block" id="ShelfCacher.close"><a class="viewcode-back" href="../../utool.html#utool.util_cache.ShelfCacher.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[shelfcache] closing()&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="get_default_appname"><a class="viewcode-back" href="../../utool.html#utool.util_cache.get_default_appname">[docs]</a><span class="k">def</span> <span class="nf">get_default_appname</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">__APPNAME__</span>
    <span class="k">return</span> <span class="n">__APPNAME__</span></div>


<div class="viewcode-block" id="text_dict_read"><a class="viewcode-back" href="../../utool.html#utool.util_cache.text_dict_read">[docs]</a><span class="k">def</span> <span class="nf">text_dict_read</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
            <span class="n">dict_text</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">dict_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">dict_text</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">dict_text</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Bad Syntax&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dict_text&#39;</span><span class="p">])</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">SUPER_STRICT</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="n">dict_</span></div>


<div class="viewcode-block" id="text_dict_write"><a class="viewcode-back" href="../../utool.html#utool.util_cache.text_dict_write">[docs]</a><span class="k">def</span> <span class="nf">text_dict_write</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Very naive, but readable way of storing a dictionary on disk</span>
<span class="sd">    FIXME: This broke on RoseMary&#39;s big dataset. Not sure why. It gave bad</span>
<span class="sd">    syntax. And the SyntaxError did not seem to be excepted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># dict_ = text_dict_read(fpath)</span>
    <span class="c1"># dict_[key] = val</span>
    <span class="n">dict_text2</span> <span class="o">=</span> <span class="n">util_str</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dict_text2</span><span class="p">))</span>
    <span class="n">util_io</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dict_text2</span><span class="p">)</span></div>


<div class="viewcode-block" id="consensed_cfgstr"><a class="viewcode-back" href="../../utool.html#utool.util_cache.consensed_cfgstr">[docs]</a><span class="k">def</span> <span class="nf">consensed_cfgstr</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">cfgstr_hashlen</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfgstr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="n">hashed_cfgstr</span> <span class="o">=</span> <span class="n">util_hash</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">cfgstr</span><span class="p">,</span> <span class="n">hashlen</span><span class="o">=</span><span class="n">cfgstr_hashlen</span><span class="p">)</span>
        <span class="c1"># Hack for prettier names</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">fname_cfgstr</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">hashed_cfgstr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname_cfgstr</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">hashed_cfgstr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname_cfgstr</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">cfgstr</span>
    <span class="k">return</span> <span class="n">fname_cfgstr</span></div>


<span class="k">def</span> <span class="nf">_args2_fpath</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures that the filename is not too long</span>

<span class="sd">    Internal util_cache helper function</span>
<span class="sd">    Windows MAX_PATH=260 characters</span>
<span class="sd">    Absolute length is limited to 32,000 characters</span>
<span class="sd">    Each filename component is limited to 255 characters</span>

<span class="sd">    Args:</span>
<span class="sd">        dpath (str):</span>
<span class="sd">        fname (str):</span>
<span class="sd">        cfgstr (str):</span>
<span class="sd">        ext (str):</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: fpath</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --test-_args2_fpath</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import _args2_fpath</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; dpath = &#39;F:\\data\\work\\PZ_MTEST\\_ibsdb\\_wbia_cache&#39;</span>
<span class="sd">        &gt;&gt;&gt; fname = &#39;normalizer_&#39;</span>
<span class="sd">        &gt;&gt;&gt; cfgstr = u&#39;PZ_MTEST_DSUUIDS((9)67j%dr%&amp;bl%4oh4+)_QSUUIDS((9)67j%dr%&amp;bl%4oh4+)zebra_plains_vsone_NN(single,K1+1,last,cks1024)_FILT(ratio&lt;0.625;1.0,fg;1.0)_SV(0.01;2;1.57minIn=4,nRR=50,nsum,)_AGG(nsum)_FLANN(4_kdtrees)_FEATWEIGHT(ON,uselabel,rf)_FEAT(hesaff+sift_)_CHIP(sz450)&#39;</span>
<span class="sd">        &gt;&gt;&gt; ext = &#39;.cPkl&#39;</span>
<span class="sd">        &gt;&gt;&gt; fpath = _args2_fpath(dpath, fname, cfgstr, ext)</span>
<span class="sd">        &gt;&gt;&gt; result = str(ut.ensure_unixslash(fpath))</span>
<span class="sd">        &gt;&gt;&gt; target = &#39;F:/data/work/PZ_MTEST/_ibsdb/_wbia_cache/normalizer_xfylfboirymmcpfg.cPkl&#39;</span>
<span class="sd">        &gt;&gt;&gt; ut.assert_eq(result, target)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please be explicit and use a dot in ext&#39;</span><span class="p">)</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="c1"># should hashlen be larger?</span>
    <span class="n">cfgstr_hashlen</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">fname</span>
    <span class="n">fname_cfgstr</span> <span class="o">=</span> <span class="n">consensed_cfgstr</span><span class="p">(</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span> <span class="n">cfgstr_hashlen</span><span class="o">=</span><span class="n">cfgstr_hashlen</span>
    <span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname_cfgstr</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">normpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fpath</span>


<div class="viewcode-block" id="save_cache"><a class="viewcode-back" href="../../utool.html#utool.util_cache.save_cache">[docs]</a><span class="k">def</span> <span class="nf">save_cache</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.cPkl&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves data using util_io, but smartly constructs a filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">_args2_fpath</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    <span class="n">util_io</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fpath</span></div>


<div class="viewcode-block" id="load_cache"><a class="viewcode-back" href="../../utool.html#utool.util_cache.load_cache">[docs]</a><span class="k">def</span> <span class="nf">load_cache</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.cPkl&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data using util_io, but smartly constructs a filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERBOSE_CACHE</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">USE_CACHE</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">enabled</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[util_cache] ... cache disabled: dpath=</span><span class="si">%s</span><span class="s1"> cfgstr=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">cfgstr</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Cache Loading Is Disabled&#39;</span><span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="n">_args2_fpath</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[util_cache] ... cache does not exist: dpath=</span><span class="si">%r</span><span class="s1"> fname=</span><span class="si">%r</span><span class="s1"> cfgstr=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;No such file or directory: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[util_cache] ... cache exists: dpath=</span><span class="si">%r</span><span class="s1"> fname=</span><span class="si">%r</span><span class="s1"> cfgstr=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="n">nbytes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_file_nBytes</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">big_verbose</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="mf">1e6</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">big_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_cache] About to read file of size </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">nbytes</span><span class="p">),))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">big_verbose</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">util_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">EOFError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CORRUPTED? fpath = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[util_cache] ... cache miss dpath=</span><span class="si">%s</span><span class="s1"> cfgstr=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">dpath</span><span class="p">),</span> <span class="n">cfgstr</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CORRUPTED? fpath = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,))</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_cache] ... cache hit&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="tryload_cache"><a class="viewcode-back" href="../../utool.html#utool.util_cache.tryload_cache">[docs]</a><span class="k">def</span> <span class="nf">tryload_cache</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns None if cache cannot be loaded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_cache</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="tryload_cache_list"><a class="viewcode-back" href="../../utool.html#utool.util_cache.tryload_cache_list">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">tryload_cache_list</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    loads a list of similar cached datas. Returns flags that needs to be computed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tryload_cache</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span> <span class="k">for</span> <span class="n">cfgstr</span> <span class="ow">in</span> <span class="n">cfgstr_list</span><span class="p">]</span>
    <span class="n">ismiss_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">ismiss_list</span></div>


<div class="viewcode-block" id="tryload_cache_list_with_compute"><a class="viewcode-back" href="../../utool.html#utool.util_cache.tryload_cache_list_with_compute">[docs]</a><span class="nd">@profile</span>
<span class="k">def</span> <span class="nf">tryload_cache_list_with_compute</span><span class="p">(</span>
    <span class="n">use_cache</span><span class="p">,</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr_list</span><span class="p">,</span> <span class="n">compute_fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tries to load data, but computes it if it can&#39;t give a compute function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load precomputed values</span>
    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfgstr_list</span><span class="p">)</span>
        <span class="n">ismiss_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfgstr_list</span><span class="p">)</span>
        <span class="c1"># Don&#39;t load or save, just compute</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="n">compute_fn</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_list</span><span class="p">,</span> <span class="n">ismiss_list</span> <span class="o">=</span> <span class="n">tryload_cache_list</span><span class="p">(</span>
            <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="n">num_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfgstr_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">):</span>
        <span class="c1"># Compute missing values</span>
        <span class="n">newdata_list</span> <span class="o">=</span> <span class="n">compute_fn</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">newcfgstr_list</span> <span class="o">=</span> <span class="n">util_list</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">cfgstr_list</span><span class="p">,</span> <span class="n">ismiss_list</span><span class="p">)</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">util_list</span><span class="o">.</span><span class="n">list_where</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;[cache] </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> cache hits for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">num_total</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">),</span> <span class="n">num_total</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">util_path</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">dpath</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># Cache write</span>
        <span class="k">for</span> <span class="n">newcfgstr</span><span class="p">,</span> <span class="n">newdata</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">newcfgstr_list</span><span class="p">,</span> <span class="n">newdata_list</span><span class="p">):</span>
            <span class="n">save_cache</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">newcfgstr</span><span class="p">,</span> <span class="n">newdata</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Populate missing result</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">newdata</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">newdata_list</span><span class="p">):</span>
            <span class="n">data_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">newdata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;[cache] </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> cache hits for </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">num_total</span><span class="p">,</span> <span class="n">num_total</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">util_path</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">dpath</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">data_list</span></div>


<div class="viewcode-block" id="Cacher"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher">[docs]</a><span class="k">class</span> <span class="nc">Cacher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    old non inhertable version of cachable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fname</span><span class="p">,</span>
        <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;utool&#39;</span><span class="p">,</span>
        <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.cPkl&#39;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERBOSE</span>
        <span class="k">if</span> <span class="n">cache_dir</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">util_cplat</span><span class="o">.</span><span class="n">get_app_resource_dir</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span>
        <span class="n">util_path</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dpath</span> <span class="o">=</span> <span class="n">cache_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfgstr</span> <span class="o">=</span> <span class="n">cfgstr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>

<div class="viewcode-block" id="Cacher.get_fpath"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.get_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">_args2_fpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgstr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Cacher.existing_versions"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.existing_versions">[docs]</a>    <span class="k">def</span> <span class="nf">existing_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns data with different cfgstr values that were previously computed</span>
<span class="sd">        with this cacher.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">glob</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_*&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Cacher.exists"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">())</span></div>

<div class="viewcode-block" id="Cacher.load"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cfgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgstr</span> <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfgstr</span>
        <span class="c1"># assert cfgstr is not None, &#39;must specify cfgstr in constructor or call&#39;</span>
        <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No cfgstr given in Cacher constructor or call&#39;</span><span class="p">)</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;no fname&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;no dpath&#39;</span>
        <span class="c1"># TODO: use the computed fpath from this object instead</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">load_cache</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="n">cfgstr</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] ... &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39; Cacher hit&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Cacher.tryload"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.tryload">[docs]</a>    <span class="k">def</span> <span class="nf">tryload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Like load, but returns None if the load fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgstr</span>
        <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No cfgstr given in Cacher constructor or call&#39;</span><span class="p">)</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># assert cfgstr is not None, (</span>
        <span class="c1">#     &#39;must specify cfgstr in constructor or call&#39;)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] ... </span><span class="si">%s</span><span class="s1"> Cacher disabled&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] tryload fname=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,))</span>
                <span class="c1"># if self.verbose &gt; 2:</span>
                <span class="c1">#     print(&#39;[cache] cfgstr=%r&#39; % (cfgstr,))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cfgstr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] ... </span><span class="si">%s</span><span class="s1"> Cacher miss&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cacher.ensure"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.ensure">[docs]</a>    <span class="k">def</span> <span class="nf">ensure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tryload</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Cacher.save"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cacher.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cfgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgstr</span> <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfgstr</span>
        <span class="c1"># assert cfgstr is not None, &#39;must specify cfgstr in constructor or call&#39;</span>
        <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">warnings</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No cfgstr given in Cacher constructor or call&#39;</span><span class="p">)</span>
            <span class="n">cfgstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;no fname&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dpath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;no dpath&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] ... &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39; Cacher save&#39;</span><span class="p">)</span>
        <span class="n">save_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span></div></div>


<span class="c1"># @util_decor.memoize</span>
<div class="viewcode-block" id="make_utool_json_encoder"><a class="viewcode-back" href="../../utool.html#utool.util_cache.make_utool_json_encoder">[docs]</a><span class="k">def</span> <span class="nf">make_utool_json_encoder</span><span class="p">(</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    References:</span>
<span class="sd">        http://stackoverflow.com/questions/8230315/python-sets-are</span>
<span class="sd">        http://stackoverflow.com/questions/11561932/why-does-json</span>
<span class="sd">        https://github.com/jsonpickle/jsonpickle</span>
<span class="sd">        http://stackoverflow.com/questions/24369666/typeerror-b1</span>
<span class="sd">        http://stackoverflow.com/questions/30469575/how-to-pickle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">PYOBJECT_TAG</span> <span class="o">=</span> <span class="s1">&#39;__PYTHON_OBJECT__&#39;</span>
    <span class="n">UUID_TAG</span> <span class="o">=</span> <span class="s1">&#39;__UUID__&#39;</span>
    <span class="n">SLICE_TAG</span> <span class="o">=</span> <span class="s1">&#39;__SLICE__&#39;</span>

    <span class="k">def</span> <span class="nf">decode_pickle</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s1">&#39;base64&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">encode_pickle</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use protocol 2 to support both python2.7 and python3</span>
            <span class="n">COMPATIBLE_PROTOCOL</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">pickle_bytes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">COMPATIBLE_PROTOCOL</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">pickle_bytes</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="n">type_to_tag</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
        <span class="p">[(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">SLICE_TAG</span><span class="p">),</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span> <span class="n">UUID_TAG</span><span class="p">),</span> <span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">PYOBJECT_TAG</span><span class="p">)]</span>
    <span class="p">)</span>

    <span class="n">tag_to_type</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">type_</span> <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">type_to_tag</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">slice_part</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">encode_slice</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">slice_part</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">start</span><span class="p">),</span> <span class="n">slice_part</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span> <span class="n">slice_part</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">step</span><span class="p">)]</span>
        <span class="k">return</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode_slice</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">smart_cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)</span>

    <span class="n">encoders</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">UUID_TAG</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">SLICE_TAG</span><span class="p">:</span> <span class="n">encode_slice</span><span class="p">,</span>
        <span class="n">PYOBJECT_TAG</span><span class="p">:</span> <span class="n">encode_pickle</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">decoders</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">UUID_TAG</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span>
        <span class="n">SLICE_TAG</span><span class="p">:</span> <span class="n">decode_slice</span><span class="p">,</span>
        <span class="n">PYOBJECT_TAG</span><span class="p">:</span> <span class="n">decode_pickle</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_pickle</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">encoders</span><span class="p">[</span><span class="n">PYOBJECT_TAG</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">decoders</span><span class="p">[</span><span class="n">PYOBJECT_TAG</span><span class="p">]</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">tag_to_type</span><span class="p">[</span><span class="n">PYOBJECT_TAG</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">tag_to_type</span><span class="p">[</span><span class="n">PYOBJECT_TAG</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">type_to_tag</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span>

    <span class="k">class</span> <span class="nc">UtoolJSONEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">util_type</span><span class="o">.</span><span class="n">NUMPY_TYPE_TUPLE</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="c1"># return json.JSONEncoder.default(self, list(obj))</span>
                <span class="c1"># return [json.JSONEncoder.default(o) for o in obj]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">util_type</span><span class="o">.</span><span class="n">PRIMATIVE_TYPES</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__getstate__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">type_to_tag</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
                        <span class="c1"># print(&#39;----&#39;)</span>
                        <span class="c1"># print(&#39;encoder obj = %r&#39; % (obj,))</span>
                        <span class="c1"># print(&#39;encoder type_ = %r&#39; % (type_,))</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">encoders</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid serialization type=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)))</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">_json_object_hook</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">decoders</span><span class="p">:</span>
                    <span class="c1"># print(&#39;----&#39;)</span>
                    <span class="c1"># print(&#39;decoder tag = %r&#39; % (tag,))</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">decoders</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="c1"># print(&#39;decoder obj = %r&#39; % (obj,))</span>
                    <span class="k">return</span> <span class="n">obj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">UtoolJSONEncoder</span></div>


<div class="viewcode-block" id="to_json"><a class="viewcode-back" href="../../utool.html#utool.util_cache.to_json">[docs]</a><span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a python object to a JSON string using the utool convention</span>

<span class="sd">    Args:</span>
<span class="sd">        val (object):</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: json_str</span>

<span class="sd">    References:</span>
<span class="sd">        http://stackoverflow.com/questions/11561932/why-does-json-dumpslistnp</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --test-to_json</span>
<span class="sd">        python3 -m utool.util_cache --test-to_json</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; import uuid</span>
<span class="sd">        &gt;&gt;&gt; val = [</span>
<span class="sd">        &gt;&gt;&gt;     &#39;{&quot;foo&quot;: &quot;not a dict&quot;}&#39;,</span>
<span class="sd">        &gt;&gt;&gt;     1.3,</span>
<span class="sd">        &gt;&gt;&gt;     [1],</span>
<span class="sd">        &gt;&gt;&gt;     # {1: 1, 2: 2, 3: 3}, cant use integer keys</span>
<span class="sd">        &gt;&gt;&gt;     {1, 2, 3},</span>
<span class="sd">        &gt;&gt;&gt;     slice(1, None, 1),</span>
<span class="sd">        &gt;&gt;&gt;     b&#39;an ascii string&#39;,</span>
<span class="sd">        &gt;&gt;&gt;     np.array([1, 2, 3]),</span>
<span class="sd">        &gt;&gt;&gt;     ut.get_zero_uuid(),</span>
<span class="sd">        &gt;&gt;&gt;     ut.LazyDict(x=&#39;fo&#39;),</span>
<span class="sd">        &gt;&gt;&gt;     ut.LazyDict,</span>
<span class="sd">        &gt;&gt;&gt;     {&#39;x&#39;: {&#39;a&#39;, &#39;b&#39;, &#39;cde&#39;}, &#39;y&#39;: [1]}</span>
<span class="sd">        &gt;&gt;&gt; ]</span>
<span class="sd">        &gt;&gt;&gt; #val = ut.LazyDict(x=&#39;fo&#39;)</span>
<span class="sd">        &gt;&gt;&gt; allow_pickle = True</span>
<span class="sd">        &gt;&gt;&gt; if not allow_pickle:</span>
<span class="sd">        &gt;&gt;&gt;     val = val[:-2]</span>
<span class="sd">        &gt;&gt;&gt; json_str = ut.to_json(val, allow_pickle=allow_pickle)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.repr3(json_str)</span>
<span class="sd">        &gt;&gt;&gt; reload_val = ut.from_json(json_str, allow_pickle=allow_pickle)</span>
<span class="sd">        &gt;&gt;&gt; # Make sure pickle doesnt happen by default</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        &gt;&gt;&gt;     json_str = ut.to_json(val)</span>
<span class="sd">        &gt;&gt;&gt;     assert False or not allow_pickle, &#39;expected a type error&#39;</span>
<span class="sd">        &gt;&gt;&gt; except TypeError:</span>
<span class="sd">        &gt;&gt;&gt;     print(&#39;Correctly got type error&#39;)</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        &gt;&gt;&gt;     json_str = ut.from_json(val)</span>
<span class="sd">        &gt;&gt;&gt;     assert False, &#39;expected a type error&#39;</span>
<span class="sd">        &gt;&gt;&gt; except TypeError:</span>
<span class="sd">        &gt;&gt;&gt;     print(&#39;Correctly got type error&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;original = &#39; + ut.repr3(val, nl=1))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;reconstructed = &#39; + ut.repr3(reload_val, nl=1))</span>
<span class="sd">        &gt;&gt;&gt; assert reload_val[6] == val[6].tolist()</span>
<span class="sd">        &gt;&gt;&gt; assert reload_val[6] is not val[6]</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # test 3.7 safe uuid</span>
<span class="sd">        &gt;&gt;&gt; import uuid</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; ut.to_json([uuid.uuid4()])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">UtoolJSONEncoder</span> <span class="o">=</span> <span class="n">make_utool_json_encoder</span><span class="p">(</span><span class="n">allow_pickle</span><span class="p">)</span>
    <span class="n">json_kw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">json_kw</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UtoolJSONEncoder</span>
    <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>
        <span class="n">json_kw</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">json_kw</span><span class="p">[</span><span class="s1">&#39;separators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)</span>
    <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">**</span><span class="n">json_kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_str</span></div>


<div class="viewcode-block" id="from_json"><a class="viewcode-back" href="../../utool.html#utool.util_cache.from_json">[docs]</a><span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decodes a JSON object specified in the utool convention</span>

<span class="sd">    Args:</span>
<span class="sd">        json_str (str):</span>
<span class="sd">        allow_pickle (bool): (default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        object: val</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache from_json --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; json_str = &#39;just a normal string&#39;</span>
<span class="sd">        &gt;&gt;&gt; json_str = &#39;[&quot;just a normal string&quot;]&#39;</span>
<span class="sd">        &gt;&gt;&gt; allow_pickle = False</span>
<span class="sd">        &gt;&gt;&gt; val = from_json(json_str, allow_pickle)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;val = %s&#39; % (ut.repr2(val),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">UtoolJSONEncoder</span> <span class="o">=</span> <span class="n">make_utool_json_encoder</span><span class="p">(</span><span class="n">allow_pickle</span><span class="p">)</span>
    <span class="n">object_hook</span> <span class="o">=</span> <span class="n">UtoolJSONEncoder</span><span class="o">.</span><span class="n">_json_object_hook</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">object_hook</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span></div>


<div class="viewcode-block" id="get_func_result_cachekey"><a class="viewcode-back" href="../../utool.html#utool.util_cache.get_func_result_cachekey">[docs]</a><span class="k">def</span> <span class="nf">get_func_result_cachekey</span><span class="p">(</span><span class="n">func_</span><span class="p">,</span> <span class="n">args_</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(),</span> <span class="n">kwargs_</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: recursive partial definitions</span>
<span class="sd">    kwargs = {}</span>
<span class="sd">    args = ([],)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="c1"># Rectify partials and whatnot</span>
    <span class="n">true_args</span> <span class="o">=</span> <span class="n">args_</span>
    <span class="n">true_kwargs</span> <span class="o">=</span> <span class="n">kwargs_</span>
    <span class="n">true_func</span> <span class="o">=</span> <span class="n">func_</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_</span><span class="p">,</span> <span class="n">partial</span><span class="p">):</span>
        <span class="n">true_func</span> <span class="o">=</span> <span class="n">func_</span><span class="o">.</span><span class="n">func</span>
        <span class="k">if</span> <span class="n">func_</span><span class="o">.</span><span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">true_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">func_</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args_</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">func_</span><span class="o">.</span><span class="n">keywords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">true_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func_</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_method</span><span class="p">(</span><span class="n">true_func</span><span class="p">):</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">true_func</span>
        <span class="n">true_func</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_func</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">im_self</span>
        <span class="n">true_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">true_args</span><span class="p">))</span>

    <span class="c1"># Build up cachekey</span>
    <span class="n">funcname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">true_func</span><span class="p">)</span>
    <span class="n">kwdefaults</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_kwdefaults</span><span class="p">(</span><span class="n">true_func</span><span class="p">,</span> <span class="n">parse_source</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># kwdefaults = ut.get_kwdefaults(true_func, parse_source=True)</span>
    <span class="n">argnames</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argnames</span><span class="p">(</span><span class="n">true_func</span><span class="p">)</span>
    <span class="n">key_argx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">key_kwds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">true_func</span>  <span class="c1"># NOQA</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">true_args</span>  <span class="c1"># NOQA</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">true_kwargs</span>  <span class="c1"># NOQA</span>
    <span class="n">args_key</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_cfgstr_from_args</span><span class="p">(</span>
        <span class="n">true_func</span><span class="p">,</span> <span class="n">true_args</span><span class="p">,</span> <span class="n">true_kwargs</span><span class="p">,</span> <span class="n">key_argx</span><span class="p">,</span> <span class="n">key_kwds</span><span class="p">,</span> <span class="n">kwdefaults</span><span class="p">,</span> <span class="n">argnames</span>
    <span class="p">)</span>
    <span class="n">cachekey</span> <span class="o">=</span> <span class="n">funcname</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">args_key</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">return</span> <span class="n">cachekey</span></div>


<div class="viewcode-block" id="cachestr_repr"><a class="viewcode-back" href="../../utool.html#utool.util_cache.cachestr_repr">[docs]</a><span class="k">def</span> <span class="nf">cachestr_repr</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Representation of an object as a cache string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">memview</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">memview</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_json</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># SUPER HACK</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
                <span class="o">==</span> <span class="s2">&quot;&lt;class &#39;wbia.control.IBEISControl.IBEISController&#39;&gt;&quot;</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">get_dbname</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_cfgstr_from_args"><a class="viewcode-back" href="../../utool.html#utool.util_cache.get_cfgstr_from_args">[docs]</a><span class="k">def</span> <span class="nf">get_cfgstr_from_args</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">key_argx</span><span class="p">,</span> <span class="n">key_kwds</span><span class="p">,</span> <span class="n">kwdefaults</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">use_hash</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dev:</span>
<span class="sd">        argx = [&#39;fdsf&#39;, &#39;432443432432&#39;, 43423432, &#39;fdsfsd&#39;, 3.2, True]</span>
<span class="sd">        memlist = list(map(cachestr_repr, argx))</span>

<span class="sd">    Ignore:</span>
<span class="sd">        argx = key_argx[0]</span>
<span class="sd">        argval = args[argx]</span>
<span class="sd">        val = argval</span>
<span class="sd">        %timeit repr(argval)</span>
<span class="sd">        %timeit to_json(argval)</span>
<span class="sd">        %timeit utool.hashstr(to_json(argval))</span>
<span class="sd">        %timeit memoryview(argval)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; use_hash = None</span>
<span class="sd">        &gt;&gt;&gt; func = consensed_cfgstr</span>
<span class="sd">        &gt;&gt;&gt; args = (&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;)</span>
<span class="sd">        &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">        &gt;&gt;&gt; key_argx = [0, 1, 2]</span>
<span class="sd">        &gt;&gt;&gt; key_kwds = []</span>
<span class="sd">        &gt;&gt;&gt; kwdefaults = ut.util_inspect.get_kwdefaults(func)</span>
<span class="sd">        &gt;&gt;&gt; argnames   = ut.util_inspect.get_argnames(func)</span>
<span class="sd">        &gt;&gt;&gt; get_cfgstr_from_args(func, args, kwargs, key_argx, key_kwds, kwdefaults, argnames)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; self = ut.LazyList</span>
<span class="sd">        &gt;&gt;&gt; use_hash = None</span>
<span class="sd">        &gt;&gt;&gt; func = self.append</span>
<span class="sd">        &gt;&gt;&gt; args = (&#39;a&#39;, &#39;b&#39;)</span>
<span class="sd">        &gt;&gt;&gt; kwargs = {}</span>
<span class="sd">        &gt;&gt;&gt; key_argx = [1]</span>
<span class="sd">        &gt;&gt;&gt; key_kwds = []</span>
<span class="sd">        &gt;&gt;&gt; kwdefaults = ut.util_inspect.get_kwdefaults(func)</span>
<span class="sd">        &gt;&gt;&gt; argnames   = ut.util_inspect.get_argnames(func)</span>
<span class="sd">        &gt;&gt;&gt; get_cfgstr_from_args(func, args, kwargs, key_argx, key_kwds, kwdefaults, argnames)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># try:</span>
    <span class="c1"># fmt_str = &#39;%s(%s)&#39;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">hashstr_</span> <span class="o">=</span> <span class="n">util_hash</span><span class="o">.</span><span class="n">hashstr27</span>
    <span class="k">if</span> <span class="n">key_argx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key_argx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">key_kwds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key_kwds</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_ordered</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kwdefaults</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1"># def kwdval(key):</span>
    <span class="c1">#    return kwargs.get(key, kwdefaults.get(key, None))</span>
    <span class="n">given_kwargs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">merge_dicts</span><span class="p">(</span><span class="n">kwdefaults</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="n">arg_hashfmtstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">argnames</span><span class="p">[</span><span class="n">argx</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;=(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">argx</span> <span class="ow">in</span> <span class="n">key_argx</span><span class="p">]</span>
    <span class="c1"># kw_hashfmtstr = [kwdefaults.get(key, &#39;???&#39;) + &#39;(%s)&#39; for key in key_kwds]</span>
    <span class="n">kw_hashfmtstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;=(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_kwds</span><span class="p">]</span>
    <span class="n">cfgstr_fmt</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">arg_hashfmtstr</span><span class="p">,</span> <span class="n">kw_hashfmtstr</span><span class="p">))</span>
    <span class="c1"># print(&#39;cfgstr_fmt = %r&#39; % cfgstr_fmt)</span>
    <span class="n">argrepr_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">cachestr_repr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">argx</span><span class="p">])</span> <span class="k">for</span> <span class="n">argx</span> <span class="ow">in</span> <span class="n">key_argx</span><span class="p">)</span>
    <span class="n">kwdrepr_iter</span> <span class="o">=</span> <span class="p">(</span><span class="n">cachestr_repr</span><span class="p">(</span><span class="n">given_kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_kwds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># print(&#39;conditional hashing args&#39;)</span>
        <span class="n">argcfg_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">hashstr_</span><span class="p">(</span><span class="n">argrepr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argrepr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="k">else</span> <span class="n">argrepr</span>
            <span class="k">for</span> <span class="n">argrepr</span> <span class="ow">in</span> <span class="n">argrepr_iter</span>
        <span class="p">]</span>
        <span class="n">kwdcfg_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">hashstr_</span><span class="p">(</span><span class="n">kwdrepr</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwdrepr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="k">else</span> <span class="n">kwdrepr</span>
            <span class="k">for</span> <span class="n">kwdrepr</span> <span class="ow">in</span> <span class="n">kwdrepr_iter</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">use_hash</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># print(&#39;hashing args&#39;)</span>
        <span class="n">argcfg_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">hashstr_</span><span class="p">(</span><span class="n">argrepr</span><span class="p">)</span> <span class="k">for</span> <span class="n">argrepr</span> <span class="ow">in</span> <span class="n">argrepr_iter</span><span class="p">]</span>
        <span class="n">kwdcfg_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">hashstr_</span><span class="p">(</span><span class="n">kwdrepr</span><span class="p">)</span> <span class="k">for</span> <span class="n">kwdrepr</span> <span class="ow">in</span> <span class="n">kwdrepr_iter</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">argcfg_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">argrepr_iter</span><span class="p">)</span>
        <span class="n">kwdcfg_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwdrepr_iter</span><span class="p">)</span>
    <span class="c1"># print(&#39;formating args and kwargs&#39;)</span>
    <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">cfgstr_fmt</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">argcfg_list</span><span class="p">,</span> <span class="n">kwdcfg_list</span><span class="p">))</span>
    <span class="c1"># print(&#39;made cfgstr = %r&#39; % cfgstr)</span>
    <span class="k">return</span> <span class="n">cfgstr</span></div>


<div class="viewcode-block" id="cached_func"><a class="viewcode-back" href="../../utool.html#utool.util_cache.cached_func">[docs]</a><span class="k">def</span> <span class="nf">cached_func</span><span class="p">(</span>
    <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;utool&#39;</span><span class="p">,</span>
    <span class="n">key_argx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">key_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps a function with a Cacher object</span>

<span class="sd">    uses a hash of arguments as input</span>

<span class="sd">    Args:</span>
<span class="sd">        fname (str):  file name (defaults to function name)</span>
<span class="sd">        cache_dir (unicode): (default = u&#39;default&#39;)</span>
<span class="sd">        appname (unicode): (default = u&#39;utool&#39;)</span>
<span class="sd">        key_argx (None): (default = None)</span>
<span class="sd">        key_kwds (None): (default = None)</span>
<span class="sd">        use_cache (bool):  turns on disk based caching(default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --exec-cached_func</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; def costly_func(a, b, c=&#39;d&#39;, *args, **kwargs):</span>
<span class="sd">        ...     return ([a] * b, c, args, kwargs)</span>
<span class="sd">        &gt;&gt;&gt; ans0 = costly_func(41, 3)</span>
<span class="sd">        &gt;&gt;&gt; ans1 = costly_func(42, 3)</span>
<span class="sd">        &gt;&gt;&gt; closure_ = ut.cached_func(&#39;costly_func&#39;, appname=&#39;utool_test&#39;,</span>
<span class="sd">        &gt;&gt;&gt;                           key_argx=[0, 1])</span>
<span class="sd">        &gt;&gt;&gt; efficient_func = closure_(costly_func)</span>
<span class="sd">        &gt;&gt;&gt; ans2 = efficient_func(42, 3)</span>
<span class="sd">        &gt;&gt;&gt; ans3 = efficient_func(42, 3)</span>
<span class="sd">        &gt;&gt;&gt; ans4 = efficient_func(41, 3)</span>
<span class="sd">        &gt;&gt;&gt; ans5 = efficient_func(41, 3)</span>
<span class="sd">        &gt;&gt;&gt; assert ans1 == ans2</span>
<span class="sd">        &gt;&gt;&gt; assert ans2 == ans3</span>
<span class="sd">        &gt;&gt;&gt; assert ans5 == ans4</span>
<span class="sd">        &gt;&gt;&gt; assert ans5 == ans0</span>
<span class="sd">        &gt;&gt;&gt; assert ans1 != ans0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">VERBOSE_CACHE</span>

    <span class="k">def</span> <span class="nf">cached_closure</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_decor</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="n">fname_</span> <span class="o">=</span> <span class="n">util_inspect</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
        <span class="n">kwdefaults</span> <span class="o">=</span> <span class="n">util_inspect</span><span class="o">.</span><span class="n">get_kwdefaults</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">argnames</span> <span class="o">=</span> <span class="n">util_inspect</span><span class="o">.</span><span class="n">get_argnames</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_method</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="c1"># ignore self for methods</span>
            <span class="n">argnames</span> <span class="o">=</span> <span class="n">argnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">cacher</span> <span class="o">=</span> <span class="n">Cacher</span><span class="p">(</span><span class="n">fname_</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">appname</span><span class="o">=</span><span class="n">appname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_cache_</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--nocache-&#39;</span> <span class="o">+</span> <span class="n">fname_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_cache_</span> <span class="o">=</span> <span class="n">use_cache</span>
        <span class="c1"># _dbgdict = dict(fname_=fname_, key_kwds=key_kwds, appname=appname,</span>
        <span class="c1">#                key_argx=key_argx, use_cache_=use_cache_)</span>

        <span class="c1"># @functools.wraps(func)</span>
        <span class="k">def</span> <span class="nf">cached_wraper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Cached Wrapper Function</span>

<span class="sd">            Additional Kwargs:</span>
<span class="sd">                use_cache (bool) : enables cache</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_cache] computing cached function fname_=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname_</span><span class="p">,))</span>
                <span class="c1"># Implicitly adds use_cache to kwargs</span>
                <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">get_cfgstr_from_args</span><span class="p">(</span>
                    <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">key_argx</span><span class="p">,</span> <span class="n">key_kwds</span><span class="p">,</span> <span class="n">kwdefaults</span><span class="p">,</span> <span class="n">argnames</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">util_cplat</span><span class="o">.</span><span class="n">WIN32</span><span class="p">:</span>
                    <span class="c1"># remove potentially invalid chars</span>
                    <span class="n">cfgstr</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">util_hash</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">cfgstr</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;cfgstr=</span><span class="si">%r</span><span class="s1"> cannot be None&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cfgstr</span><span class="p">,)</span>
                <span class="n">use_cache__</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;use_cache&#39;</span><span class="p">,</span> <span class="n">use_cache_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">use_cache__</span><span class="p">:</span>
                    <span class="c1"># Make cfgstr from specified input</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">cacher</span><span class="o">.</span><span class="n">tryload</span><span class="p">(</span><span class="n">cfgstr</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">data</span>
                <span class="c1"># Cached missed compute function</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Cache save</span>
                <span class="c1"># if use_cache__:</span>
                <span class="c1"># TODO: save_cache</span>
                <span class="n">cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cfgstr</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="c1"># except ValueError as ex:</span>
            <span class="c1"># handle protocal error</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dbg</span>

                <span class="n">_dbgdict2</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">key_argx</span><span class="o">=</span><span class="n">key_argx</span><span class="p">,</span> <span class="n">lenargs</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">lenkw</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;+--- UTOOL --- ERROR IN CACHED FUNCTION&#39;</span><span class="p">,</span>
                        <span class="c1">#&#39;dbgdict = &#39; + utool.repr4(_dbgdict),</span>
                        <span class="s1">&#39;dbgdict2 = &#39;</span> <span class="o">+</span> <span class="n">util_str</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">_dbgdict2</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">util_dbg</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="c1"># Give function a handle to the cacher object</span>
        <span class="n">cached_wraper</span> <span class="o">=</span> <span class="n">util_decor</span><span class="o">.</span><span class="n">preserve_sig</span><span class="p">(</span><span class="n">cached_wraper</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">cached_wraper</span><span class="o">.</span><span class="n">cacher</span> <span class="o">=</span> <span class="n">cacher</span>
        <span class="k">return</span> <span class="n">cached_wraper</span>

    <span class="k">return</span> <span class="n">cached_closure</span></div>


<span class="c1"># --- Global Cache ---</span>


<div class="viewcode-block" id="view_global_cache_dir"><a class="viewcode-back" href="../../utool.html#utool.util_cache.view_global_cache_dir">[docs]</a><span class="k">def</span> <span class="nf">view_global_cache_dir</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span>

    <span class="n">dir_</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_global_cache_dir</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="n">appname</span><span class="p">)</span>
    <span class="n">utool</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">dir_</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_global_cache_dir"><a class="viewcode-back" href="../../utool.html#utool.util_cache.get_global_cache_dir">[docs]</a><span class="k">def</span> <span class="nf">get_global_cache_dir</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns (usually) writable directory for an application cache&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">appname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">appname</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="n">appname</span> <span class="o">=</span> <span class="n">get_default_appname</span><span class="p">()</span>
    <span class="n">global_cache_dir</span> <span class="o">=</span> <span class="n">util_cplat</span><span class="o">.</span><span class="n">get_app_resource_dir</span><span class="p">(</span>
        <span class="n">appname</span><span class="p">,</span> <span class="n">meta_util_constants</span><span class="o">.</span><span class="n">global_cache_dname</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">ensure</span><span class="p">:</span>
        <span class="n">util_path</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">global_cache_dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">global_cache_dir</span></div>


<div class="viewcode-block" id="get_global_shelf_fpath"><a class="viewcode-back" href="../../utool.html#utool.util_cache.get_global_shelf_fpath">[docs]</a><span class="k">def</span> <span class="nf">get_global_shelf_fpath</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the filepath to the global shelf&quot;&quot;&quot;</span>
    <span class="n">global_cache_dir</span> <span class="o">=</span> <span class="n">get_global_cache_dir</span><span class="p">(</span><span class="n">appname</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="n">ensure</span><span class="p">)</span>
    <span class="n">shelf_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">global_cache_dir</span><span class="p">,</span> <span class="n">meta_util_constants</span><span class="o">.</span><span class="n">global_cache_fname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shelf_fpath</span></div>


<div class="viewcode-block" id="shelf_open"><a class="viewcode-back" href="../../utool.html#utool.util_cache.shelf_open">[docs]</a><span class="k">def</span> <span class="nf">shelf_open</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    allows for shelf to be used in with statements</span>

<span class="sd">    References:</span>
<span class="sd">        http://stackoverflow.com/questions/7489732/easiest-way-to-add-a-function-to-existing-class</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --test-shelf_open</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; # UNSTABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; fpath = ut.unixjoin(ut.ensure_app_resource_dir(&#39;utool&#39;), &#39;testshelf.shelf&#39;)</span>
<span class="sd">        &gt;&gt;&gt; with ut.shelf_open(fpath) as dict_:</span>
<span class="sd">        ...     print(ut.repr4(dict_))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">))</span></div>


<span class="c1"># class YAWShelf(object):</span>
<span class="c1">#    def __init__(self, shelf_fpath):</span>
<span class="c1">#        self.shelf_fpath = shelf_fpath</span>
<span class="c1">#        import shelve</span>
<span class="c1">#        self.shelf = shelve.open(shelf_fpath)</span>


<div class="viewcode-block" id="GlobalShelfContext"><a class="viewcode-back" href="../../utool.html#utool.util_cache.GlobalShelfContext">[docs]</a><span class="k">class</span> <span class="nc">GlobalShelfContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;older class. might need update&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appname</span> <span class="o">=</span> <span class="n">appname</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.shelf = get_global_shelf(self.appname)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">dbm</span>

            <span class="n">DBMError</span> <span class="o">=</span> <span class="n">dbm</span><span class="o">.</span><span class="n">error</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">DBMError</span> <span class="o">=</span> <span class="ne">OSError</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">shelf_fpath</span> <span class="o">=</span> <span class="n">get_global_shelf_fpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">appname</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] open: &#39;</span> <span class="o">+</span> <span class="n">shelf_fpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shelf_fpath</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DBMError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dbg</span>

            <span class="n">util_dbg</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                <span class="n">ex</span><span class="p">,</span>
                <span class="s1">&#39;Failed opening shelf_fpath due to bad version, remove and retry&#39;</span><span class="p">,</span>
                <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;shelf_fpath&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shelf_fpath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span> <span class="o">=</span> <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shelf_fpath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dbg</span>

            <span class="n">util_dbg</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Failed opening shelf_fpath&#39;</span><span class="p">,</span> <span class="n">key_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;shelf_fpath&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shelf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[cache] Error under GlobalShelfContext!: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># return a falsey value on error</span></div>
        <span class="c1"># close_global_shelf(self.appname)</span>


<div class="viewcode-block" id="global_cache_read"><a class="viewcode-back" href="../../utool.html#utool.util_cache.global_cache_read">[docs]</a><span class="k">def</span> <span class="nf">global_cache_read</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">GlobalShelfContext</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shelf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shelf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="global_cache_dump"><a class="viewcode-back" href="../../utool.html#utool.util_cache.global_cache_dump">[docs]</a><span class="k">def</span> <span class="nf">global_cache_dump</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="n">shelf_fpath</span> <span class="o">=</span> <span class="n">get_global_shelf_fpath</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shelf_fpath = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shelf_fpath</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">GlobalShelfContext</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">util_str</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">shelf</span><span class="p">))</span></div>


<div class="viewcode-block" id="global_cache_write"><a class="viewcode-back" href="../../utool.html#utool.util_cache.global_cache_write">[docs]</a><span class="k">def</span> <span class="nf">global_cache_write</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes cache files to a safe place in each operating system&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">GlobalShelfContext</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf</span><span class="p">:</span>
        <span class="n">shelf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>


<div class="viewcode-block" id="delete_global_cache"><a class="viewcode-back" href="../../utool.html#utool.util_cache.delete_global_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_global_cache</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads cache files to a safe place in each operating system&quot;&quot;&quot;</span>
    <span class="c1"># close_global_shelf(appname)</span>
    <span class="n">shelf_fpath</span> <span class="o">=</span> <span class="n">get_global_shelf_fpath</span><span class="p">(</span><span class="n">appname</span><span class="p">)</span>
    <span class="n">util_path</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="n">shelf_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<span class="c1"># import abc  # abstract base class</span>
<span class="c1"># import six</span>


<span class="c1"># @six.add_metaclass(abc.ABCMeta)</span>
<div class="viewcode-block" id="Cachable"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable">[docs]</a><span class="k">class</span> <span class="nc">Cachable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class.</span>

<span class="sd">    This class which enables easy caching of object dictionarys</span>

<span class="sd">    must implement get_cfgstr()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.cPkl&#39;</span>  <span class="c1"># TODO: Capt&#39;n Proto backend to replace pickle backend</span>

    <span class="c1"># @abc.abstractmethod</span>
<div class="viewcode-block" id="Cachable.get_cfgstr"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.get_cfgstr">[docs]</a>    <span class="k">def</span> <span class="nf">get_cfgstr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cfgstr&#39;</span><span class="p">,</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">)</span></div>
        <span class="c1"># return &#39;DEFAULT&#39;</span>
        <span class="c1"># raise NotImplementedError(&#39;abstract method&#39;)</span>

    <span class="c1"># @abc.abstractmethod</span>
<div class="viewcode-block" id="Cachable.get_prefix"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.get_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">get_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># import utool as ut</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span></div>
        <span class="c1"># return ut.get_funcname(self.__class__) + &#39;_&#39;</span>
        <span class="c1"># raise NotImplementedError(&#39;abstract method&#39;)</span>

<div class="viewcode-block" id="Cachable.get_cachedir"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.get_cachedir">[docs]</a>    <span class="k">def</span> <span class="nf">get_cachedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cachedir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cachedir&#39;</span><span class="p">):</span>
                <span class="n">cachedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cachedir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cachedir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">return</span> <span class="n">cachedir</span></div>

<div class="viewcode-block" id="Cachable.get_fname"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.get_fname">[docs]</a>    <span class="k">def</span> <span class="nf">get_fname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># convinience</span>
        <span class="k">return</span> <span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cachable.get_fpath"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.get_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore:</span>
<span class="sd">            fname = _fname</span>
<span class="sd">            cfgstr = _cfgstr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_dpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="n">_fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefix</span><span class="p">()</span>
        <span class="n">_cfgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()</span> <span class="k">if</span> <span class="n">cfgstr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cfgstr</span>
        <span class="n">_ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="k">if</span> <span class="n">ext</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ext</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">_args2_fpath</span><span class="p">(</span><span class="n">_dpath</span><span class="p">,</span> <span class="n">_fname</span><span class="p">,</span> <span class="n">_cfgstr</span><span class="p">,</span> <span class="n">_ext</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="Cachable.delete"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="ow">or</span> <span class="n">VERBOSE</span> <span class="ow">or</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">VERBOSE</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        saves query result to directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Cachable] cache delete: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">),))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cachable.save"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.save">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        saves query result to directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Cachable] cache save: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">),))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__getstate__&#39;</span><span class="p">):</span>
            <span class="n">statedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">statedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

        <span class="k">if</span> <span class="n">ignore_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_dict</span> <span class="o">=</span> <span class="n">statedict</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">statedict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_keys</span>
            <span class="p">}</span>

        <span class="n">util_io</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">save_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>
        <span class="c1"># save_cache(cachedir, &#39;&#39;, cfgstr, self.__dict__)</span>
        <span class="c1"># with open(fpath, &#39;wb&#39;) as file_:</span>
        <span class="c1">#    pickle.dump(self.__dict__, file_)</span>

    <span class="k">def</span> <span class="nf">_unsafe_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">loaded_dict</span> <span class="o">=</span> <span class="n">util_io</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ignore_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">loaded_dict</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">loaded_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__setstate__&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">loaded_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loaded_dict</span><span class="p">)</span>
        <span class="c1"># with open(fpath, &#39;rb&#39;) as file_:</span>
        <span class="c1">#    loaded_dict = pickle.load(file_)</span>
        <span class="c1">#    self.__dict__.update(loaded_dict)</span>

<div class="viewcode-block" id="Cachable.glob_valid_targets"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.glob_valid_targets">[docs]</a>    <span class="k">def</span> <span class="nf">glob_valid_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">partial_cfgstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_path</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefix</span><span class="p">()</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">partial_cfgstr</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span>
        <span class="n">cachedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
        <span class="n">valid_targets</span> <span class="o">=</span> <span class="n">util_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_targets</span></div>

<div class="viewcode-block" id="Cachable.fuzzyload"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.fuzzyload">[docs]</a>    <span class="k">def</span> <span class="nf">fuzzyload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">partial_cfgstr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try and load from a partially specified configuration string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glob_valid_targets</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">partial_cfgstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;need to further specify target. valid_targets=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">valid_targets</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">valid_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cachable.load"><a class="viewcode-back" href="../../utool.html#utool.util_cache.Cachable.load">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cachedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cfgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">quiet</span><span class="o">=</span><span class="n">QUIET</span><span class="p">,</span>
        <span class="n">ignore_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the result from the given database</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">VERBOSE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fpath</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[Cachable] cache tryload: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">),))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unsafe_load</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... self cache hit: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">),))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[!Cachable] Cachable(</span><span class="si">%s</span><span class="s1">) is likely corrupt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CORRUPT fpath = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,))</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="c1"># except BadZipFile as ex:</span>
        <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[!Cachable] Cachable(</span><span class="si">%s</span><span class="s1">) has bad zipfile&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CORRUPT fpath = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,))</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>
            <span class="c1"># if exists(fpath):</span>
            <span class="c1">#    #print(&#39;[Cachable] Removing corrupted file: %r&#39; % fpath)</span>
            <span class="c1">#    #os.remove(fpath)</span>
            <span class="c1">#    raise hsexcept.HotsNeedsRecomputeError(msg)</span>
            <span class="c1"># else:</span>
            <span class="c1">#    raise Exception(msg)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;... self cache miss: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">),)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CORRUPT fpath = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[!Cachable] Cachable(</span><span class="si">%s</span><span class="s1">) is corrupt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">())</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;unknown exception while loading query result&#39;</span><span class="p">)</span>
            <span class="k">raise</span></div></div>


<div class="viewcode-block" id="get_lru_cache"><a class="viewcode-back" href="../../utool.html#utool.util_cache.get_lru_cache">[docs]</a><span class="k">def</span> <span class="nf">get_lru_cache</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        max_size (int):</span>

<span class="sd">    References:</span>
<span class="sd">        https://github.com/amitdev/lru-dict</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --test-get_lru_cache</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; # UNSTABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; max_size = 5</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; cache_obj = get_lru_cache(max_size)</span>
<span class="sd">        &gt;&gt;&gt; cache_obj[1] = 1</span>
<span class="sd">        &gt;&gt;&gt; cache_obj[2] = 2</span>
<span class="sd">        &gt;&gt;&gt; cache_obj[3] = 3</span>
<span class="sd">        &gt;&gt;&gt; cache_obj[4] = 4</span>
<span class="sd">        &gt;&gt;&gt; cache_obj[5] = 5</span>
<span class="sd">        &gt;&gt;&gt; cache_obj[6] = 6</span>
<span class="sd">        &gt;&gt;&gt; # verify results</span>
<span class="sd">        &gt;&gt;&gt; result = ut.repr2(dict(cache_obj), nl=False)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        {2: 2, 3: 3, 4: 4, 5: 5, 6: 6}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">USE_C_LRU</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">USE_C_LRU</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">lru</span>

        <span class="n">cache_obj</span> <span class="o">=</span> <span class="n">lru</span><span class="o">.</span><span class="n">LRU</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cache_obj</span> <span class="o">=</span> <span class="n">LRUDict</span><span class="p">(</span><span class="n">max_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cache_obj</span></div>


<div class="viewcode-block" id="LRUDict"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict">[docs]</a><span class="k">class</span> <span class="nc">LRUDict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pure python implementation for lru cache fallback</span>

<span class="sd">    References:</span>
<span class="sd">        http://www.kunxi.org/blog/2014/05/lru-cache-in-python/</span>

<span class="sd">    Args:</span>
<span class="sd">        max_size (int): (default = 5)</span>

<span class="sd">    Returns:</span>
<span class="sd">        LRUDict: cache_obj</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --test-LRUDict</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; max_size = 5</span>
<span class="sd">        &gt;&gt;&gt; self = LRUDict(max_size)</span>
<span class="sd">        &gt;&gt;&gt; for count in range(0, 5):</span>
<span class="sd">        ...     self[count] = count</span>
<span class="sd">        &gt;&gt;&gt; print(self)</span>
<span class="sd">        &gt;&gt;&gt; self[0]</span>
<span class="sd">        &gt;&gt;&gt; for count in range(5, 8):</span>
<span class="sd">        ...     self[count] = count</span>
<span class="sd">        &gt;&gt;&gt; print(self)</span>
<span class="sd">        &gt;&gt;&gt; del self[5]</span>
<span class="sd">        &gt;&gt;&gt; assert 4 in self</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;self = %r&#39; % (self,))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        self = LRUDict({</span>
<span class="sd">            4: 4,</span>
<span class="sd">            0: 0,</span>
<span class="sd">            6: 6,</span>
<span class="sd">            7: 7,</span>
<span class="sd">        })</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span> <span class="o">=</span> <span class="n">max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

<div class="viewcode-block" id="LRUDict.has_key"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.has_key">[docs]</a>    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="k">return</span> <span class="s1">&#39;LRUDict(&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="c1"># return repr(self._cache)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>

<div class="viewcode-block" id="LRUDict.items"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>

<div class="viewcode-block" id="LRUDict.keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="LRUDict.values"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

<div class="viewcode-block" id="LRUDict.iteritems"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span></div>

<div class="viewcode-block" id="LRUDict.iterkeys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.iterkeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span></div>

<div class="viewcode-block" id="LRUDict.itervalues"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.itervalues">[docs]</a>    <span class="k">def</span> <span class="nf">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span></div>

<div class="viewcode-block" id="LRUDict.clear"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LRUDict.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="time_different_diskstores"><a class="viewcode-back" href="../../utool.html#utool.util_cache.time_different_diskstores">[docs]</a><span class="k">def</span> <span class="nf">time_different_diskstores</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    %timeit shelf_write_test()    # 15.1 ms per loop</span>
<span class="sd">    %timeit cPickle_write_test()  # 1.26 ms per loop</span>

<span class="sd">    %timeit shelf_read_test()     # 8.77 ms per loop</span>
<span class="sd">    %timeit cPickle_read_test()   # 2.4 ms per loop</span>
<span class="sd">    %timeit cPickle_read_test2()  # 2.35 ms per loop</span>

<span class="sd">    %timeit json_read_test()</span>
<span class="sd">    %timeit json_write_test()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
    <span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>

    <span class="n">shelf_path</span> <span class="o">=</span> <span class="s1">&#39;test.shelf&#39;</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="s1">&#39;test.json&#39;</span>
    <span class="n">cpkl_path</span> <span class="o">=</span> <span class="s1">&#39;test.pkl&#39;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">dict_</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)}</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cpkl_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">shelf_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shelf_write_test</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">shelf_open</span><span class="p">(</span><span class="n">shelf_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf_dict</span><span class="p">:</span>
            <span class="n">shelf_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shelf_read_test</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">shelf_open</span><span class="p">(</span><span class="n">shelf_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">shelf_dict</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">shelf_dict</span><span class="p">)}</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">json_write_test</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cPickle_write_test</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cpkl_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cPickle_read_test</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cpkl_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outfile</span><span class="p">))}</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">cPickle_read_test2</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cpkl_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">shelf_write_test</span><span class="p">()</span>
    <span class="n">shelf_read_test</span><span class="p">()</span>
    <span class="c1"># json_write_test()</span>
    <span class="c1"># json_read_test()</span>
    <span class="n">cPickle_write_test</span><span class="p">()</span>
    <span class="n">cPickle_read_test</span><span class="p">()</span>
    <span class="n">cPickle_read_test2</span><span class="p">()</span></div>


<div class="viewcode-block" id="KeyedDefaultDict"><a class="viewcode-back" href="../../utool.html#utool.util_cache.KeyedDefaultDict">[docs]</a><span class="k">class</span> <span class="nc">KeyedDefaultDict</span><span class="p">(</span><span class="n">util_dict</span><span class="o">.</span><span class="n">DictLike</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_func</span> <span class="o">=</span> <span class="n">default_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="KeyedDefaultDict.setitem"><a class="viewcode-back" href="../../utool.html#utool.util_cache.KeyedDefaultDict.setitem">[docs]</a>    <span class="k">def</span> <span class="nf">setitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="KeyedDefaultDict.getitem"><a class="viewcode-back" href="../../utool.html#utool.util_cache.KeyedDefaultDict.getitem">[docs]</a>    <span class="k">def</span> <span class="nf">getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_func</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="KeyedDefaultDict.keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.KeyedDefaultDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="KeyedDefaultDict.values"><a class="viewcode-back" href="../../utool.html#utool.util_cache.KeyedDefaultDict.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div></div>


<span class="c1"># @six.add_metaclass(util_class.ReloadingMetaclass)</span>
<div class="viewcode-block" id="LazyDict"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict">[docs]</a><span class="nd">@util_class</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">LazyDict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># class LazyDict(collections.Mapping):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hacky dictionary where values that are functions are counted as lazy</span>


<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_cache --exec-LazyDict</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_cache import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; self = ut.LazyDict()</span>
<span class="sd">        &gt;&gt;&gt; self[&#39;foo&#39;] = lambda: 5</span>
<span class="sd">        &gt;&gt;&gt; self[&#39;bar&#39;] = 4</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        &gt;&gt;&gt;     self[&#39;foo&#39;] = lambda: 9</span>
<span class="sd">        &gt;&gt;&gt;     assert False, &#39;should not be able to override computable functions&#39;</span>
<span class="sd">        &gt;&gt;&gt; except ValueError:</span>
<span class="sd">        &gt;&gt;&gt;     pass</span>
<span class="sd">        &gt;&gt;&gt; self[&#39;biz&#39;] = lambda: 9</span>
<span class="sd">        &gt;&gt;&gt; d = {}</span>
<span class="sd">        &gt;&gt;&gt; d.update(**self)</span>
<span class="sd">        &gt;&gt;&gt; self[&#39;spam&#39;] = lambda: &#39;eggs&#39;</span>
<span class="sd">        &gt;&gt;&gt; self.printinfo()</span>
<span class="sd">        &gt;&gt;&gt; print(self.tostring(is_eager=False))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">other</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">is_eager</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">reprkw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mutable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="c1"># Registered lazy evaluations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Computed results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infer_lazy_vals_hack</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_eager</span> <span class="o">=</span> <span class="n">is_eager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reprkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">is_eager</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutable</span> <span class="o">=</span> <span class="n">mutable</span>
        <span class="k">if</span> <span class="n">reprkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reprkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">reprkw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># --- direct interface</span>

<div class="viewcode-block" id="LazyDict.set_lazy_func"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.set_lazy_func">[docs]</a>    <span class="k">def</span> <span class="nf">set_lazy_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">util_type</span><span class="o">.</span><span class="n">is_funclike</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s1">&#39;func must be a callable&#39;</span>
        <span class="c1"># if key in self._stored_results:</span>
        <span class="c1">#    raise ValueError(</span>
        <span class="c1">#        (&#39;Cannot add new lazy function for key=%r&#39;</span>
        <span class="c1">#         &#39;that has been computed&#39;) % (key,))</span>
        <span class="c1"># if key in self._stored_results:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutable</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s1">&#39;Cannot overwrite lazy function for key=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span></div>

<div class="viewcode-block" id="LazyDict.setitem"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.setitem">[docs]</a>    <span class="k">def</span> <span class="nf">setitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># HACK, lazy funcs should all be registered</span>
        <span class="c1"># this should should always just set a value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutable</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s1">&#39;Cannot overwrite lazy function for key=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_lazy_vals_hack</span> <span class="ow">and</span> <span class="n">util_type</span><span class="o">.</span><span class="n">is_funclike</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="LazyDict.getitem"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.getitem">[docs]</a>    <span class="k">def</span> <span class="nf">getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">is_eager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_eager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_eager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_eager</span>
        <span class="k">if</span> <span class="n">is_eager</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eager_eval</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy_eval</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="LazyDict.nocache_eval"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.nocache_eval">[docs]</a>    <span class="k">def</span> <span class="nf">nocache_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;forces function evaluation&quot;&quot;&quot;</span>
        <span class="n">func_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">func_</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="LazyDict.eager_eval"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.eager_eval">[docs]</a>    <span class="k">def</span> <span class="nf">eager_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_cache] Evaluating key=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocache_eval</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="LazyDict.lazy_eval"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.lazy_eval">[docs]</a>    <span class="k">def</span> <span class="nf">lazy_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="LazyDict.clear_evaluated"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.clear_evaluated">[docs]</a>    <span class="k">def</span> <span class="nf">clear_evaluated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluated_keys</span><span class="p">()):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="LazyDict.clear_stored"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.clear_stored">[docs]</a>    <span class="k">def</span> <span class="nf">clear_stored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stored_keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="LazyDict.stored_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.stored_keys">[docs]</a>    <span class="k">def</span> <span class="nf">stored_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;keys whose vals that have been explicitly set or evaluated&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="LazyDict.reconstructable_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.reconstructable_keys">[docs]</a>    <span class="k">def</span> <span class="nf">reconstructable_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;only keys whose vals that have been set with a backup func&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="LazyDict.all_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.all_keys">[docs]</a>    <span class="k">def</span> <span class="nf">all_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stored_keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="LazyDict.unevaluated_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.unevaluated_keys">[docs]</a>    <span class="k">def</span> <span class="nf">unevaluated_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;keys whose vals can be constructed but have not been&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stored_keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="LazyDict.evaluated_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.evaluated_keys">[docs]</a>    <span class="k">def</span> <span class="nf">evaluated_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;only keys whose vals have been evaluated from a stored function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unevaluated_keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="LazyDict.nonreconstructable_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.nonreconstructable_keys">[docs]</a>    <span class="k">def</span> <span class="nf">nonreconstructable_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;only keys whose vals that have been explicitly set without a backup func&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_keys</span><span class="p">())</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="LazyDict.cached_keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.cached_keys">[docs]</a>    <span class="k">def</span> <span class="nf">cached_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;only keys whose vals that have been explicitly set without a backup func&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonreconstructable_keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluated_keys</span><span class="p">()))</span></div>

<div class="viewcode-block" id="LazyDict.printinfo"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.printinfo">[docs]</a>    <span class="k">def</span> <span class="nf">printinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nonreconstructable_keys = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonreconstructable_keys</span><span class="p">(),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reconstructable_keys = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconstructable_keys</span><span class="p">(),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;evaluated_keys = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluated_keys</span><span class="p">(),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;unevaluated_keys = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unevaluated_keys</span><span class="p">(),))</span></div>

<div class="viewcode-block" id="LazyDict.asdict"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.asdict">[docs]</a>    <span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_eager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">is_eager</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">dict_</span></div>

<div class="viewcode-block" id="LazyDict.tostring"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.tostring">[docs]</a>    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_eager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="n">dict_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">is_eager</span><span class="o">=</span><span class="n">is_eager</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">AwakeFaceRepr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;!&#39;</span>
                <span class="c1"># return &#39;(o.o)&#39;</span>
                <span class="c1"># return &quot;٩(ˊᗜˋ*)و&quot;</span>

        <span class="k">class</span> <span class="nc">SleepFaceRepr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;z&#39;</span>
                <span class="c1"># return &#39;(-_-)&#39;</span>
                <span class="c1"># return &#39;(ᵕ≀ᵕ)&#39;</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluated_keys</span><span class="p">():</span>
            <span class="c1"># dict_[key] = &#39;!&#39;</span>
            <span class="n">dict_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">AwakeFaceRepr</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unevaluated_keys</span><span class="p">():</span>
            <span class="c1"># dict_[key] = &#39;z&#39;</span>
            <span class="n">dict_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">SleepFaceRepr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">dict_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># --- dict interface</span>

<div class="viewcode-block" id="LazyDict.get"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;can only specify one default&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># assert len(d) == 0, &#39;no support for default yet&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_eager</span><span class="p">)</span></div>

<div class="viewcode-block" id="LazyDict.update"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="LazyDict.keys"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="LazyDict.values"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

<div class="viewcode-block" id="LazyDict.items"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyDict.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span></div>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_funcs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">reprkw</span><span class="p">)</span></div>

    <span class="c1"># def __getstate__(self):</span>
    <span class="c1">#    state_dict = self.asdict()</span>
    <span class="c1">#    return state_dict</span>

    <span class="c1"># def __setstate__(self, state_dict):</span>
    <span class="c1">#    self._stored_results.update(state_dict)</span>


<div class="viewcode-block" id="LazyList"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyList">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">util_class</span><span class="o">.</span><span class="n">ReloadingMetaclass</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LazyList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;very hacky list implemented as a dictionary&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hackstore</span> <span class="o">=</span> <span class="n">LazyDict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hackstore</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hackstore</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># raise ValueError(&#39;index=%r out of bounds&#39; % (index,))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;index=</span><span class="si">%r</span><span class="s1"> out of bounds or error computing lazy value.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,)</span>
            <span class="p">)</span>

<div class="viewcode-block" id="LazyList.append"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyList.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hackstore</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hackstore</span><span class="p">)]</span> <span class="o">=</span> <span class="n">item</span></div>

<div class="viewcode-block" id="LazyList.tolist"><a class="viewcode-back" href="../../utool.html#utool.util_cache.LazyList.tolist">[docs]</a>    <span class="k">def</span> <span class="nf">tolist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hackstore</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -c &quot;import utool, utool.util_cache; utool.doctest_funcs(utool.util_cache)&quot;</span>
<span class="sd">        python -m utool.util_cache</span>
<span class="sd">        python -m utool.util_cache --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">wbia-vtool</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../utool.html">utool package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../utool.html">utool</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>