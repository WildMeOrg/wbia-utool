
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>utool.util_tests &#8212; wbia-vtool 3.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for utool.util_tests</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Helpers for tests</span>

<span class="sd">This module contains a more sane reimplementation of doctest functionality.</span>
<span class="sd">(I.E.  asserts work and you don&#39;t have to worry about stdout mucking things up)</span>
<span class="sd">The code isn&#39;t super clean though due to time constriaints.  Many functions</span>
<span class="sd">probably belong elsewhere and the parsers need a big cleanup.</span>

<span class="sd">Notes:</span>
<span class="sd">    DEPRICATE THIS IN FAVOR OF pytest and xdoctest</span>

<span class="sd">TODO:</span>
<span class="sd">    report the line of the doctest in the file when reporting errors as well as</span>
<span class="sd">    the relative line</span>
<span class="sd">    restructure so there is a test collection step, a filtering step, and an</span>
<span class="sd">    execution step</span>
<span class="sd">    Fix finding tests when running with @profile</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_arg</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_time</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_inject</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dbg</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dev</span>
<span class="kn">from</span> <span class="nn">utool._internal.meta_util_six</span> <span class="kn">import</span> <span class="n">get_funcname</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">util_inject</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">VERBOSE_TEST</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_module_verbosity_flags</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">DEBUG_SRC</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--nodbgsrc&#39;</span><span class="p">)</span>
<span class="n">PRINT_SRC</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;--printsrc&#39;</span><span class="p">,</span> <span class="s1">&#39;--src&#39;</span><span class="p">,</span> <span class="s1">&#39;--show-src&#39;</span><span class="p">,</span> <span class="s1">&#39;--showsrc&#39;</span><span class="p">),</span>
    <span class="n">help_</span><span class="o">=</span><span class="s1">&#39;show docstring source when running tests&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">PRINT_FACE</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--printface&#39;</span><span class="p">,</span> <span class="s1">&#39;--face&#39;</span><span class="p">))</span>
<span class="n">BIGFACE</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--bigface&#39;</span><span class="p">)</span>
<span class="n">SYSEXIT_ON_FAIL</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;--sysexitonfail&#39;</span><span class="p">,</span> <span class="s1">&#39;--fastfail&#39;</span><span class="p">),</span>
    <span class="n">help_</span><span class="o">=</span><span class="s1">&#39;Force testing harness to exit on first test failure&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">VERBOSE_TIMER</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--no-time-tests&#39;</span><span class="p">)</span>
<span class="n">INDENT_TEST</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">ModuleDoctestTup</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;ModuleDoctestTup&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;enabled_testtup_list&#39;</span><span class="p">,</span> <span class="s1">&#39;frame_fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;all_testflags&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="TestTuple"><a class="viewcode-back" href="../../utool.html#utool.util_tests.TestTuple">[docs]</a><span class="k">class</span> <span class="nc">TestTuple</span><span class="p">(</span><span class="n">util_dev</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple container for test objects to replace old tuple format</span>
<span class="sd">    exec mode specifies if the test is being run as a script</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">num</span><span class="p">,</span>
        <span class="n">src</span><span class="p">,</span>
        <span class="n">want</span><span class="p">,</span>
        <span class="n">flag</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">frame_fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nametup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">test_namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shortname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>  <span class="c1"># function / class / testable name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>  <span class="c1"># doctest index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>  <span class="c1"># doctest src</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">want</span> <span class="o">=</span> <span class="n">want</span>  <span class="c1"># doctest required result (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>  <span class="c1"># doctest commandline flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">frame_fpath</span>  <span class="c1"># parent file fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>  <span class="c1"># flags if running as script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nametup</span> <span class="o">=</span> <span class="n">nametup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_namespace</span> <span class="o">=</span> <span class="n">test_namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortname</span> <span class="o">=</span> <span class="n">shortname</span>

        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># hack to parse tag from source</span>
            <span class="n">tagline</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tagline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">tagline</span> <span class="o">=</span> <span class="n">tagline</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">tagline</span> <span class="o">=</span> <span class="n">tagline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_DOCTEST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">tagline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Hack for namespaced name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nametup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">modname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_fpath</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">namespace_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_namespace</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_namespace</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modename</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace_levels</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exec_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;exec&#39;</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tagstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s1">&#39; &#39;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; /&#39;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="o">+</span> <span class="n">tagstr</span>
            <span class="o">+</span> <span class="s1">&#39; in &#39;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">modname</span>
        <span class="p">)</span></div>


<span class="n">HAPPY_FACE_BIG</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">               .-&quot;&quot;&quot;&quot;&quot;&quot;-.</span>
<span class="s1">             .&#39;          &#39;.</span>
<span class="s1">            /   O      O   \</span>
<span class="s1">           :                :</span>
<span class="s1">           |                |</span>
<span class="s1">           &#39;  ,          ,&#39; :</span>
<span class="s1">            \  &#39;-......-&#39;  /</span>
<span class="s1">             &#39;.          .&#39;</span>
<span class="s1">               &#39;-......-&#39;</span>
<span class="s1">                   &#39;&#39;&#39;</span>

<span class="n">SAD_FACE_BIG</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">               .-&quot;&quot;&quot;&quot;&quot;&quot;-.</span>
<span class="s1">             .&#39;          &#39;.</span>
<span class="s1">            /   O      O   \</span>
<span class="s1">           :           `    :</span>
<span class="s1">           |                |</span>
<span class="s1">           :    .------.    :</span>
<span class="s1">            \  &#39;        &#39;  /</span>
<span class="s1">             &#39;.          .&#39;</span>
<span class="s1">               &#39;-......-&#39;</span>
<span class="s1">                  &#39;&#39;&#39;</span>

<span class="n">HAPPY_FACE_SMALL</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">     .&quot;&quot;&quot;.</span>
<span class="s1">    | o o |</span>
<span class="s1">    | \_/ |</span>
<span class="s1">     &#39; = &#39;</span>
<span class="s1">    &#39;&#39;&#39;</span>

<span class="n">SAD_FACE_SMALL</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">     .&quot;&quot;&quot;.</span>
<span class="s1">    | . . |</span>
<span class="s1">    |  ~  |</span>
<span class="s1">     &#39; = &#39;</span>
<span class="s1">    &#39;&#39;&#39;</span>

<span class="k">if</span> <span class="n">BIGFACE</span><span class="p">:</span>
    <span class="n">HAPPY_FACE</span> <span class="o">=</span> <span class="n">HAPPY_FACE_BIG</span>
    <span class="n">SAD_FACE</span> <span class="o">=</span> <span class="n">SAD_FACE_BIG</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">HAPPY_FACE</span> <span class="o">=</span> <span class="n">HAPPY_FACE_SMALL</span>
    <span class="c1"># SAD_FACE = SAD_FACE_BIG</span>
    <span class="n">SAD_FACE</span> <span class="o">=</span> <span class="n">SAD_FACE_SMALL</span>


<div class="viewcode-block" id="get_package_testables"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_package_testables">[docs]</a><span class="k">def</span> <span class="nf">get_package_testables</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">tagkw</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    New command that should eventually be used intead of old stuff?</span>

<span class="sd">    Args:</span>
<span class="sd">        module_list (list): (default = None)</span>
<span class="sd">        test_flags (None): (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool get_package_testables --show --mod wbia</span>
<span class="sd">        python -m utool get_package_testables --show --mod utool --tags SCRIPT</span>
<span class="sd">        python -m utool get_package_testables --show --mod utool --tags ENABLE</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; has_any = ut.get_argval(&#39;--tags&#39;, type_=str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; module = ut.get_argval(&#39;--mod&#39;, default=&#39;utool&#39;)</span>
<span class="sd">        &gt;&gt;&gt; test_tuples = get_package_testables(module, has_any=has_any)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.repr3(test_tuples)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.repr3(ut.list_getattr(test_tuples, &#39;tags&#39;)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">modname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">package_contents</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">module_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">modname_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">modname</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">test_tuples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
        <span class="n">old_testables</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_module_doctest_tup</span><span class="p">(</span>
            <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">needs_enable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allexamples</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">test_tuples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">old_testables</span><span class="o">.</span><span class="n">enabled_testtup_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tagkw</span><span class="p">:</span>
        <span class="n">tags_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_getattr</span><span class="p">(</span><span class="n">test_tuples</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">tagkw</span><span class="p">)</span>
        <span class="n">test_tuples</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">test_tuples</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_tuples</span></div>


<div class="viewcode-block" id="doctest_module_list"><a class="viewcode-back" href="../../utool.html#utool.util_tests.doctest_module_list">[docs]</a><span class="k">def</span> <span class="nf">doctest_module_list</span><span class="p">(</span><span class="n">module_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs many module tests</span>

<span class="sd">    Entry point for batch run</span>
<span class="sd">    Depth 0)</span>

<span class="sd">    Ignore:</span>
<span class="sd">        :&#39;&lt;,&#39;&gt;!sort -n -k 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">nPass_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nTotal_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_cmds_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">error_reports_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] Running doctests on module list&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="s1">&#39;timeings.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"> --- begining doctest_module_list</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;[util_test] IOWarning&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">failed_doctest_fname</span> <span class="o">=</span> <span class="s1">&#39;failed_doctests.txt&#39;</span>
    <span class="n">seen_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">failed_doctest_fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-------</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(</span><span class="n">format_</span><span class="o">=</span><span class="s1">&#39;printable&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;logfile (only present if logging) = </span><span class="si">%r</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">util_logging</span><span class="o">.</span><span class="n">get_current_log_fpath</span><span class="p">(),)</span>
        <span class="p">)</span>
        <span class="n">testkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">allexamples</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
                <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_list</span><span class="p">,</span> <span class="n">error_report_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">(</span>
                    <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">seen_</span><span class="o">=</span><span class="n">seen_</span><span class="p">,</span> <span class="o">**</span><span class="n">testkw</span>
                <span class="p">)</span>
                <span class="n">nPass_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nPass</span><span class="p">)</span>
                <span class="n">nTotal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nTotal</span><span class="p">)</span>
                <span class="n">failed_cmds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">failed_list</span><span class="p">)</span>
                <span class="n">error_reports_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">)</span>
                <span class="c1"># Write failed tests to disk</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">failed_list</span><span class="p">:</span>
                    <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ellapsed</span>
        <span class="n">nPass</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nPass_list</span><span class="p">)</span>
        <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nTotal_list</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PASSED </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">))</span>

    <span class="n">failed_cmd_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">failed_cmds_list</span><span class="p">)</span>
    <span class="n">error_report_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">error_reports_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Printing </span><span class="si">%d</span><span class="s1"> error reports&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">),))</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">error_report</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=== Error Report </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error_report</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--- Done printing error reports ----&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span>
            <span class="s1">&#39;timeings.txt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"> --- finished doctest_module_list total_time=</span><span class="si">%.3f</span><span class="s1">s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_time</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;[util_test] IOWarning&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+========&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| FINISHED TESTING </span><span class="si">%d</span><span class="s1"> MODULES&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">module_list</span><span class="p">),))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| PASSED </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L========&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_cmd_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAILED TESTS:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed_cmd_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_cmd_list</span></div>


<div class="viewcode-block" id="doctest_funcs"><a class="viewcode-back" href="../../utool.html#utool.util_tests.doctest_funcs">[docs]</a><span class="k">def</span> <span class="nf">doctest_funcs</span><span class="p">(</span>
    <span class="n">testable_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">check_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">allexamples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">needs_enable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_error_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">seen_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point into utools main module doctest harness</span>
<span class="sd">    Imports a module and checks flags for the function to run</span>
<span class="sd">    Depth 1)</span>

<span class="sd">    Args:</span>
<span class="sd">        testable_list (list):</span>
<span class="sd">        check_flags (bool): Force checking of the --test- and --exec- flags</span>
<span class="sd">        module (None):</span>
<span class="sd">        allexamples (None):</span>
<span class="sd">        needs_enable (None):</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (nPass, nTotal, failed_cmd_list)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia.algo.preproc.preproc_chip --all-examples</span>

<span class="sd">    References:</span>
<span class="sd">        http://legacy.python.org/dev/peps/pep-0338/</span>
<span class="sd">        https://docs.python.org/2/library/runpy.html</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; testable_list = []</span>
<span class="sd">        &gt;&gt;&gt; check_flags = True</span>
<span class="sd">        &gt;&gt;&gt; module = None</span>
<span class="sd">        &gt;&gt;&gt; allexamples = None</span>
<span class="sd">        &gt;&gt;&gt; needs_enable = None</span>
<span class="sd">        &gt;&gt;&gt; # careful might infinitely recurse</span>
<span class="sd">        &gt;&gt;&gt; (nPass, nTotal) = doctest_funcs(testable_list, check_flags, module,</span>
<span class="sd">        ...                                 allexamples, needs_enable)</span>
<span class="sd">        &gt;&gt;&gt; print((nPass, nTotal))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="c1"># ut.start_logging()</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># just in case</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] doctest_funcs&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">inject_colored_exceptions</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">VERBOSE_TEST</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test.doctest_funcs][DEPTH 1] doctest_funcs()&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test.doctest_funcs] Running doctest_funcs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">change_term_title</span><span class="p">(</span><span class="s1">&#39;DocTest &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>

    <span class="c1"># PARSE OUT TESTABLE DOCTESTTUPS</span>
    <span class="n">mod_doctest_tup</span> <span class="o">=</span> <span class="n">get_module_doctest_tup</span><span class="p">(</span>
        <span class="n">testable_list</span><span class="p">,</span>
        <span class="n">check_flags</span><span class="p">,</span>
        <span class="n">module</span><span class="p">,</span>
        <span class="n">allexamples</span><span class="p">,</span>
        <span class="n">needs_enable</span><span class="p">,</span>
        <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">,</span> <span class="n">all_testflags</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="n">mod_doctest_tup</span>

    <span class="n">nPass</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nFail</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">)</span>

    <span class="c1"># flags = [(tup.name, tup.num) in seen_ for tup in enabled_testtup_list]</span>
    <span class="k">if</span> <span class="n">seen_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="o">.</span><span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">]</span>
        <span class="n">enabled_testtup_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="c1"># Remove duplicate tests from previous parts of the batch run</span>
    <span class="c1"># print(sum(flags))</span>

    <span class="n">EARLYEXIT</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">seen_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">:</span>
            <span class="c1"># seen_.add((tup.name, tup.num))</span>
            <span class="n">seen_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tup</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">EARLYEXIT</span><span class="p">:</span>
        <span class="n">nPass</span> <span class="o">=</span> <span class="n">nTotal</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_error_report</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
    <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">)</span>

    <span class="c1"># Run enabled examles</span>
    <span class="n">failed_flag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">error_report_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--edit-test-file&#39;</span><span class="p">,</span> <span class="s1">&#39;--etf&#39;</span><span class="p">)):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">editfile</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
    <span class="n">exec_mode</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">testtup</span><span class="o">.</span><span class="n">exec_mode</span> <span class="k">for</span> <span class="n">testtup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">testtup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">name</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">num</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">src</span>
        <span class="n">want</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">want</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">flag</span>
        <span class="c1"># if ut.is_developer():</span>
        <span class="c1">#    ut.change_term_title(&#39;DocTest &#39; + modname + &#39; &#39; + name)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">modname</span><span class="o">=</span><span class="n">modname</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="c1">#      1          v12     v20       v30       v40       v50         v62</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+------------------------------------------------------------+&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*  DOCTEST </span><span class="si">{modname:&lt;20}</span><span class="s1"> </span><span class="si">{name:&gt;26}</span><span class="s1">:</span><span class="si">{num:d}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+------------------------------------------------------------+&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PRINT_SRC</span> <span class="ow">or</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">msgblock</span><span class="p">(</span><span class="s1">&#39;EXEC SRC&#39;</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;&gt;&gt;&gt;&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">msgblock</span><span class="p">(</span><span class="s1">&#39;EXEC SRC&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;&gt;&gt;&gt;&#39;</span><span class="p">))</span>
        <span class="c1"># Commented because it caused differences between</span>
        <span class="c1"># individual test runs and large test runs with ut</span>
        <span class="c1"># being imported</span>
        <span class="c1"># test_globals = module.__dict__.copy()</span>
        <span class="n">test_globals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">error_report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">testkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">globals</span><span class="o">=</span><span class="n">test_globals</span><span class="p">,</span> <span class="n">want</span><span class="o">=</span><span class="n">want</span><span class="p">)</span>  <span class="c1"># HACK</span>
            <span class="k">assert</span> <span class="n">testtup</span><span class="o">.</span><span class="n">frame_fpath</span> <span class="o">==</span> <span class="n">frame_fpath</span>
            <span class="n">test_locals</span><span class="p">,</span> <span class="n">error_report</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="n">testtup</span><span class="p">,</span> <span class="o">**</span><span class="n">testkw</span><span class="p">)</span>
            <span class="n">pass_flag</span> <span class="o">=</span> <span class="n">test_locals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">pass_flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;seems to pass&#39;</span><span class="p">)</span>
                <span class="n">nPass</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;raising failed exception&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;failed&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Seems to fail. &#39;</span><span class="p">)</span>
            <span class="n">nFail</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">failed_flag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">error_report_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_report</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">SUPER_STRICT</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;Silently Failing: &#39;</span>
                        <span class="s1">&#39;maybe adding the --super-strict flag would help debug?&#39;</span>
                    <span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] caught Ctrl+C&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L_____________________________________________________________&#39;</span><span class="p">)</span>
    <span class="c1"># L__________________</span>
    <span class="c1"># +-------------------</span>
    <span class="c1"># Print Results</span>
    <span class="k">if</span> <span class="n">nTotal</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allexamples</span><span class="p">:</span>
        <span class="n">valid_test_argflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--allexamples&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_testflags</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
        <span class="c1"># TODO: ensure that exename is in the PATH</span>
        <span class="n">exename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
                <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            [ut.doctest_funcs] No test flags specified</span>
<span class="sd">            Please choose one of the following flags or specify --enableall</span>
<span class="sd">            Valid test argflags:</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">valid_test_argflags</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> -m </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exename</span><span class="p">,</span> <span class="n">modname</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># warning_msg = ut.indent(warning_msg, &#39;[util_test.doctest_funcs]&#39;)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">exec_mode</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+-------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| finished testing fpath=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame_fpath</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| passed </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L-------&#39;</span><span class="p">)</span>
    <span class="n">failed_cmd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">nFail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># modname = module.__name__</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
        <span class="c1"># TODO: ensure that exename is in the PATH</span>
        <span class="n">exename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">failed_cmd_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> -m </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exename</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">flag_</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag_</span> <span class="ow">in</span> <span class="n">failed_flag_list</span>
        <span class="p">]</span>
        <span class="c1"># failed_cmd_list = [&#39;python %s %s&#39; % (frame_fpath, flag_)</span>
        <span class="c1">#                    for flag_ in failed_flag_list]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed sys.argv = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed Tests:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed_cmd_list</span><span class="p">))</span>
    <span class="c1"># L__________________</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">util_inject</span><span class="o">.</span><span class="n">PROFILING</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">dump_profile_text</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_error_report</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_cmd_list</span><span class="p">,</span> <span class="n">error_report_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_cmd_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_test"><a class="viewcode-back" href="../../utool.html#utool.util_tests.run_test">[docs]</a><span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">func_or_testtup</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the test function. Prints a success / failure report.</span>

<span class="sd">    Args:</span>
<span class="sd">        func_or_testtup (func or tuple): function or doctest tuple</span>
<span class="sd">        args*: args to be forwarded to `func_or_testtup`</span>
<span class="sd">        kwargs*: keyword args to be forwarded to `func_or_testtup`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="c1"># func_is_testtup = isinstance(func_or_testtup, tuple)</span>
    <span class="c1"># NOTE: isinstance might not work here if ut.rrrr has been called</span>
    <span class="n">func_is_testtup</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_or_testtup</span><span class="p">,</span> <span class="n">TestTuple</span><span class="p">)</span>
    <span class="n">exec_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dump_mode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">write_times</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">func_is_testtup</span><span class="p">:</span>
        <span class="n">testtup</span> <span class="o">=</span> <span class="n">func_or_testtup</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">src</span>
        <span class="n">funcname</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">name</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">frame_fpath</span>
        <span class="c1"># (funcname, src, frame_fpath) = func_or_testtup</span>
        <span class="n">exec_mode</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">exec_mode</span>
        <span class="n">dump_mode</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;dump&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func_</span> <span class="o">=</span> <span class="n">func_or_testtup</span>
        <span class="n">funcname</span> <span class="o">=</span> <span class="n">get_funcname</span><span class="p">(</span><span class="n">func_</span><span class="p">)</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcfpath</span><span class="p">(</span><span class="n">func_</span><span class="p">)</span>
    <span class="n">upper_funcname</span> <span class="o">=</span> <span class="n">funcname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=============================&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**[TEST.BEGIN] </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**[TEST.BEGIN] </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,))</span>

    <span class="n">verbose_timer</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">exec_mode</span> <span class="ow">and</span> <span class="n">VERBOSE_TIMER</span>
    <span class="n">nocheckwant</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">exec_mode</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">print_face</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">exec_mode</span> <span class="ow">and</span> <span class="n">PRINT_FACE</span>
    <span class="n">error_report</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">dump_mode</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;testtup = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testtup</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># RUN THE TEST WITH A TIMER</span>
        <span class="k">with</span> <span class="n">util_time</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">upper_funcname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_timer</span><span class="p">)</span> <span class="k">as</span> <span class="n">timer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func_is_testtup</span><span class="p">:</span>
                <span class="n">test_locals</span> <span class="o">=</span> <span class="n">_exec_doctest</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">nocheckwant</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TEST INPUT IS A LIVE PYTHON FUNCTION</span>
                <span class="n">test_locals</span> <span class="o">=</span> <span class="n">func_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="c1"># Get locals in the wrapped function</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">error_report_lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;**[TEST.ERROR] </span><span class="si">%s</span><span class="s1"> -- FAILED:</span><span class="se">\n</span><span class="s1">    type(ex)=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">error_report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">formatex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="n">error_report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">print_report</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=============================&#39;</span><span class="p">)</span>
        <span class="n">print_report</span><span class="p">(</span>
            <span class="s1">&#39;**[TEST.FINISH] </span><span class="si">%s</span><span class="s1"> -- FAILED:</span><span class="se">\n</span><span class="s1">    type(ex)=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">PRINT_FACE</span><span class="p">:</span>
            <span class="n">print_report</span><span class="p">(</span><span class="n">SAD_FACE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func_is_testtup</span><span class="p">:</span>
            <span class="n">print_report</span><span class="p">(</span><span class="s1">&#39;Failed in module: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">frame_fpath</span><span class="p">)</span>
            <span class="n">src_with_lineno</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">number_text_lines</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">print_report</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">msgblock</span><span class="p">(</span><span class="s1">&#39;FAILED DOCTEST IN </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,),</span> <span class="n">src_with_lineno</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">SUPER_STRICT</span><span class="p">:</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">func_is_testtup</span><span class="p">:</span>
                <span class="c1"># Remove this function from stack strace</span>
                <span class="c1"># dont do this for execed code</span>
                <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">exc_traceback</span><span class="o">.</span><span class="n">tb_next</span>
                <span class="k">pass</span>
            <span class="c1"># FIXME: make a _internal/py2_syntax_funcs version of this</span>
            <span class="c1"># function as well as a python3 syntax version due to the</span>
            <span class="c1"># reraise syntax issue to avoid an extra frame in the stack</span>
            <span class="n">six</span><span class="o">.</span><span class="n">reraise</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SYSEXIT_ON_FAIL</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] SYSEXIT_ON_FAIL = True&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] exiting with sys.exit(1)&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">EXIT_FAILURE</span><span class="p">)</span>
        <span class="c1"># raise</span>
        <span class="n">error_report</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error_report_lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_report</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># LOG PASSING TEST</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exec_mode</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=============================&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**[TEST.FINISH] </span><span class="si">%s</span><span class="s1"> -- SUCCESS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">print_face</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">HAPPY_FACE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_times</span><span class="p">:</span>
                <span class="n">timemsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">s in </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timer</span><span class="o">.</span><span class="n">ellapsed</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="s1">&#39;timeings.txt&#39;</span><span class="p">,</span> <span class="n">timemsg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;[util_test] IOWarning&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># RETURN VALID TEST LOCALS</span>
        <span class="k">return</span> <span class="n">test_locals</span><span class="p">,</span> <span class="n">error_report</span></div>


<span class="k">def</span> <span class="nf">_exec_doctest</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">nocheckwant</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper for run_test</span>

<span class="sd">    block of code that runs doctest and was too big to be in run_test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TEST INPUT IS PYTHON CODE TEXT</span>
    <span class="c1"># test_locals = {}</span>
    <span class="n">test_globals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;globals&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">want</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;want&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># test_globals[&#39;print&#39;] = doctest_print</span>
    <span class="c1"># EXEC FUNC</span>
    <span class="c1"># six.exec_(src, test_globals, test_locals)  # adds stack to debug trace</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="c1"># TODO RECTIFY WITH TF</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;--embed&#39;</span><span class="p">)):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">_cmd_modify_src</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># IN EXEC CONTEXT THERE IS NO DIFF BETWEEN LOCAL / GLOBALS.  ONLY PASS</span>
        <span class="c1"># IN ONE DICT. OTHERWISE TREATED ODDLY</span>
        <span class="c1"># References: https://bugs.python.org/issue13557</span>
        <span class="c1"># exec(code, test_globals, test_locals)</span>
        <span class="n">test_locals</span> <span class="o">=</span> <span class="n">test_globals</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">test_globals</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ExitTestException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test exited before show&#39;</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">nocheckwant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nocheckwant</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span>
            <span class="s1">&#39;--no-checkwant&#39;</span><span class="p">,</span> <span class="n">help_</span><span class="o">=</span><span class="s1">&#39;Turns off checking for results&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">nocheckwant</span> <span class="ow">or</span> <span class="n">want</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">want</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nocheckwant</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;warning test does not want anything&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">want</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">want</span> <span class="o">=</span> <span class="n">want</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">test_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;NO VARIABLE NAMED result&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">want</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_str</span>

            <span class="n">msglines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Even if they arent exactly the same, the difference might just be</span>
            <span class="c1"># some whitespace characters. Ignore in this case.</span>
            <span class="n">difftext</span> <span class="o">=</span> <span class="n">util_str</span><span class="o">.</span><span class="n">get_textdiff</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ignore_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">difftext</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">util_dbg</span><span class="o">.</span><span class="n">COLORED_EXCEPTIONS</span><span class="p">:</span>
                    <span class="n">difftext</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">color_diff_text</span><span class="p">(</span><span class="n">difftext</span><span class="p">)</span>
                <span class="n">msglines</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s1">&#39;DIFF/GOT/EXPECTED&#39;</span><span class="p">,</span>
                    <span class="n">difftext</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="n">msglines</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="s1">&#39;REPR_GOT: result=&#39;</span><span class="p">,</span>
                        <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                        <span class="s1">&#39;REPR_EXPECTED: want=&#39;</span><span class="p">,</span>
                        <span class="nb">repr</span><span class="p">(</span><span class="n">want</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="n">msglines</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s1">&#39;STR_GOT: result=&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">),</span>
                    <span class="s1">&#39;STR_EXPECTED: want=&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">want</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="n">errmsg1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msglines</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;result != want</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">errmsg1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_locals</span>


<div class="viewcode-block" id="get_module_testlines"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_module_testlines">[docs]</a><span class="k">def</span> <span class="nf">get_module_testlines</span><span class="p">(</span><span class="n">module_list</span><span class="p">,</span> <span class="n">remove_pyc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pythoncmd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds test commands for autogen tests</span>
<span class="sd">    called by autogen test scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="k">if</span> <span class="n">pythoncmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pythoncmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
        <span class="c1">#&#39;python&#39;</span>
    <span class="n">testcmd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
        <span class="n">mod_doctest_tup</span> <span class="o">=</span> <span class="n">get_module_doctest_tup</span><span class="p">(</span>
            <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">allexamples</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">,</span> <span class="n">all_testflags</span><span class="p">,</span> <span class="n">module_</span><span class="p">)</span> <span class="o">=</span> <span class="n">mod_doctest_tup</span>
        <span class="k">for</span> <span class="n">testtup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">:</span>
            <span class="c1"># testflag = testtup[-1]</span>
            <span class="n">testflag</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">flag</span>
            <span class="k">if</span> <span class="n">remove_pyc</span><span class="p">:</span>
                <span class="c1"># FIXME python 3 __pycache__/*.pyc</span>
                <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">frame_fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.pyc&#39;</span><span class="p">,</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
            <span class="n">frame_rel_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_relative_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
            <span class="n">testcmd</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">pythoncmd</span><span class="p">,</span> <span class="n">frame_rel_fpath</span><span class="p">,</span> <span class="n">testflag</span><span class="p">))</span>
            <span class="n">testcmd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testcmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">testcmd_list</span></div>


<span class="k">def</span> <span class="nf">_docblock_tester1</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;testting docblocks</span>
<span class="sd">        foo</span>
<span class="sd">    # Depth 5)</span>
<span class="sd">    call:</span>
<span class="sd">        foo</span>
<span class="sd">    the next call is:</span>
<span class="sd">        bar</span>
<span class="sd">    called by parse_doctest_from_docstr</span>
<span class="sd">    TODO: move to util_inspect</span>
<span class="sd">        test what happens with weird indentation</span>
<span class="sd">    bla</span>

<span class="sd">    Args:</span>
<span class="sd">        docstr (str): a documentation string formatted in google style.</span>
<span class="sd">            Remember indentation matters.</span>
<span class="sd">              whoo</span>
<span class="sd">            this</span>
<span class="sd">              .. params</span>
<span class="sd">        new (Optional[bool]): does a new style of parsing</span>
<span class="sd">        **kwargs:</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: docstr_blocks tuples</span>
<span class="sd">            [(blockname, blockstr, offset)]</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;example1&#39;)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;dummy&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_docblock_tester2</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">    Returns:</span>
<span class="sd">    Example:</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_docblock_tester3</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    foo</span>
<span class="sd">    Args:</span>

<span class="sd">    Returns:</span>

<span class="sd">    Example:</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_docblock_tester4</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;foobar</span>

<span class="sd">    Args:</span>
<span class="sd">        *args:</span>
<span class="sd">        **kwargs:</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_test_docblock_parser</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">basis</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_args&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;n_return&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="s1">&#39;spacing&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="c1"># &#39;example_lines&#39;: [0, 1, 2],</span>
        <span class="s1">&#39;doc_lines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="s1">&#39;doc_indent&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">all_dict_combinations</span><span class="p">(</span><span class="n">basis</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=====&#39;</span><span class="p">)</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">_make_test_docstr</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">docparts</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">parse_docblocks_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=====&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_args&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="s1">&#39;Args:&#39;</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">docparts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_return&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="s1">&#39;Returns:&#39;</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">docparts</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_test_docstr</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">docpart</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lorium_ipsum</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;doc_lines&#39;</span><span class="p">]])</span>
    <span class="n">docpart</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;doc_indent&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">docpart</span>
    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">docpart</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_args&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">argheader</span> <span class="o">=</span> <span class="s1">&#39;Args&#39;</span>
        <span class="n">argname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">chr_range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_args&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">argtype_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bool&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_args&#39;</span><span class="p">]</span>
        <span class="n">argdesc_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_args&#39;</span><span class="p">]</span>
        <span class="n">arg_docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_args_docstr</span><span class="p">(</span>
            <span class="n">argname_list</span><span class="p">,</span> <span class="n">argtype_list</span><span class="p">,</span> <span class="n">argdesc_list</span><span class="p">,</span> <span class="n">ismethod</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">argsblock</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_docstr_block</span><span class="p">(</span><span class="n">argheader</span><span class="p">,</span> <span class="n">arg_docstr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">argsblock</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_return&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_return&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">returnblock</span> <span class="o">=</span> <span class="s1">&#39;Returns:&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_name</span> <span class="o">=</span> <span class="s1">&#39;outvar&#39;</span>
            <span class="n">return_type</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>
            <span class="n">return_desc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">lorium_ipsum</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;n_return&#39;</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="n">return_doctr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_returns_or_yeilds_docstr</span><span class="p">(</span>
                <span class="n">return_type</span><span class="p">,</span> <span class="n">return_name</span><span class="p">,</span> <span class="n">return_desc</span>
            <span class="p">)</span>
            <span class="n">returnblock</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">make_docstr_block</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">,</span> <span class="n">return_doctr</span><span class="p">)</span>
        <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">returnblock</span><span class="p">)</span>

    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argsblock</span><span class="p">)</span>

    <span class="n">docstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;spacing&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">docstr</span>


<div class="viewcode-block" id="parse_docblocks_from_docstr"><a class="viewcode-back" href="../../utool.html#utool.util_tests.parse_docblocks_from_docstr">[docs]</a><span class="k">def</span> <span class="nf">parse_docblocks_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Depth 5)</span>
<span class="sd">    called by parse_doctest_from_docstr</span>

<span class="sd">    TODO: move to util_inspect</span>

<span class="sd">    Args:</span>
<span class="sd">        docstr (str): a documentation string formatted in google style.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: docstr_blocks tuples</span>
<span class="sd">            [(blockname, blockstr)]</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests parse_docblocks_from_docstr</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; #func_or_class = ut.flatten2</span>
<span class="sd">        &gt;&gt;&gt; #func_or_class = ut.list_depth</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.iter_module_doctestable</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.all_multi_paths</span>
<span class="sd">        &gt;&gt;&gt; docstr = ut.get_docstr(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; docstr_blocks = parse_docblocks_from_docstr(docstr)</span>
<span class="sd">        &gt;&gt;&gt; result = str(ut.repr4(docstr_blocks))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># import parse</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="c1"># import itertools as it</span>
    <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_unicode</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
    <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>

    <span class="c1"># Parse out initial documentation lines</span>
    <span class="c1"># Then parse out the blocked lines.</span>
    <span class="n">docstr_lines</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">line_indent</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_indentation</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">docstr_lines</span><span class="p">]</span>
    <span class="n">line_len</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">docstr_lines</span><span class="p">]</span>

    <span class="c1"># The first line may not have the correct indentation if it starts</span>
    <span class="c1"># right after the triple quotes. Adjust it in this case to ensure that</span>
    <span class="c1"># base indent is always 0</span>
    <span class="n">adjusted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_nonzero</span> <span class="o">=</span> <span class="p">[</span><span class="n">len_</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">len_</span> <span class="ow">in</span> <span class="n">line_len</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_indent</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indents</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">line_indent</span><span class="p">,</span> <span class="n">is_nonzero</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indents</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">indent_adjust</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">indents</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">line_indent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">indent_adjust</span>
                <span class="n">line_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">indent_adjust</span>
                <span class="n">docstr_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent_adjust</span><span class="p">)</span> <span class="o">+</span> <span class="n">docstr_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">adjusted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">adjusted</span><span class="p">:</span>
        <span class="c1"># Redo prepreocessing, but this time on a rectified input</span>
        <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr_lines</span><span class="p">))</span>
        <span class="n">docstr_lines</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">line_indent</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_indentation</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">docstr_lines</span><span class="p">]</span>
        <span class="n">line_len</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">docstr_lines</span><span class="p">]</span>

    <span class="n">indents</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">line_indent</span><span class="p">,</span> <span class="n">is_nonzero</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indents</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">indents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR IN PARSING&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adjusted = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">adjusted</span><span class="p">,))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Google Style Docstring Missformat&#39;</span><span class="p">)</span>

    <span class="n">base_indent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># We will group lines by their indentation.</span>
    <span class="c1"># Rectify empty lines by giving them their parent&#39;s indentation.</span>
    <span class="n">true_indent</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prev_indent</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">indent_</span><span class="p">,</span> <span class="n">len_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">line_indent</span><span class="p">,</span> <span class="n">line_len</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">len_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Empty lines take on their parents indentation</span>
            <span class="n">indent_</span> <span class="o">=</span> <span class="n">prev_indent</span>
        <span class="n">true_indent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_</span><span class="p">)</span>
        <span class="n">prev_indent</span> <span class="o">=</span> <span class="n">indent_</span>

    <span class="c1"># tag_pattern = ut.regex_or([&#39;Args:&#39;, &#39;Return:&#39;, &#39;CommandLine&#39;:])</span>
    <span class="n">tag_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[^\s]+: *$&#39;</span>

    <span class="n">group_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prev_indent</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">group_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_tag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">indent_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">docstr_lines</span><span class="p">,</span> <span class="n">true_indent</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag_pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="c1"># Check if we can look ahead</span>
            <span class="k">if</span> <span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">docstr_lines</span><span class="p">):</span>
                <span class="c1"># A tag is only valid if its next line is properly indented,</span>
                <span class="c1"># empty, or is a tag itself.</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">true_indent</span><span class="p">[</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">base_indent</span>
                    <span class="ow">or</span> <span class="n">line_len</span><span class="p">[</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag_pattern</span><span class="p">,</span> <span class="n">docstr_lines</span><span class="p">[</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="p">):</span>
                    <span class="n">group_id</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">in_tag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_id</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">in_tag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Check if this line belongs to a new group</span>
        <span class="k">elif</span> <span class="n">in_tag</span> <span class="ow">and</span> <span class="n">indent_</span> <span class="o">!=</span> <span class="n">prev_indent</span> <span class="ow">and</span> <span class="n">indent_</span> <span class="o">==</span> <span class="n">base_indent</span><span class="p">:</span>
            <span class="n">group_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">in_tag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
        <span class="n">prev_indent</span> <span class="o">=</span> <span class="n">indent_</span>

    <span class="n">groups_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">docstr_lines</span><span class="p">,</span> <span class="n">group_list</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">groups_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">tag_pattern</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># An encoded google sub-block</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">subblock</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A top level text documentation block</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;__DOC__&#39;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:]</span>
            <span class="n">subblock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">offsets</span><span class="p">:</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">subblock</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">subblock</span><span class="p">))</span>
        <span class="n">line_offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="c1"># Ensure that no keys are duplicated</span>
    <span class="c1"># try:</span>
    <span class="c1">#     assert len(ut.find_duplicate_items(ut.take_column(groups, 0))) == 0, (</span>
    <span class="c1">#         &#39;Duplicate google docblock keys are not allowed&#39;)</span>
    <span class="c1"># except Exception as ex:</span>
    <span class="c1">#     ut.printex(ex, iswarning=True)</span>
    <span class="k">return</span> <span class="n">groups</span></div>


<div class="viewcode-block" id="read_exampleblock"><a class="viewcode-back" href="../../utool.html#utool.util_tests.read_exampleblock">[docs]</a><span class="k">def</span> <span class="nf">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">):</span>
    <span class="c1"># if False:</span>
    <span class="c1">#     no longer needed with new parser</span>
    <span class="c1">#     import utool as ut</span>
    <span class="c1">#     nonheader_src = ut.unindent(&#39;\n&#39;.join(docblock.splitlines()[1:]))</span>
    <span class="n">nonheader_src</span> <span class="o">=</span> <span class="n">docblock</span>
    <span class="n">nonheader_lines</span> <span class="o">=</span> <span class="n">nonheader_src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">reversed_src_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reversed_want_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">finished_want</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Read the example block backwards to get the want string</span>
    <span class="c1"># and then the rest should all be source</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">nonheader_lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finished_want</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;... &#39;</span><span class="p">):</span>
                <span class="n">finished_want</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reversed_want_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">reversed_want_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">continue</span>
        <span class="n">reversed_src_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">test_src</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reversed_src_lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">test_want</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reversed_want_lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">test_src</span><span class="p">,</span> <span class="n">test_want</span></div>


<div class="viewcode-block" id="parse_doctest_from_docstr"><a class="viewcode-back" href="../../utool.html#utool.util_tests.parse_doctest_from_docstr">[docs]</a><span class="k">def</span> <span class="nf">parse_doctest_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    because doctest itself doesnt do what I want it to do</span>

<span class="sd">    CAREFUL, IF YOU GET BACK WRONG RESULTS MAKE SURE YOUR DOCSTR IS PREFFIXED</span>
<span class="sd">    WITH R</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --exec-parse_doctest_from_docstr</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = parse_doctest_from_docstr</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.list_depth</span>
<span class="sd">        &gt;&gt;&gt; #func_or_class = ut.util_depricated.cartesian</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.iter_module_doctestable</span>
<span class="sd">        &gt;&gt;&gt; docstr = ut.get_docstr(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;\n\n&#39;.join(testsrc_list))</span>
<span class="sd">        &gt;&gt;&gt; assert len(testsrc_list) == len(testwant_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">docstr_blocks</span> <span class="o">=</span> <span class="n">parse_docblocks_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># print(&#39;docstr_blocks = %r&#39; % (docstr_blocks,))</span>

    <span class="n">example_docblocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">example_setups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grid_example_docblock</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">grid_setups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">param_grids</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span> <span class="ow">in</span> <span class="n">docstr_blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Doctest&#39;</span><span class="p">):</span>
            <span class="n">example_docblocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Setup&#39;</span><span class="p">):</span>
            <span class="n">setup_src</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">example_setups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setup_src</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GridParams&#39;</span><span class="p">):</span>
            <span class="n">paramgrid_src</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">globals_</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">six</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="s1">&#39;import utool as ut</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">paramgrid_src</span><span class="p">,</span> <span class="n">globals_</span><span class="p">)</span>
            <span class="k">assert</span> <span class="s1">&#39;combos&#39;</span> <span class="ow">in</span> <span class="n">globals_</span><span class="p">,</span> <span class="s1">&#39;param grid must define combos&#39;</span>
            <span class="n">combos</span> <span class="o">=</span> <span class="n">globals_</span><span class="p">[</span><span class="s1">&#39;combos&#39;</span><span class="p">]</span>
            <span class="n">param_grids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">execstr_dict</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GridExample&#39;</span><span class="p">):</span>
            <span class="n">grid_example_docblock</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;GridSetup&#39;</span><span class="p">):</span>
            <span class="n">setup_src</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">grid_setups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setup_src</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_setups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cant have more than 1 setup. </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">example_setups</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">example_setups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">grid_setups</span><span class="p">:</span>
        <span class="n">grid_setups</span> <span class="o">=</span> <span class="n">example_setups</span>

    <span class="n">testheader_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">testsrc_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">testwant_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">testlineoffset_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Place grid tests first</span>
    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span> <span class="ow">in</span> <span class="n">grid_example_docblock</span><span class="p">:</span>
        <span class="n">test_src</span><span class="p">,</span> <span class="n">test_want</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_setups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;need one grid setup&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_setups</span><span class="p">):</span>
            <span class="n">grid_setup</span> <span class="o">=</span> <span class="n">grid_setups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid_setup</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">hack_show_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;ut.show_if_requested()&#39;</span> <span class="ow">in</span> <span class="n">test_src</span><span class="p">:</span>
            <span class="n">hack_show_request</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">test_src</span> <span class="o">=</span> <span class="n">test_src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ut.show_if_requested()&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># Megahack</span>
        <span class="n">full_grid_testsrc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">grid_setup</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">pgrid</span><span class="p">,</span>
                        <span class="s2">&quot;print(&#39;Grid </span><span class="si">%d</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,),</span>
                        <span class="n">test_src</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">test_src</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">pgrid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_grids</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hack_show_request</span><span class="p">:</span>
            <span class="n">full_grid_testsrc</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;ut.show_if_requested()&#39;</span>

        <span class="n">testsrc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_grid_testsrc</span><span class="p">)</span>
        <span class="n">testheader_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">testwant_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_want</span><span class="p">)</span>
        <span class="n">testlineoffset_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_offset</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span> <span class="ow">in</span> <span class="n">example_docblocks</span><span class="p">:</span>
        <span class="n">test_src</span><span class="p">,</span> <span class="n">test_want</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Doctest&#39;</span><span class="p">):</span>
            <span class="c1"># Enable anything labeled as a doctest</span>
            <span class="n">test_src</span> <span class="o">=</span> <span class="s1">&#39;# ENABLE_DOCTEST</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">test_src</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_setups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">full_testsrc</span> <span class="o">=</span> <span class="n">test_src</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_setups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Hack: append setups to all sources</span>
            <span class="n">full_testsrc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">example_setups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test_src</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;more than 1 setup&#39;</span>
        <span class="n">testheader_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">testsrc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_testsrc</span><span class="p">)</span>
        <span class="n">testwant_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_want</span><span class="p">)</span>
        <span class="n">testlineoffset_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_offset</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">testheader_list</span><span class="p">,</span> <span class="n">testsrc_list</span><span class="p">,</span> <span class="n">testwant_list</span><span class="p">,</span> <span class="n">testlineoffset_list</span></div>


<span class="c1"># @debug_decor</span>
<div class="viewcode-block" id="get_doctest_examples"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_doctest_examples">[docs]</a><span class="k">def</span> <span class="nf">get_doctest_examples</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">,</span> <span class="n">modpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_doctest_examples</span>

<span class="sd">    Depth 3)</span>
<span class="sd">    called by get_module_doctest_tup</span>

<span class="sd">    Args:</span>
<span class="sd">        func_or_class (function)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple (list, list): example_list, want_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --test-get_doctest_examples</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = get_doctest_examples</span>
<span class="sd">        &gt;&gt;&gt; tup  = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = tup</span>
<span class="sd">        &gt;&gt;&gt; result = str(len(testsrc_list) + len(testwant_list))</span>
<span class="sd">        &gt;&gt;&gt; print(testsrc_list)</span>
<span class="sd">        &gt;&gt;&gt; print(testlinenum_list)</span>
<span class="sd">        &gt;&gt;&gt; print(func_lineno)</span>
<span class="sd">        &gt;&gt;&gt; print(testwant_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        6</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.tryimport</span>
<span class="sd">        &gt;&gt;&gt; tup = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = tup</span>
<span class="sd">        &gt;&gt;&gt; result = str(len(testsrc_list) + len(testwant_list))</span>
<span class="sd">        &gt;&gt;&gt; print(testsrc_list)</span>
<span class="sd">        &gt;&gt;&gt; print(testlinenum_list)</span>
<span class="sd">        &gt;&gt;&gt; print(func_lineno)</span>
<span class="sd">        &gt;&gt;&gt; print(testwant_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        4</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = wbia.control.manual_annot_funcs.add_annots</span>
<span class="sd">        &gt;&gt;&gt; tup = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = tup</span>
<span class="sd">        &gt;&gt;&gt; result = str(len(testsrc_list) + len(testwant_list))</span>
<span class="sd">        &gt;&gt;&gt; print(testsrc_list)</span>
<span class="sd">        &gt;&gt;&gt; print(testlinenum_list)</span>
<span class="sd">        &gt;&gt;&gt; print(func_lineno)</span>
<span class="sd">        &gt;&gt;&gt; print(testwant_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
        <span class="n">func_or_class</span> <span class="o">=</span> <span class="n">func_or_class</span><span class="o">.</span><span class="vm">__func__</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test][DEPTH 3] get_doctest_examples()&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] + parsing </span><span class="si">%r</span><span class="s1"> for doctest&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_or_class</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] - name = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_or_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">,</span> <span class="s1">&#39;__ut_parent_class__&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[util_test] - __ut_parent_class__ = </span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">func_or_class</span><span class="o">.</span><span class="n">__ut_parent_class__</span><span class="p">,)</span>
            <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;FIXME&#39;</span><span class="p">)</span>
        <span class="c1"># func_or_class._utinfo[&#39;orig_func&#39;]</span>
        <span class="n">func_lineno</span> <span class="o">=</span> <span class="n">func_or_class</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_firstlineno</span>
        <span class="c1"># FIXME: doesn&#39;t handle decorators well</span>
        <span class="c1">#</span>
        <span class="c1"># ~~FIXME doesn&#39;t account for multiline function definitions</span>
        <span class="c1"># actually parse this out~~</span>
        <span class="c1"># TODO: rectify with util_insepct get_funcsource with stip def line</span>
        <span class="n">sourcecode</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">regex_get_match</span><span class="p">(</span><span class="s1">&#39;def [^)]*</span><span class="se">\\</span><span class="s1">):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sourcecode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_funcdef_lines</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_funcdef_lines</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">func_lineno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_funcdef_lines</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;[util-test] error getting function line number&#39;</span><span class="p">)</span>

    <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_docstr</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">)</span>

    <span class="p">(</span>
        <span class="n">testheader_list</span><span class="p">,</span>
        <span class="n">testsrc_list</span><span class="p">,</span>
        <span class="n">testwant_list</span><span class="p">,</span>
        <span class="n">testlineoffset_list</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">parse_doctest_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
    <span class="n">testlinenum_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">func_lineno</span> <span class="o">+</span> <span class="n">num_funcdef_lines</span> <span class="o">+</span> <span class="n">offset</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">testlineoffset_list</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test] L found </span><span class="si">%d</span><span class="s1"> doctests&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">testsrc_list</span><span class="p">),))</span>
    <span class="n">examptup</span> <span class="o">=</span> <span class="n">testsrc_list</span><span class="p">,</span> <span class="n">testwant_list</span><span class="p">,</span> <span class="n">testlinenum_list</span><span class="p">,</span> <span class="n">func_lineno</span><span class="p">,</span> <span class="n">docstr</span>
    <span class="k">return</span> <span class="n">examptup</span></div>


<div class="viewcode-block" id="get_module_doctest_tup"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_module_doctest_tup">[docs]</a><span class="k">def</span> <span class="nf">get_module_doctest_tup</span><span class="p">(</span>
    <span class="n">testable_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">check_flags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">allexamples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">needs_enable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">testslow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses module for testable doctesttups</span>

<span class="sd">    enabled_testtup_list (list): a list of testtup</span>

<span class="sd">    testtup (tuple): (name, num, src, want, flag) describes a valid doctest in the module</span>
<span class="sd">        name  (str): test name</span>
<span class="sd">        num   (str): test number of the module / function / class / method</span>
<span class="sd">        src   (str): test source code</span>
<span class="sd">        want  (str): expected test result</span>
<span class="sd">        flag  (str): a valid commandline flag to enable this test</span>

<span class="sd">    frame_fpath (str): module fpath that will be tested</span>
<span class="sd">    all_testflags (list): the command line arguments that will enable different tests</span>
<span class="sd">    module (module): the actual module that will be tested</span>
<span class="sd">    exclude_inherited (bool): does not included tests defined in other modules</span>

<span class="sd">    Args:</span>
<span class="sd">        testable_list (list): a list of functions (default = None)</span>
<span class="sd">        check_flags (bool): (default = True)</span>
<span class="sd">        module (None): (default = None)</span>
<span class="sd">        allexamples (None): (default = None)</span>
<span class="sd">        needs_enable (None): (default = None)</span>
<span class="sd">        N (int): (default = 0)</span>
<span class="sd">        verbose (bool):  verbosity flag(default = True)</span>
<span class="sd">        testslow (bool): (default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ModuleDoctestTup : (enabled_testtup_list, frame_fpath, all_testflags, module)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --exec-get_module_doctest_tup</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; #testable_list = [ut.util_import.package_contents]</span>
<span class="sd">        &gt;&gt;&gt; testable_list = None</span>
<span class="sd">        &gt;&gt;&gt; check_flags = False</span>
<span class="sd">        &gt;&gt;&gt; module = ut.util_cplat</span>
<span class="sd">        &gt;&gt;&gt; allexamples = False</span>
<span class="sd">        &gt;&gt;&gt; needs_enable = None</span>
<span class="sd">        &gt;&gt;&gt; N = 0</span>
<span class="sd">        &gt;&gt;&gt; verbose = True</span>
<span class="sd">        &gt;&gt;&gt; testslow = False</span>
<span class="sd">        &gt;&gt;&gt; mod_doctest_tup = get_module_doctest_tup(testable_list, check_flags,</span>
<span class="sd">        &gt;&gt;&gt;                                          module, allexamples,</span>
<span class="sd">        &gt;&gt;&gt;                                          needs_enable, N, verbose,</span>
<span class="sd">        &gt;&gt;&gt;                                          testslow)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;mod_doctest_tup = %s&#39; % (ut.repr4(mod_doctest_tup, nl=4),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># +------------------------</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[util_test.get_module_doctest tup][DEPTH 2] get_module_doctest tup()&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="k">if</span> <span class="n">needs_enable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">needs_enable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--enableall&#39;</span><span class="p">)</span>
        <span class="c1"># needs_enable = True</span>
    <span class="n">TEST_ALL_EXAMPLES</span> <span class="o">=</span> <span class="n">allexamples</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--allexamples&#39;</span><span class="p">,</span> <span class="s1">&#39;--all-examples&#39;</span><span class="p">))</span>
    <span class="n">parse_testables</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">testable_list</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
        <span class="c1"># hack</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">testable_list</span>
        <span class="n">testable_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testable_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">testable_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">testable_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testable_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testable_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">testable_list</span><span class="p">]</span>
        <span class="n">parse_testables</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># L________________________</span>
    <span class="c1"># +------------------------</span>
    <span class="c1"># GET_MODULE_DOCTEST_TUP Step 1:</span>
    <span class="c1"># Inspect caller module for testable names</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="s1">&#39;???&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This is a bit finky. Need to be exactly N frames under the main</span>
            <span class="c1"># module</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_parent_frame</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
            <span class="n">main_modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>
            <span class="n">frame_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="s1">&#39;__name__&#39;</span><span class="p">]</span>
            <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_name</span> <span class="o">==</span> <span class="n">main_modname</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">main_modname</span><span class="p">]</span>
                <span class="n">entry_modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">entry_modname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kernprof&#39;</span><span class="p">,</span> <span class="s1">&#39;kernprof-script&#39;</span><span class="p">]:</span>
                    <span class="c1"># kernprof clobbers the __main__ variable.</span>
                    <span class="c1"># workaround by reimporting the module name</span>
                    <span class="kn">import</span> <span class="nn">importlib</span>

                    <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="n">allexamples</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span>
        <span class="n">allexamples</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># L________________________</span>

    <span class="c1"># +------------------------</span>
    <span class="c1"># GET_MODULE_DOCTEST_TUP Step 2:</span>
    <span class="c1"># --- PARSE TESTABLE FUNCTIONS ---</span>
    <span class="c1"># Get testable functions</span>
    <span class="k">if</span> <span class="n">parse_testables</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">VERBOSE_TEST</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ut.test] Iterating over module funcs&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ut.test] module =</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,))</span>

            <span class="n">_testableiter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">iter_module_doctestable</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">include_inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_testableiter</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
                    <span class="n">docstr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="vm">__func__</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">docstr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_unicode</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Doctest&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="n">testable_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">testable_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ut.test] Testable: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Doctest&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ut.test] Ignoring (disabled) : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[ut.test] Ignoring (no Example) : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAILED&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">])</span>
            <span class="k">raise</span>

    <span class="c1"># OUTPUTS: testable_list</span>
    <span class="c1"># L________________________</span>
    <span class="c1"># +------------------------</span>
    <span class="c1"># GET_MODULE_DOCTEST_TUP Step 3:</span>
    <span class="c1"># --- FILTER TESTABLES_---</span>

    <span class="c1"># Get testable function examples</span>

    <span class="n">test_sentinals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;ENABLE_DOCTEST&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ENABLE_GRID_DOCTEST&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">testslow</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--testall&#39;</span><span class="p">,</span> <span class="s1">&#39;--testslow&#39;</span><span class="p">,</span> <span class="s1">&#39;--test-slow&#39;</span><span class="p">)):</span>
        <span class="n">test_sentinals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SLOW_DOCTEST&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testslow</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--testall&#39;</span><span class="p">,</span> <span class="s1">&#39;--testunstable&#39;</span><span class="p">)):</span>
        <span class="n">test_sentinals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;UNSTABLE_DOCTEST&#39;</span><span class="p">)</span>

    <span class="c1"># FIND THE TEST NAMES REQUESTED</span>
    <span class="c1"># Grab sys.argv enabled tests</span>
    <span class="n">cmdline_varargs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_cmdline_varargs</span><span class="p">()</span>
    <span class="n">force_enable_testnames_</span> <span class="o">=</span> <span class="n">cmdline_varargs</span><span class="p">[:]</span>
    <span class="n">valid_prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--test-&#39;</span><span class="p">,</span> <span class="s1">&#39;--exec-&#39;</span><span class="p">,</span> <span class="s1">&#39;--dump-&#39;</span><span class="p">]</span>
    <span class="c1"># if False:</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">valid_prefix_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">testname</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]</span>
                <span class="c1"># testname = testname.split(&#39;:&#39;)[0].replace(&#39;-&#39;, &#39;_&#39;)</span>
                <span class="n">force_enable_testnames_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
                <span class="c1"># break</span>

    <span class="c1"># PartA: Fixup names</span>
    <span class="c1"># TODO: parse out requested test number here</span>
    <span class="c1"># instead of later in the code. See PartB</span>
    <span class="n">force_enable_testnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">testname</span> <span class="ow">in</span> <span class="n">force_enable_testnames_</span><span class="p">:</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">testname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">testname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">force_enable_testnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_testable_name</span><span class="p">(</span><span class="n">testable</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">testable</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
            <span class="n">testable</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="vm">__func__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">testable_name</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">func_name</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">testable_name</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex1</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">testable</span><span class="p">)))</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex2</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">testable</span><span class="p">)))</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">testable_name</span>

    <span class="n">sorted_testable</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">testable_list</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_testable_name</span><span class="p">)</span>
    <span class="c1"># Append each testable example</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Vars:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * needs_enable = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">needs_enable</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * force_enable_testnames = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">force_enable_testnames</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * len(sorted_testable) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_testable</span><span class="p">),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * cmdline_varargs = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmdline_varargs</span><span class="p">,))</span>
        <span class="n">indenter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[FIND_AVAIL]&#39;</span><span class="p">)</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># PARSE OUT THE AVAILABLE TESTS FOR EACH REQUEST</span>
    <span class="n">local_testtup_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">testable</span> <span class="ow">in</span> <span class="n">sorted_testable</span><span class="p">:</span>
        <span class="n">short_testname</span> <span class="o">=</span> <span class="n">_get_testable_name</span><span class="p">(</span><span class="n">testable</span><span class="p">)</span>
        <span class="n">full_testname</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Namespaced classname (within module)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">testable</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
            <span class="n">testable</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="vm">__func__</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">testable</span><span class="p">,</span> <span class="s1">&#39;__ut_parent_class__&#39;</span><span class="p">):</span>
            <span class="c1"># HACK for getting classname.funcname</span>
            <span class="n">test_namespace</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">__ut_parent_class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">full_testname</span> <span class="o">=</span> <span class="n">test_namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">short_testname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_namespace</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">full_testname</span> <span class="o">=</span> <span class="n">short_testname</span>

        <span class="n">nametup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">full_testname</span><span class="p">,</span> <span class="n">short_testname</span><span class="p">]))</span>
        <span class="c1"># modpath = ut.get_modpath(module)</span>
        <span class="n">examptup</span> <span class="o">=</span> <span class="n">get_doctest_examples</span><span class="p">(</span><span class="n">testable</span><span class="p">)</span>
        <span class="n">examples</span><span class="p">,</span> <span class="n">wants</span><span class="p">,</span> <span class="n">linenums</span><span class="p">,</span> <span class="n">func_lineno</span><span class="p">,</span> <span class="n">docstr</span> <span class="o">=</span> <span class="n">examptup</span>
        <span class="n">total_examples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_examples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">testno</span><span class="p">,</span> <span class="n">srcwant_tup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">wants</span><span class="p">)):</span>
                <span class="n">src</span><span class="p">,</span> <span class="n">want</span> <span class="o">=</span> <span class="n">srcwant_tup</span>
                <span class="n">src_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">regex_replace</span><span class="p">(</span><span class="s1">&#39;from __future__ import.*$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
                <span class="n">test_disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">src_</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">test_sentinals</span><span class="p">])</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">needs_enable</span>
                    <span class="ow">and</span> <span class="n">test_disabled</span>
                    <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="n">force_enable_testnames</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s1">&#39; * HACK adding testname=</span><span class="si">%r</span><span class="s1"> to local_testtup_list&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">full_testname</span><span class="p">,)</span>
                        <span class="p">)</span>
                    <span class="n">local_testtup</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">nametup</span><span class="p">,</span>
                        <span class="n">testno</span><span class="p">,</span>
                        <span class="n">src_</span><span class="p">,</span>
                        <span class="n">want</span><span class="p">,</span>
                        <span class="n">test_namespace</span><span class="p">,</span>
                        <span class="n">short_testname</span><span class="p">,</span>
                        <span class="n">total_examples</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">local_testtup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_testtup</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                        <span class="c1"># print(&#39;force_enable_testnames = %r&#39; % (force_enable_testnames,))</span>
                        <span class="c1"># print(&#39;nametup = %r&#39; % (nametup,))</span>
                        <span class="c1"># print(&#39;needs_enable = %r&#39; % (needs_enable,))</span>
                        <span class="c1"># print(&#39;test_disabled = %r&#39; % (test_disabled,))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * skipping: </span><span class="si">%r</span><span class="s1"> / </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">short_testname</span><span class="p">,</span> <span class="n">full_testname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;WARNING: no examples in </span><span class="si">%r</span><span class="s1"> for testname=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">frame_fpath</span><span class="p">,</span> <span class="n">full_testname</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">testable</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">wants</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; --&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="c1"># L________________________</span>
    <span class="c1"># +------------------------</span>
    <span class="c1"># Get enabled (requested) examples</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-----</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">indenter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s1">&#39;[IS_ENABLED]&#39;</span><span class="p">)</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished parsing available doctests.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Now we need to find which examples are enabled&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;len(local_testtup_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_testtup_list</span><span class="p">),))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;local_testtup_list.T[0:2].T = </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">local_testtup_list</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sys.argv = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,))</span>
    <span class="n">all_testflags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enabled_testtup_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">distabled_testflags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span>
        <span class="s1">&#39;--subx&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help_</span><span class="o">=</span><span class="s1">&#39;Only tests the subxth example&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_valid_testnames</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">),</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="n">total</span><span class="p">),</span>  <span class="c1"># allow negative indices</span>
            <span class="c1"># prefix + name.replace(&#39;_&#39;, &#39;-&#39;) + &#39;:&#39; + str(num),</span>
            <span class="c1"># prefix + name.replace(&#39;_&#39;, &#39;-&#39;)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">make_valid_test_argflags</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
        <span class="n">valid_testnames</span> <span class="o">=</span> <span class="n">make_valid_testnames</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">testname</span> <span class="k">for</span> <span class="n">testname</span> <span class="ow">in</span> <span class="n">valid_testnames</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">check_if_test_requested</span><span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">valid_prefix_list</span><span class="p">):</span>
        <span class="c1"># cmdline_varargs</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking cmdline for </span><span class="si">%r</span><span class="s1"> </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
        <span class="n">valid_argflags</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># FIXME: PartB</span>
        <span class="c1"># should parse out test number above instead of here</span>
        <span class="c1"># See PartA</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">veryverb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># First check positional args</span>
        <span class="n">testflag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nametup</span><span class="p">:</span>
            <span class="n">valid_testnames</span> <span class="o">=</span> <span class="n">make_valid_test_argflags</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">veryverb</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking if positional* </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">valid_testnames</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;name = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">cmdline_varargs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">valid_testnames</span><span class="p">]):</span>
                <span class="c1"># hack</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;exec&#39;</span>
                <span class="n">testflag</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">flag1</span> <span class="o">=</span> <span class="s1">&#39;--exec-&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">testflag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">veryverb</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FOUND POSARG&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * testflag = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testflag</span><span class="p">,))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * num = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,))</span>
                <span class="k">break</span>
        <span class="c1"># Then check keyword-ish args</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">(</span><span class="n">valid_prefix_list</span><span class="p">,</span> <span class="n">nametup</span><span class="p">))):</span>
                <span class="n">valid_argflags</span> <span class="o">=</span> <span class="n">make_valid_test_argflags</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">veryverb</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for flags*: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">valid_argflags</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="n">flag1</span> <span class="o">=</span> <span class="n">valid_argflags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">testflag</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="n">valid_argflags</span><span class="p">)</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">testflag</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">veryverb</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FOUND VARARG&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(&#39;WARNING NO TEST IS ENABLED %r &#39; % (nametup,))</span>
                <span class="k">pass</span>
        <span class="n">checktup</span> <span class="o">=</span> <span class="n">flag1</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">testflag</span>
        <span class="k">return</span> <span class="n">checktup</span>

    <span class="k">for</span> <span class="n">local_testtup</span> <span class="ow">in</span> <span class="n">local_testtup_list</span><span class="p">:</span>
        <span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">test_namespace</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_testtup</span>
        <span class="n">checktup</span> <span class="o">=</span> <span class="n">check_if_test_requested</span><span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">valid_prefix_list</span><span class="p">)</span>
        <span class="n">flag1</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">testflag</span> <span class="o">=</span> <span class="n">checktup</span>
        <span class="n">testenabled</span> <span class="o">=</span> <span class="n">TEST_ALL_EXAMPLES</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_flags</span> <span class="ow">or</span> <span class="n">testflag</span>
        <span class="k">if</span> <span class="n">subx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">subx</span> <span class="o">!=</span> <span class="n">num</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">all_testflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">testenabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... enabling test&#39;</span><span class="p">)</span>
            <span class="n">testtup</span> <span class="o">=</span> <span class="n">TestTuple</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">num</span><span class="p">,</span>
                <span class="n">src</span><span class="p">,</span>
                <span class="n">want</span><span class="p">,</span>
                <span class="n">flag1</span><span class="p">,</span>
                <span class="n">frame_fpath</span><span class="o">=</span><span class="n">frame_fpath</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
                <span class="n">nametup</span><span class="o">=</span><span class="n">nametup</span><span class="p">,</span>
                <span class="n">shortname</span><span class="o">=</span><span class="n">shortname</span><span class="p">,</span>
                <span class="n">test_namespace</span><span class="o">=</span><span class="n">test_namespace</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">testtup</span><span class="p">))</span>
            <span class="n">enabled_testtup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testtup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... disabling test&#39;</span><span class="p">)</span>
            <span class="n">distabled_testflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag1</span><span class="p">)</span>

    <span class="c1"># Attempt to run test without any context</span>
    <span class="c1"># This will only work if the function exist and is self contained</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">force_enable_testnames_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Forced test did not have a doctest example&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maybe it can be run without any context&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="c1"># assert len(force_enable_testnames) == 1</span>
        <span class="n">test_funcname_</span> <span class="o">=</span> <span class="n">force_enable_testnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_funcname_</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">test_classname</span><span class="p">,</span> <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">test_funcname_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">test_classname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">class_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">func_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">test_funcname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">test_funcname_</span>
            <span class="n">func_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">test_funcname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test_funcname = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;func_ = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">func_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">testno</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
            <span class="n">want</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;attempting xdoctest hack&#39;</span><span class="p">)</span>
                <span class="c1"># hack to get classmethods to read their example using</span>
                <span class="c1"># the xdoctest port</span>
                <span class="kn">from</span> <span class="nn">xdoctest</span> <span class="kn">import</span> <span class="n">docscrape_google</span>
                <span class="kn">from</span> <span class="nn">xdoctest</span> <span class="kn">import</span> <span class="n">core</span> <span class="k">as</span> <span class="n">xdoc_core</span>
                <span class="kn">from</span> <span class="nn">xdoctest</span> <span class="kn">import</span> <span class="n">static_analysis</span> <span class="k">as</span> <span class="n">static</span>

                <span class="k">if</span> <span class="n">func_</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>
                <span class="n">blocks</span> <span class="o">=</span> <span class="n">docscrape_google</span><span class="o">.</span><span class="n">split_google_docblocks</span><span class="p">(</span><span class="n">func_</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

                <span class="n">example_blocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">type_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Doctest&#39;</span><span class="p">):</span>
                        <span class="n">example_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">type_</span><span class="p">,</span> <span class="n">block</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_blocks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;xdoctest found no blocks&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span>

                <span class="n">callname</span> <span class="o">=</span> <span class="n">test_funcname_</span>
                <span class="n">hack_testtups</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">example_blocks</span><span class="p">):</span>
                    <span class="c1"># print(&#39;modname = %r&#39; % (modname,))</span>
                    <span class="c1"># print(&#39;callname = %r&#39; % (callname,))</span>
                    <span class="c1"># print(&#39;num = %r&#39; % (num,))</span>
                    <span class="n">modpath</span> <span class="o">=</span> <span class="n">static</span><span class="o">.</span><span class="n">modname_to_modpath</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
                    <span class="n">example</span> <span class="o">=</span> <span class="n">xdoc_core</span><span class="o">.</span><span class="n">DocTest</span><span class="p">(</span>
                        <span class="n">modpath</span><span class="o">=</span><span class="n">modpath</span><span class="p">,</span> <span class="n">callname</span><span class="o">=</span><span class="n">callname</span><span class="p">,</span> <span class="n">docsrc</span><span class="o">=</span><span class="n">block</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span>
                    <span class="p">)</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">format_src</span><span class="p">(</span><span class="n">colored</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">want</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">want</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">wants</span><span class="p">()))</span>
                    <span class="n">testtup</span> <span class="o">=</span> <span class="n">TestTuple</span><span class="p">(</span>
                        <span class="n">test_funcname_</span><span class="p">,</span>
                        <span class="n">num</span><span class="p">,</span>
                        <span class="n">src</span><span class="p">,</span>
                        <span class="n">want</span><span class="o">=</span><span class="n">want</span><span class="p">,</span>
                        <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;--exec-&#39;</span> <span class="o">+</span> <span class="n">test_funcname_</span><span class="p">,</span>
                        <span class="n">frame_fpath</span><span class="o">=</span><span class="n">frame_fpath</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;exec&#39;</span><span class="p">,</span>
                        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">example_blocks</span><span class="p">),</span>
                        <span class="n">nametup</span><span class="o">=</span><span class="p">[</span><span class="n">test_funcname_</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">hack_testtups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testtup</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hack_testtups = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hack_testtups</span><span class="p">,))</span>
                <span class="n">enabled_testtup_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hack_testtups</span><span class="p">)</span>
                <span class="c1"># src = &#39;\n&#39;.join([line[4:] for line in src.split(&#39;\n&#39;)])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;xdoctest hack failed&#39;</span><span class="p">)</span>
                <span class="c1"># varargs = ut.get_cmdline_varargs()</span>
                <span class="n">varargs</span> <span class="o">=</span> <span class="n">force_enable_testnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c1"># Create dummy doctest</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    # DUMMY_DOCTEST</span>
<span class="sd">                    from {modname} import *  # NOQA</span>
<span class="sd">                    args = {varargs}</span>
<span class="sd">                    result = {test_funcname_}(*args)</span>
<span class="sd">                    print(result)</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">modname</span><span class="o">=</span><span class="n">modname</span><span class="p">,</span> <span class="n">test_funcname_</span><span class="o">=</span><span class="n">test_funcname_</span><span class="p">,</span> <span class="n">varargs</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">varargs</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">testtup</span> <span class="o">=</span> <span class="n">TestTuple</span><span class="p">(</span>
                    <span class="n">test_funcname_</span><span class="p">,</span>
                    <span class="n">testno</span><span class="p">,</span>
                    <span class="n">src</span><span class="p">,</span>
                    <span class="n">want</span><span class="o">=</span><span class="n">want</span><span class="p">,</span>
                    <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;--exec-&#39;</span> <span class="o">+</span> <span class="n">test_funcname_</span><span class="p">,</span>
                    <span class="n">frame_fpath</span><span class="o">=</span><span class="n">frame_fpath</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;exec&#39;</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">nametup</span><span class="o">=</span><span class="p">[</span><span class="n">test_funcname_</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">enabled_testtup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testtup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function </span><span class="si">%r</span><span class="s1"> was not found in </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname_</span><span class="p">,</span> <span class="n">module</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--list&#39;</span><span class="p">):</span>
        <span class="c1"># HACK: Should probably just return a richer structure</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;testable_name_list = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">testable_name_list</span><span class="p">),))</span>

    <span class="n">mod_doctest_tup</span> <span class="o">=</span> <span class="n">ModuleDoctestTup</span><span class="p">(</span>
        <span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">,</span> <span class="n">all_testflags</span><span class="p">,</span> <span class="n">module</span>
    <span class="p">)</span>
    <span class="c1"># L________________________</span>
    <span class="k">return</span> <span class="n">mod_doctest_tup</span></div>


<div class="viewcode-block" id="doctest_was_requested"><a class="viewcode-back" href="../../utool.html#utool.util_tests.doctest_was_requested">[docs]</a><span class="k">def</span> <span class="nf">doctest_was_requested</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;lets a  __main__ codeblock know that util_test should do its thing&quot;&quot;&quot;</span>
    <span class="c1"># FIXME; does not handle positinal doctest requests</span>
    <span class="n">valid_prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;--exec-&#39;</span><span class="p">,</span> <span class="s1">&#39;--test-&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39;--tf&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="nb">any</span><span class="p">([</span><span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">valid_prefix_list</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
        <span class="p">]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="find_doctestable_modnames"><a class="viewcode-back" href="../../utool.html#utool.util_tests.find_doctestable_modnames">[docs]</a><span class="k">def</span> <span class="nf">find_doctestable_modnames</span><span class="p">(</span>
    <span class="n">dpath_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_doctests_fnames</span><span class="o">=</span><span class="p">[],</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="p">[],</span> <span class="n">allow_nonpackages</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to find files with a call to ut.doctest_funcs in the __main__ part</span>
<span class="sd">    Implementation is very hacky. Should find a better heuristic</span>

<span class="sd">    Args:</span>
<span class="sd">        dpath_list (list): list of python package directories</span>
<span class="sd">        exclude_doctests_fnames (list): (default = [])</span>
<span class="sd">        exclude_dirs (list): (default = [])</span>
<span class="sd">        allow_nonpackages (bool): (default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: list of filepaths</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests find_doctestable_modnames --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; from os.path import dirname</span>
<span class="sd">        &gt;&gt;&gt; dpath_list = [ut.get_module_dir(ut)]</span>
<span class="sd">        &gt;&gt;&gt; exclude_doctests_fnames = []</span>
<span class="sd">        &gt;&gt;&gt; exclude_dirs = []</span>
<span class="sd">        &gt;&gt;&gt; allow_nonpackages = False</span>
<span class="sd">        &gt;&gt;&gt; result = find_doctestable_modnames(dpath_list, exclude_doctests_fnames, exclude_dirs, allow_nonpackages)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">join</span>

    <span class="n">fpath_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;doctest_funcs\(&#39;</span><span class="p">,</span>
        <span class="n">dpath_list</span><span class="o">=</span><span class="n">dpath_list</span><span class="p">,</span>
        <span class="n">include_patterns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*.py&#39;</span><span class="p">],</span>
        <span class="n">exclude_dirs</span><span class="o">=</span><span class="n">exclude_dirs</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">exclude_doctests_fnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude_doctests_fnames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_not_excluded</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_doctests_fnames</span>

    <span class="k">def</span> <span class="nf">is_in_package</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exists</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">fpath</span><span class="p">),</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">))</span>

    <span class="n">fpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_in_package</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">))</span>
    <span class="n">fpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_not_excluded</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">))</span>
    <span class="n">doctest_modname_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">))</span>
    <span class="n">doctest_modname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">doctest_modname_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">doctest_modname_list</span></div>


<div class="viewcode-block" id="find_untested_modpaths"><a class="viewcode-back" href="../../utool.html#utool.util_tests.find_untested_modpaths">[docs]</a><span class="k">def</span> <span class="nf">find_untested_modpaths</span><span class="p">(</span><span class="n">dpath_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_doctests_fnames</span><span class="o">=</span><span class="p">[],</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="p">[]):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">fpath_list</span><span class="p">,</span> <span class="n">lines_list</span><span class="p">,</span> <span class="n">lxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span>
        <span class="s1">&#39;&gt;&gt;&gt; # ENABLE_DOCTEST&#39;</span><span class="p">,</span>
        <span class="n">dpath_list</span><span class="o">=</span><span class="n">dpath_list</span><span class="p">,</span>
        <span class="n">include_patterns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*.py&#39;</span><span class="p">],</span>
        <span class="n">exclude_dirs</span><span class="o">=</span><span class="n">exclude_dirs</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">exclude_doctests_fnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exclude_doctests_fnames</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;__init__.py&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">is_not_excluded</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_doctests_fnames</span>

    <span class="n">doctest_modpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_not_excluded</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">))</span>
    <span class="c1"># doctest_modname_list = list(map(ut.get_modname_from_modpath, doctest_modpath_list))</span>
    <span class="k">return</span> <span class="n">doctest_modpath_list</span></div>


<div class="viewcode-block" id="show_was_requested"><a class="viewcode-back" href="../../utool.html#utool.util_tests.show_was_requested">[docs]</a><span class="k">def</span> <span class="nf">show_was_requested</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns True if --show is specified on the commandline or you are in</span>
<span class="sd">    IPython (and presumably want some sort of interaction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">show_was_requested</span><span class="p">()</span></div>
    <span class="c1"># import utool as ut</span>
    <span class="c1"># return ut.get_argflag(&#39;--show&#39;) or ut.inIPython()</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Use ExitTestException from xdoctest if possible</span>
    <span class="kn">from</span> <span class="nn">xdoctest</span> <span class="kn">import</span> <span class="n">ExitTestException</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">xdoctest.core</span> <span class="kn">import</span> <span class="n">ExitTestException</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>

        <span class="k">class</span> <span class="nc">ExitTestException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="k">pass</span>


<div class="viewcode-block" id="qt4ensure"><a class="viewcode-back" href="../../utool.html#utool.util_tests.qt4ensure">[docs]</a><span class="k">def</span> <span class="nf">qt4ensure</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">qtensure</span><span class="p">()</span></div>


<div class="viewcode-block" id="qtensure"><a class="viewcode-back" href="../../utool.html#utool.util_tests.qtensure">[docs]</a><span class="k">def</span> <span class="nf">qtensure</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">qtensure</span><span class="p">()</span></div>


<div class="viewcode-block" id="quit_if_noshow"><a class="viewcode-back" href="../../utool.html#utool.util_tests.quit_if_noshow">[docs]</a><span class="k">def</span> <span class="nf">quit_if_noshow</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">saverequest</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s1">&#39;--save&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">saverequest</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--show&#39;</span><span class="p">,</span> <span class="s1">&#39;--save&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">inIPython</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">ExitTestException</span><span class="p">(</span><span class="s1">&#39;This should be caught gracefully by ut.run_test&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_if_requested"><a class="viewcode-back" href="../../utool.html#utool.util_tests.show_if_requested">[docs]</a><span class="k">def</span> <span class="nf">show_if_requested</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">wbia</span> <span class="kn">import</span> <span class="n">plottool</span> <span class="k">as</span> <span class="n">pt</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">plottool_ibeis</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">show_if_requested</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_testfunc"><a class="viewcode-back" href="../../utool.html#utool.util_tests.find_testfunc">[docs]</a><span class="k">def</span> <span class="nf">find_testfunc</span><span class="p">(</span>
    <span class="n">module</span><span class="p">,</span>
    <span class="n">test_funcname</span><span class="p">,</span>
    <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">func_to_module_dict</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">return_mod</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">modname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">package_contents</span><span class="p">(</span>
        <span class="n">module</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="n">ignore_prefix</span><span class="p">,</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="n">ignore_suffix</span>
    <span class="p">)</span>
    <span class="c1"># Get only the modules already imported</span>
    <span class="n">have_modnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">modname_</span> <span class="k">for</span> <span class="n">modname_</span> <span class="ow">in</span> <span class="n">modname_list</span> <span class="k">if</span> <span class="n">modname_</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">]</span>
    <span class="c1"># missing_modnames = [modname for modname in modname_list</span>
    <span class="c1">#                    if modname not in sys.modules]</span>
    <span class="n">module_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">,</span> <span class="n">have_modnames</span><span class="p">)</span>
    <span class="c1"># Search for the module containing the function</span>
    <span class="n">test_func</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">test_module</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">test_classname</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">test_classname</span><span class="p">,</span> <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">test_funcname</span><span class="p">,</span> <span class="n">testno</span> <span class="o">=</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">testno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">testno</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">test_classname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">module_</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
            <span class="c1"># test_funcname = &#39;find_installed_tomcat&#39;</span>
            <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">in</span> <span class="n">module_</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">test_module</span> <span class="o">=</span> <span class="n">module_</span>
                <span class="n">test_func</span> <span class="o">=</span> <span class="n">test_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">test_funcname</span><span class="p">]</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">module_</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
            <span class="c1"># test_funcname = &#39;find_installed_tomcat&#39;</span>
            <span class="k">if</span> <span class="n">test_classname</span> <span class="ow">in</span> <span class="n">module_</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">test_module</span> <span class="o">=</span> <span class="n">module_</span>
                <span class="n">test_class</span> <span class="o">=</span> <span class="n">test_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">test_classname</span><span class="p">]</span>
                <span class="n">test_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_class</span><span class="p">,</span> <span class="n">test_funcname</span><span class="p">)</span>
                <span class="c1"># test_class.__dict__[test_funcname]</span>

    <span class="k">if</span> <span class="n">test_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Did not find any function named </span><span class="si">%r</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searched &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">([</span><span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">return_mod</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">test_func</span><span class="p">,</span> <span class="n">testno</span><span class="p">,</span> <span class="n">test_module</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">test_func</span><span class="p">,</span> <span class="n">testno</span></div>


<div class="viewcode-block" id="get_module_completions"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_module_completions">[docs]</a><span class="k">def</span> <span class="nf">get_module_completions</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">test_tuples</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_package_testables</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">testnames</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">instancelist</span><span class="p">(</span><span class="n">test_tuples</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">testnames</span></div>


<span class="c1"># def autocomplete_hook(module):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    # https://argcomplete.readthedocs.io/en/latest/#activating-global-completion%20argcomplete</span>
<span class="c1">#    pip install argcomplete</span>

<span class="c1">#    Need to put</span>
<span class="c1">#    PYTHON_ARGCOMPLETE_OK at begining of file</span>

<span class="c1">#    pip install argcomplete</span>
<span class="c1">#    activate-global-python-argcomplete</span>

<span class="c1">#    eval &quot;$(register-python-argcomplete your_script)&quot;</span>
<span class="c1">#    register-python-argcomplete wbia</span>
<span class="c1">#    eval &quot;$(register-python-argcomplete wbia)&quot;</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    #if len(sys.argv) &lt; 3:</span>
<span class="c1">#    #    sys.exit(1)</span>
<span class="c1">#    try:</span>
<span class="c1">#        # hook</span>
<span class="c1">#        import argparse as ap</span>
<span class="c1">#        import argcomplete</span>
<span class="c1">#    except ImportError:</span>
<span class="c1">#        pass</span>
<span class="c1">#    else:</span>
<span class="c1">#        parser = ap.ArgumentParser()</span>
<span class="c1">#        testnames = get_module_completions(module)</span>
<span class="c1">#        testnames = [&#39;foo&#39;, &#39;foo2&#39;]</span>
<span class="c1">#        parser.add_argument(&#39;position1&#39;, choices=[testnames])</span>
<span class="c1">#        argcomplete.autocomplete(parser)</span>
<span class="c1">#        args = parser.parse_args()</span>


<div class="viewcode-block" id="main_function_tester"><a class="viewcode-back" href="../../utool.html#utool.util_tests.main_function_tester">[docs]</a><span class="k">def</span> <span class="nf">main_function_tester</span><span class="p">(</span>
    <span class="n">module</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[],</span> <span class="n">test_funcname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_to_module_dict</span><span class="o">=</span><span class="p">{}</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows a shorthand for __main__ packages of modules to run tests with</span>
<span class="sd">    unique function names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s1">&#39;[utool] main_function_tester&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--list-testfuncs&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Listing testfuncs&#39;</span><span class="p">)</span>
        <span class="n">test_tuples</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_package_testables</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">test_tuples</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># autocomplete_hook(module)</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--update-bashcomplete&#39;</span><span class="p">):</span>
        <span class="c1"># http://stackoverflow.com/questions/427472/line-completion-with-custom-commands</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Listing testfuncs&#39;</span><span class="p">)</span>
        <span class="n">testnames</span> <span class="o">=</span> <span class="n">get_module_completions</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">module</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;complete -W &quot;</span><span class="si">%s</span><span class="s1">&quot; &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testnames</span><span class="p">),</span> <span class="n">modname</span><span class="p">)</span>
        <span class="n">bash_completer</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensure_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;wbia&#39;</span><span class="p">),</span> <span class="s1">&#39;wbia_bash_complete.sh&#39;</span>
        <span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">bash_completer</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ADD TO BASHRC</span><span class="se">\n</span><span class="s1">source </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bash_completer</span><span class="p">,))</span>
        <span class="c1"># print(line)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">EXIT_SUCCESS</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--make-bashcomplete&#39;</span><span class="p">):</span>
        <span class="c1"># http://stackoverflow.com/questions/427472/line-completion-with-custom-commands</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Listing testfuncs&#39;</span><span class="p">)</span>
        <span class="n">testnames</span> <span class="o">=</span> <span class="n">get_module_completions</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">module</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;complete -W &quot;</span><span class="si">%s</span><span class="s1">&quot; &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testnames</span><span class="p">),</span> <span class="n">modname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;add the following line to your bashrc&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">EXIT_SUCCESS</span><span class="p">)</span>

    <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;--test-func&#39;</span><span class="p">,</span> <span class="s1">&#39;--tfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;--tf&#39;</span><span class="p">,</span> <span class="s1">&#39;--testfunc&#39;</span><span class="p">),</span>
        <span class="n">type_</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">test_funcname</span><span class="p">,</span>
        <span class="n">help_</span><span class="o">=</span><span class="s1">&#39;specify a function to doctest&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmdline_varags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_cmdline_varargs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking varargs&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cmdline_varags = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmdline_varags</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmdline_varags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">cmdline_varags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test_funcname = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">in</span> <span class="n">func_to_module_dict</span><span class="p">:</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">func_to_module_dict</span><span class="p">[</span><span class="n">test_funcname</span><span class="p">]</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># locals_ = {}</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">inject_colored_exceptions</span><span class="p">()</span>
        <span class="c1"># print(&#39;[utool] __main__ Begin Function Test&#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[utool] __main__ Begin Function Test&#39;</span><span class="p">)</span>
        <span class="n">test_func</span><span class="p">,</span> <span class="n">testno</span><span class="p">,</span> <span class="n">test_mod</span> <span class="o">=</span> <span class="n">find_testfunc</span><span class="p">(</span>
            <span class="n">module</span><span class="p">,</span>
            <span class="n">test_funcname</span><span class="p">,</span>
            <span class="n">ignore_prefix</span><span class="p">,</span>
            <span class="n">ignore_suffix</span><span class="p">,</span>
            <span class="n">func_to_module_dict</span><span class="p">,</span>
            <span class="n">return_mod</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">test_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">globals_</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func_globals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcglobals</span><span class="p">(</span><span class="n">test_func</span><span class="p">)</span>
                <span class="n">globals_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func_globals</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">tests</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_doctest_examples</span><span class="p">(</span><span class="n">test_func</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">testsrc</span> <span class="o">=</span> <span class="n">tests</span><span class="p">[</span><span class="n">testno</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create dummy doctest</span>
                <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_modpath</span><span class="p">(</span><span class="n">test_mod</span><span class="p">))</span>
                <span class="n">varargs</span> <span class="o">=</span> <span class="n">cmdline_varags</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">testsrc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    # DUMMY_DOCTEST</span>
<span class="sd">                    from {modname} import *  # NOQA</span>
<span class="sd">                    args = {varargs}</span>
<span class="sd">                    result = {test_funcname_}(*args)</span>
<span class="sd">                    print(result)</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">modname</span><span class="o">=</span><span class="n">modname</span><span class="p">,</span> <span class="n">test_funcname_</span><span class="o">=</span><span class="n">test_funcname</span><span class="p">,</span> <span class="n">varargs</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">varargs</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># testtup = TestTuple(test_funcname_, testno, src, want=want,</span>
                <span class="c1">#                     flag=&#39;--exec-&#39; + test_funcname_,</span>
                <span class="c1">#                     frame_fpath=frame_fpath, mode=&#39;exec&#39;,</span>
                <span class="c1">#                     total=1, nametup=[test_funcname_])</span>

            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;--embed&#39;</span><span class="p">)):</span>
                <span class="c1"># TODO RECTIFY WITH EXEC DOCTEST</span>
                <span class="n">testsrc</span> <span class="o">=</span> <span class="n">_cmd_modify_src</span><span class="p">(</span><span class="n">testsrc</span><span class="p">)</span>
            <span class="c1"># _exec_doctest(doctest_src)</span>
            <span class="c1"># doctest_src = ut.indent(testsrc, &#39;&gt;&gt;&gt; &#39;)</span>
            <span class="c1"># Add line numbers</span>
            <span class="n">doctest_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">number_text_lines</span><span class="p">(</span><span class="n">testsrc</span><span class="p">)</span>
            <span class="n">colored_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">doctest_src</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;testsrc = </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colored_src</span><span class="p">,))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">globals_</span><span class="p">)</span>  <span class="c1"># , locals_)</span>
            <span class="k">except</span> <span class="n">ExitTestException</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test exited before show&#39;</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">EXIT_SUCCESS</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished function test.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">EXIT_FAILURE</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Did not find any function named </span><span class="si">%r</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">util_inject</span><span class="o">.</span><span class="n">PROFILING</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">dump_profile_text</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...exiting&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">retcode</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_cmd_modify_src</span><span class="p">(</span><span class="n">testsrc</span><span class="p">):</span>
    <span class="c1"># testsrc = &#39;import IPython; import utool as ut; ut.qtensure()\n&#39; + testsrc</span>
    <span class="c1"># testsrc += &#39;\nimport IPython; IPython.embed()&#39;</span>
    <span class="c1"># testsrc += &#39;\nimport utool as ut; ut.embed()&#39;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">pline</span> <span class="o">=</span> <span class="s1">&#39;print(</span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt;&gt; &#39;</span><span class="p">))</span>
    <span class="n">testsrc</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">import utool as ut; &#39;</span> <span class="o">+</span> <span class="n">pline</span> <span class="o">+</span> <span class="s1">&#39;; ut.qtensure(); ut.embed()&#39;</span>
    <span class="c1"># testsrc += &#39;\nimport utool as ut; ut.qtensure(); ut.embed()&#39;</span>
    <span class="k">return</span> <span class="n">testsrc</span>


<div class="viewcode-block" id="execute_doctest"><a class="viewcode-back" href="../../utool.html#utool.util_tests.execute_doctest">[docs]</a><span class="k">def</span> <span class="nf">execute_doctest</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">testnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a function doctest. Can optionaly specify func name and module to</span>
<span class="sd">    run from ipython notebooks.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>

<span class="sd">    IPython:</span>
<span class="sd">        import utool as ut</span>
<span class="sd">        ut.execute_doctest(func=&#39;dummy_example_depcacahe&#39;, module=&#39;dtool.example_depcache&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">funcname</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">modname</span> <span class="o">=</span> <span class="n">module</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">_testno</span> <span class="o">=</span> <span class="n">find_testfunc</span><span class="p">(</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[]</span>
        <span class="p">)</span>
    <span class="c1"># TODO RECTIFY WITH EXEC DOCTEST</span>
    <span class="n">globals_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">testsrc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_doctest_examples</span><span class="p">(</span><span class="n">func</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">testnum</span><span class="p">]</span>
    <span class="c1"># colored_src = ut.highlight_code(ut.indent(testsrc, &#39;&gt;&gt;&gt; &#39;))</span>
    <span class="n">doctest_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s1">&#39;&gt;&gt;&gt; &#39;</span><span class="p">)</span>
    <span class="n">doctest_src</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s1">&#39;</span><span class="si">%3d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doctest_src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">colored_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">doctest_src</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;testsrc = </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colored_src</span><span class="p">,))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">globals_</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ExitTestException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test exited before show&#39;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -c &quot;import utool, utool.util_tests; utool.doctest_funcs(utool.util_tests)&quot;</span>
<span class="sd">        python -m utool.util_tests</span>
<span class="sd">        python -m utool.util_tests --allexamples</span>
<span class="sd">        python -m utool.util_tests</span>

<span class="sd">        python -c &quot;import utool; utool.doctest_funcs(module=utool.util_tests, needs_enable=False)&quot;</span>
<span class="sd">        /model/preproc/preproc_chip.py --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
    <span class="c1"># doctest_funcs()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">wbia-vtool</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../utool.html">utool package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../utool.html">utool</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>