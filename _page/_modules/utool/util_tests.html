

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>utool.util_tests &mdash; utool 1.1.2.dev1 documentation</title>















    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />





    <link rel="top" title="utool 1.1.2.dev1 documentation" href="../../index.html"/>
        <link rel="up" title="utool" href="../utool.html"/>


  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">


    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">



            <a href="../../index.html" class="icon icon-home"> utool



          </a>




              <div class="version">
                1.1.2.dev1
              </div>




<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">



                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../utool.html">utool package</a></li>
</ul>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">utool</a>
      </nav>



      <div class="wy-nav-content">
        <div class="rst-content">






<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>

          <li><a href="../index.html">Module code</a> &raquo;</li>

          <li><a href="../utool.html">utool</a> &raquo;</li>

    <li>utool.util_tests</li>
      <li class="wy-breadcrumbs-aside">



      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <h1>Source code for utool.util_tests</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Helpers for tests</span>

<span class="sd">This module contains a more sane reimplementation of doctest functionality.</span>
<span class="sd">(I.E.  asserts work and you don&#39;t have to worry about stdout mucking things up)</span>
<span class="sd">The code isn&#39;t super clean though due to time constriaints.  Many functions</span>
<span class="sd">probably belong elsewhere and the parsers need a big cleanup.</span>

<span class="sd">TODO:</span>
<span class="sd">    * report the line of the doctest in the file when reporting errors as well as</span>
<span class="sd">     the relative line</span>

<span class="sd">    * restructure so there is a test collection step, a filtering step, and an</span>
<span class="sd">      execution step</span>

<span class="sd">    * Fix finding tests when running with @profile</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="c">#from six.moves import builtins</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">traceback</span>  <span class="c"># NOQA</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_print</span>  <span class="c"># NOQA</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_arg</span>
<span class="c">#from utool import util_path</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_time</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_inject</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dbg</span>
<span class="kn">from</span> <span class="nn">utool</span> <span class="kn">import</span> <span class="n">util_dev</span>
<span class="kn">from</span> <span class="nn">utool._internal</span> <span class="kn">import</span> <span class="n">meta_util_six</span>
<span class="kn">from</span> <span class="nn">utool._internal.meta_util_six</span> <span class="kn">import</span> <span class="n">get_funcname</span>
<span class="k">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">util_inject</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;[tests]&#39;</span><span class="p">)</span>


<span class="n">VERBOSE_TEST</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--verbtest&#39;</span><span class="p">,</span> <span class="s">&#39;--verb-test&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose-test&#39;</span><span class="p">))</span>
<span class="c">#PRINT_SRC = not util_arg.get_argflag((&#39;--noprintsrc&#39;, &#39;--nosrc&#39;))</span>
<span class="n">DEBUG_SRC</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--nodbgsrc&#39;</span><span class="p">)</span>
<span class="n">PRINT_SRC</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--printsrc&#39;</span><span class="p">,</span> <span class="s">&#39;--src&#39;</span><span class="p">,</span> <span class="s">&#39;--show-src&#39;</span><span class="p">,</span> <span class="s">&#39;--showsrc&#39;</span><span class="p">),</span>
                                 <span class="n">help_</span><span class="o">=</span><span class="s">&#39;show docstring source when running tests&#39;</span><span class="p">)</span>
<span class="c">#PRINT_FACE = not util_arg.get_argflag((&#39;--noprintface&#39;, &#39;--noface&#39;))</span>
<span class="n">PRINT_FACE</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--printface&#39;</span><span class="p">,</span> <span class="s">&#39;--face&#39;</span><span class="p">))</span>
<span class="c">#BIGFACE = False</span>
<span class="n">BIGFACE</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--bigface&#39;</span><span class="p">)</span>
<span class="n">SYSEXIT_ON_FAIL</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--sysexitonfail&#39;</span><span class="p">,</span> <span class="s">&#39;--fastfail&#39;</span><span class="p">),</span>
                                       <span class="n">help_</span><span class="o">=</span><span class="s">&#39;Force testing harness to exit on first test failure&#39;</span><span class="p">)</span>
<span class="n">VERBOSE_TIMER</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--no-time-tests&#39;</span><span class="p">)</span>
<span class="n">INDENT_TEST</span>   <span class="o">=</span> <span class="bp">False</span>
<span class="c">#EXEC_MODE = util_arg.get_argflag(&#39;--exec-mode&#39;, help_=&#39;dummy flag that will be removed&#39;)</span>

<span class="n">ModuleDoctestTup</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;ModuleDoctestTup&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;enabled_testtup_list&#39;</span><span class="p">,</span>
                                                   <span class="s">&#39;frame_fpath&#39;</span><span class="p">,</span>
                                                   <span class="s">&#39;all_testflags&#39;</span><span class="p">,</span> <span class="s">&#39;module&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="TestTuple"><a class="viewcode-back" href="../../utool.html#utool.util_tests.TestTuple">[docs]</a><span class="k">class</span> <span class="nc">TestTuple</span><span class="p">(</span><span class="n">util_dev</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple container for test objects to replace old tuple format</span>
<span class="sd">    exec mode specifies if the test is being run as a script</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exec_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>  <span class="c"># function / class / testable name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">num</span>    <span class="c"># doctest index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>    <span class="c"># doctest src</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">want</span> <span class="o">=</span> <span class="n">want</span>  <span class="c"># doctest required result (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">flag</span>  <span class="c"># doctest commandline flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">frame_fpath</span>  <span class="c"># parent file fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec_mode</span> <span class="o">=</span> <span class="n">exec_mode</span>      <span class="c"># flags if running as script</span>

        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">src</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># hack to parse tag from source</span>
            <span class="n">tagline</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tagline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">tagline</span> <span class="o">=</span> <span class="n">tagline</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">tagline</span> <span class="o">=</span> <span class="n">tagline</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_DOCTEST&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">tagline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tagstr</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="n">tagstr</span>

    <span class="c">#def __repr__(self):</span>
    <span class="c">#    custom =</span>
    <span class="c">#    return &#39;&lt;%s%s at %s&gt;&#39; % (self.__class__.__name__, custom, hex(id(self)),)</span>

    <span class="c">#def __str__(self):</span>
    <span class="c">#    custom = &#39; &#39;  + self.name + &#39;:&#39; + str(self.num)</span>
    <span class="c">#    return &#39;&lt;%s%s&gt;&#39; % (self.__class__.__name__, custom,)</span>

<span class="c">##debug_decor = lambda func: func</span>

<span class="c">#if VERBOSE_TEST:</span>
<span class="c">#    from utool import util_decor</span>
<span class="c">#    #debug_decor = util_decor.indent_func</span>
<span class="c">#    #debug_decor = util_decor.tracefunc</span>

</div>
<span class="n">HAPPY_FACE_BIG</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">               .-&quot;&quot;&quot;&quot;&quot;&quot;-.</span>
<span class="s">             .&#39;          &#39;.</span>
<span class="s">            /   O      O   \</span>
<span class="s">           :                :</span>
<span class="s">           |                |</span>
<span class="s">           &#39;  ,          ,&#39; :</span>
<span class="s">            \  &#39;-......-&#39;  /</span>
<span class="s">             &#39;.          .&#39;</span>
<span class="s">               &#39;-......-&#39;</span>
<span class="s">                   &#39;&#39;&#39;</span>

<span class="n">SAD_FACE_BIG</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">               .-&quot;&quot;&quot;&quot;&quot;&quot;-.</span>
<span class="s">             .&#39;          &#39;.</span>
<span class="s">            /   O      O   \</span>
<span class="s">           :           `    :</span>
<span class="s">           |                |</span>
<span class="s">           :    .------.    :</span>
<span class="s">            \  &#39;        &#39;  /</span>
<span class="s">             &#39;.          .&#39;</span>
<span class="s">               &#39;-......-&#39;</span>
<span class="s">                  &#39;&#39;&#39;</span>

<span class="n">HAPPY_FACE_SMALL</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">     .&quot;&quot;&quot;.</span>
<span class="s">    | o o |</span>
<span class="s">    | \_/ |</span>
<span class="s">     &#39; = &#39;</span>
<span class="s">    &#39;&#39;&#39;</span>

<span class="n">SAD_FACE_SMALL</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">     .&quot;&quot;&quot;.</span>
<span class="s">    | . . |</span>
<span class="s">    |  ~  |</span>
<span class="s">     &#39; = &#39;</span>
<span class="s">    &#39;&#39;&#39;</span>

<span class="k">if</span> <span class="n">BIGFACE</span><span class="p">:</span>
    <span class="n">HAPPY_FACE</span> <span class="o">=</span> <span class="n">HAPPY_FACE_BIG</span>
    <span class="n">SAD_FACE</span> <span class="o">=</span> <span class="n">SAD_FACE_BIG</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">HAPPY_FACE</span> <span class="o">=</span> <span class="n">HAPPY_FACE_SMALL</span>
    <span class="c">#SAD_FACE = SAD_FACE_BIG</span>
    <span class="n">SAD_FACE</span> <span class="o">=</span> <span class="n">SAD_FACE_SMALL</span>


<div class="viewcode-block" id="get_package_testables"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_package_testables">[docs]</a><span class="k">def</span> <span class="nf">get_package_testables</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">tagkw</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    New command that should eventually be used intead of old stuff?</span>

<span class="sd">    Args:</span>
<span class="sd">        module_list (list): (default = None)</span>
<span class="sd">        test_flags (None): (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --exec-get_package_testables --show --mod ibeis</span>
<span class="sd">        python -m utool.util_tests --exec-get_package_testables --show --mod utool --tags SCRIPT</span>
<span class="sd">        python -m utool.util_tests --exec-get_package_testables --show --mod utool --tags ENABLE</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; has_any = ut.get_argval(&#39;--tags&#39;, type_=str, default=None)</span>
<span class="sd">        &gt;&gt;&gt; module = ut.get_argval(&#39;--mod&#39;, default=&#39;utool&#39;)</span>
<span class="sd">        &gt;&gt;&gt; test_tuples = get_package_testables(module, has_any=has_any)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.repr3(test_tuples)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; #print(ut.repr3(ut.list_getattr(test_tuples, &#39;tags&#39;)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">modname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">package_contents</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">module_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">modname_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">modname</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">test_tuples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
        <span class="n">old_testables</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_module_doctest_tup</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span>
                                                  <span class="n">needs_enable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                  <span class="n">allexamples</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">test_tuples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">old_testables</span><span class="o">.</span><span class="n">enabled_testtup_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tagkw</span><span class="p">:</span>
        <span class="n">tags_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_getattr</span><span class="p">(</span><span class="n">test_tuples</span><span class="p">,</span> <span class="s">&#39;tags&#39;</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">tags_list</span><span class="p">,</span> <span class="o">**</span><span class="n">tagkw</span><span class="p">)</span>
        <span class="n">test_tuples</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">test_tuples</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_tuples</span>

</div>
<div class="viewcode-block" id="test_jedistuff"><a class="viewcode-back" href="../../utool.html#utool.util_tests.test_jedistuff">[docs]</a><span class="k">def</span> <span class="nf">test_jedistuff</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">jedi</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        def spam(ibs, bar):</span>
<span class="sd">            r&quot;&quot;&quot;</span>
<span class="sd">            Args:</span>
<span class="sd">                ibs (ibeis.IBEISController): an object</span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="sd">            import jedi</span>
<span class="sd">            jedi.n</span>
<span class="sd">            x = &#39;&#39;</span>
<span class="sd">            x.l</span>
<span class="sd">            ibs.d</span>
<span class="sd">            bar.d</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="p">)</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">jedi</span><span class="o">.</span><span class="n">Script</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">script</span><span class="o">.</span><span class="n">completions</span><span class="p">()</span>
    <span class="c"># Find the variable type of argument</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">script</span> <span class="o">=</span> <span class="n">jedi</span><span class="o">.</span><span class="n">Script</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="n">completions</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">completions</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">goto_definitions</span><span class="p">()</span>

    <span class="bp">self</span> <span class="o">=</span> <span class="n">script</span> <span class="o">=</span> <span class="n">jedi</span><span class="o">.</span><span class="n">Script</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">goto_definitions</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="n">vardefs</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">goto_assignments</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="c"># foodef, = jedi.names(source)</span>
    <span class="c"># foomems = foodef.defined_names()</span>
    <span class="c"># xdef = foomems[2]</span>

</div>
<div class="viewcode-block" id="doctest_module_list"><a class="viewcode-back" href="../../utool.html#utool.util_tests.doctest_module_list">[docs]</a><span class="k">def</span> <span class="nf">doctest_module_list</span><span class="p">(</span><span class="n">module_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs many module tests</span>

<span class="sd">    Entry point for batch run</span>
<span class="sd">    Depth 0)</span>

<span class="sd">    Ignore:</span>
<span class="sd">        :&#39;&lt;,&#39;&gt;!sort -n -k 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">nPass_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nTotal_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_cmds_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">error_reports_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] Running doctests on module list&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="s">&#39;test_times.txt&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s"> --- begining doctest_module_list</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;[util_test] IOWarning&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">failed_doctest_fname</span> <span class="o">=</span> <span class="s">&#39;failed_doctests.txt&#39;</span>
    <span class="n">seen_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">failed_doctest_fname</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">-------</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_printable_timestamp</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;logfile (only present if logging) = </span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">util_logging</span><span class="o">.</span><span class="n">get_current_log_fpath</span><span class="p">(),))</span>
        <span class="n">testkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">allexamples</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">return_error_report</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
                <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_list</span><span class="p">,</span> <span class="n">error_report_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">(</span>
                    <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">seen_</span><span class="o">=</span><span class="n">seen_</span><span class="p">,</span> <span class="o">**</span><span class="n">testkw</span><span class="p">)</span>
                <span class="n">nPass_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nPass</span><span class="p">)</span>
                <span class="n">nTotal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nTotal</span><span class="p">)</span>
                <span class="n">failed_cmds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">failed_list</span><span class="p">)</span>
                <span class="n">error_reports_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">)</span>
                <span class="c"># Write failed tests to disk</span>
                <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">failed_list</span><span class="p">:</span>
                    <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">ellapsed</span>
        <span class="n">nPass</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nPass_list</span><span class="p">)</span>
        <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nTotal_list</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;PASSED </span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">))</span>

    <span class="n">failed_cmd_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">failed_cmds_list</span><span class="p">)</span>
    <span class="n">error_report_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">error_reports_list</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Printing </span><span class="si">%d</span><span class="s"> error reports&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">),))</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">error_report</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">=== Error Report </span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_report_list</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">error_report</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;--- Done printing error reports ----&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="s">&#39;test_times.txt&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s"> --- finished doctest_module_list total_time=</span><span class="si">%.3f</span><span class="s">s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_time</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;[util_test] IOWarning&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;+========&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;| FINISHED TESTING </span><span class="si">%d</span><span class="s"> MODULES&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">module_list</span><span class="p">),))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;| PASSED </span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;L========&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_cmd_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;FAILED TESTS:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed_cmd_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_cmd_list</span>

</div>
<div class="viewcode-block" id="doctest_funcs"><a class="viewcode-back" href="../../utool.html#utool.util_tests.doctest_funcs">[docs]</a><span class="k">def</span> <span class="nf">doctest_funcs</span><span class="p">(</span><span class="n">testable_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_flags</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">allexamples</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">needs_enable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">return_error_report</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">seen_</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point into utools main module doctest harness</span>
<span class="sd">    Imports a module and checks flags for the function to run</span>
<span class="sd">    Depth 1)</span>

<span class="sd">    Args:</span>
<span class="sd">        testable_list (list):</span>
<span class="sd">        check_flags (bool): Force checking of the --test- and --exec- flags</span>
<span class="sd">        module (None):</span>
<span class="sd">        allexamples (None):</span>
<span class="sd">        needs_enable (None):</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (nPass, nTotal, failed_cmd_list)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m ibeis.algo.preproc.preproc_chip --all-examples</span>

<span class="sd">    References:</span>
<span class="sd">        http://legacy.python.org/dev/peps/pep-0338/</span>
<span class="sd">        https://docs.python.org/2/library/runpy.html</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; testable_list = []</span>
<span class="sd">        &gt;&gt;&gt; check_flags = True</span>
<span class="sd">        &gt;&gt;&gt; module = None</span>
<span class="sd">        &gt;&gt;&gt; allexamples = None</span>
<span class="sd">        &gt;&gt;&gt; needs_enable = None</span>
<span class="sd">        &gt;&gt;&gt; # careful might infinitely recurse</span>
<span class="sd">        &gt;&gt;&gt; (nPass, nTotal) = doctest_funcs(testable_list, check_flags, module,</span>
<span class="sd">        ...                                 allexamples, needs_enable)</span>
<span class="sd">        &gt;&gt;&gt; print((nPass, nTotal))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">start_logging</span><span class="p">()</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c"># just in case</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] doctest_funcs&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">inject_colored_exceptions</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">VERBOSE_TEST</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test.doctest_funcs][DEPTH 1] doctest_funcs()&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test.doctest_funcs] Running doctest_funcs&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_developer</span><span class="p">():</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">change_term_title</span><span class="p">(</span><span class="s">&#39;DocTest &#39;</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>

    <span class="c"># PARSE OUT TESTABLE DOCTESTTUPS</span>
    <span class="n">mod_doctest_tup</span> <span class="o">=</span> <span class="n">get_module_doctest_tup</span><span class="p">(</span>
        <span class="n">testable_list</span><span class="p">,</span> <span class="n">check_flags</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">allexamples</span><span class="p">,</span> <span class="n">needs_enable</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">,</span> <span class="n">all_testflags</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="n">mod_doctest_tup</span>

    <span class="n">nPass</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nFail</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">)</span>

    <span class="c">#flags = [(tup.name, tup.num) in seen_ for tup in enabled_testtup_list]</span>
    <span class="k">if</span> <span class="n">seen_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="o">.</span><span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">]</span>
        <span class="n">enabled_testtup_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="c"># Remove duplicate tests from previous parts of the batch run</span>
    <span class="c">#print(sum(flags))</span>

    <span class="n">EARLYEXIT</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">seen_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">:</span>
            <span class="c">#seen_.add((tup.name, tup.num))</span>
            <span class="n">seen_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tup</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">EARLYEXIT</span><span class="p">:</span>
        <span class="n">nPass</span> <span class="o">=</span> <span class="n">nTotal</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_error_report</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
    <span class="n">nTotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">)</span>

    <span class="c"># Run enabled examles</span>
    <span class="n">failed_flag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">error_report_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--edit-test-file&#39;</span><span class="p">,</span> <span class="s">&#39;--etf&#39;</span><span class="p">)):</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">editfile</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
    <span class="n">exec_mode</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">testtup</span><span class="o">.</span><span class="n">exec_mode</span> <span class="k">for</span> <span class="n">testtup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">testtup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">name</span>
        <span class="n">num</span>  <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">num</span>
        <span class="n">src</span>  <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">src</span>
        <span class="n">want</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">want</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">flag</span>
        <span class="c">#if ut.is_developer():</span>
        <span class="c">#    ut.change_term_title(&#39;DocTest &#39; + modname + &#39; &#39; + name)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">fmtdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">modname</span><span class="o">=</span><span class="n">modname</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="c">#      1          v12     v20       v30       v40       v50         v62</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;+------------------------------------------------------------+&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;*  DOCTEST {modname:&lt;20} {name:&gt;26}:{num:d} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;+------------------------------------------------------------+&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PRINT_SRC</span> <span class="ow">or</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">msgblock</span><span class="p">(</span><span class="s">&#39;EXEC SRC&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span>
        <span class="c"># Commented because it caused differences between</span>
        <span class="c"># individual test runs and large test runs with ut</span>
        <span class="c"># being imported</span>
        <span class="c"># test_globals = module.__dict__.copy()</span>
        <span class="n">test_globals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">error_report</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">testkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="nb">globals</span><span class="o">=</span><span class="n">test_globals</span><span class="p">,</span>  <span class="c"># HACK</span>
                <span class="n">want</span><span class="o">=</span><span class="n">want</span><span class="p">,</span> <span class="n">return_error_report</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">testtup</span><span class="o">.</span><span class="n">frame_fpath</span> <span class="o">==</span> <span class="n">frame_fpath</span>
            <span class="n">test_locals</span><span class="p">,</span> <span class="n">error_report</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">run_test</span><span class="p">(</span><span class="n">testtup</span><span class="p">,</span> <span class="o">**</span><span class="n">testkw</span><span class="p">)</span>
            <span class="n">is_pass</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_locals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_pass</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;seems to pass&#39;</span><span class="p">)</span>
                <span class="n">nPass</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;raising failed exception&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;failed&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Seems to fail. &#39;</span><span class="p">)</span>
            <span class="n">nFail</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">failed_flag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">error_report_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_report</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strict</span> <span class="ow">or</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">SUPER_STRICT</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Silently Failing: &#39;</span>
                          <span class="s">&#39;maybe adding the --super-strict flag would help debug?&#39;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;L_____________________________________________________________&#39;</span><span class="p">)</span>
    <span class="c">#L__________________</span>
    <span class="c">#+-------------------</span>
    <span class="c"># Print Results</span>
    <span class="k">if</span> <span class="n">nTotal</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allexamples</span><span class="p">:</span>
        <span class="n">valid_test_argflags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--allexamples&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_testflags</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">codeblock</span><span class="p">(</span>
            <span class="sd">r&#39;&#39;&#39;</span>
<span class="sd">            No test flags sepcified</span>
<span class="sd">            Please choose one of the following flags or specify --enableall</span>
<span class="sd">            Valid test argflags:</span>
<span class="sd">            &#39;&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">valid_test_argflags</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span><span class="p">)</span>
        <span class="n">warning_msg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">,</span> <span class="s">&#39;[util_test.doctest_funcs]&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">,</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">exec_mode</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;+-------&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;| finished testing fpath=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame_fpath</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;| passed </span><span class="si">%d</span><span class="s"> / </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;L-------&#39;</span><span class="p">)</span>
    <span class="n">failed_cmd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">nFail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c">#modname = module.__name__</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
        <span class="c"># TODO: ensure that exename is in the PATH</span>
        <span class="n">exename</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
        <span class="n">failed_cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> -m </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exename</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">flag_</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">flag_</span> <span class="ow">in</span> <span class="n">failed_flag_list</span><span class="p">]</span>
        <span class="c">#failed_cmd_list = [&#39;python %s %s&#39; % (frame_fpath, flag_)</span>
        <span class="c">#                    for flag_ in failed_flag_list]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Failed sys.argv = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Failed Tests:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed_cmd_list</span><span class="p">))</span>
    <span class="c">#L__________________</span>
    <span class="k">if</span> <span class="n">return_error_report</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_cmd_list</span><span class="p">,</span> <span class="n">error_report_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nPass</span><span class="p">,</span> <span class="n">nTotal</span><span class="p">,</span> <span class="n">failed_cmd_list</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="run_test"><a class="viewcode-back" href="../../utool.html#utool.util_tests.run_test">[docs]</a><span class="k">def</span> <span class="nf">run_test</span><span class="p">(</span><span class="n">func_or_testtup</span><span class="p">,</span> <span class="n">return_error_report</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the test function with success / failure printing</span>

<span class="sd">    Args:</span>
<span class="sd">        func_or_testtup (func or tuple): function or doctest tuple</span>

<span class="sd">    Varargs/Kwargs:</span>
<span class="sd">        Anything that needs to be passed to &lt;func_&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="c">#func_is_testtup = isinstance(func_or_testtup, tuple)</span>
    <span class="c"># NOTE: isinstance is not gaurenteed not work here if ut.rrrr has been called</span>
    <span class="n">func_is_testtup</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_or_testtup</span><span class="p">,</span> <span class="n">TestTuple</span><span class="p">)</span>
    <span class="n">exec_mode</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">write_times</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">func_is_testtup</span><span class="p">:</span>
        <span class="n">testtup</span> <span class="o">=</span> <span class="n">func_or_testtup</span>
        <span class="n">src</span>         <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">src</span>
        <span class="n">funcname</span>    <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">name</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">frame_fpath</span>
        <span class="c">#(funcname, src, frame_fpath) = func_or_testtup</span>
        <span class="n">exec_mode</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">exec_mode</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func_</span> <span class="o">=</span> <span class="n">func_or_testtup</span>
        <span class="n">funcname</span> <span class="o">=</span> <span class="n">get_funcname</span><span class="p">(</span><span class="n">func_</span><span class="p">)</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcfpath</span><span class="p">(</span><span class="n">func_</span><span class="p">)</span>
    <span class="n">upper_funcname</span> <span class="o">=</span> <span class="n">funcname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">=============================&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;**[TEST.BEGIN] </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;**[TEST.BEGIN] </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,))</span>
    <span class="c">#print(&#39;  &lt;funcname&gt;  &#39;)</span>
    <span class="c">#print(&#39;  &lt;&#39; + funcname + &#39;&gt;  &#39;)</span>
    <span class="c">#short_funcname = ut.clipstr(funcname, 8)</span>
    <span class="c"># TODO: make the --exec- prefix specify this instead of --test-</span>
    <span class="n">verbose_timer</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">exec_mode</span> <span class="ow">and</span> <span class="n">VERBOSE_TIMER</span>
    <span class="n">nocheckwant</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">exec_mode</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="n">print_face</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">exec_mode</span> <span class="ow">and</span> <span class="n">PRINT_FACE</span>
    <span class="c">#indent_test = not exec_mode and INDENT_TEST</span>
    <span class="n">error_report</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c">#+----------------</span>
        <span class="c"># RUN THE TEST WITH A TIMER</span>
        <span class="k">with</span> <span class="n">util_time</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">upper_funcname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_timer</span><span class="p">)</span> <span class="k">as</span> <span class="n">timer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func_is_testtup</span><span class="p">:</span>
                <span class="n">test_locals</span> <span class="o">=</span> <span class="n">_exec_doctest</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">nocheckwant</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># TEST INPUT IS A LIVE PYTHON FUNCTION</span>
                <span class="n">test_locals</span> <span class="o">=</span> <span class="n">func_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c">#L________________</span>
        <span class="c">#+----------------</span>
        <span class="c"># LOG PASSING TEST</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exec_mode</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">=============================&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;**[TEST.FINISH] </span><span class="si">%s</span><span class="s"> -- SUCCESS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">print_face</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">HAPPY_FACE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_times</span><span class="p">:</span>
                <span class="n">timemsg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%.4f</span><span class="s">s in </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">timer</span><span class="o">.</span><span class="n">ellapsed</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="s">&#39;test_times.txt&#39;</span><span class="p">,</span> <span class="n">timemsg</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;[util_test] IOWarning&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c">#L________________</span>
        <span class="c"># RETURN VALID TEST LOCALS</span>
        <span class="k">if</span> <span class="n">return_error_report</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">test_locals</span><span class="p">,</span> <span class="n">error_report</span>
        <span class="k">return</span> <span class="n">test_locals</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
        <span class="c"># Get locals in the wrapped function</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">error_report_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;**[TEST.ERROR] </span><span class="si">%s</span><span class="s"> -- FAILED:</span><span class="se">\n</span><span class="s">    type(ex)=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">funcname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">))]</span>
        <span class="n">error_report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">formatex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="n">error_report_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">print_report</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">=============================&#39;</span><span class="p">)</span>
        <span class="n">print_report</span><span class="p">(</span><span class="s">&#39;**[TEST.FINISH] </span><span class="si">%s</span><span class="s"> -- FAILED:</span><span class="se">\n</span><span class="s">    type(ex)=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">PRINT_FACE</span><span class="p">:</span>
            <span class="n">print_report</span><span class="p">(</span><span class="n">SAD_FACE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func_is_testtup</span><span class="p">:</span>
            <span class="n">print_report</span><span class="p">(</span><span class="s">&#39;Failed in module: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">frame_fpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">DEBUG_SRC</span><span class="p">:</span>
                <span class="n">src_with_lineno</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">number_text_lines</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="n">print_report</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">msgblock</span><span class="p">(</span><span class="s">&#39;FAILED DOCTEST IN </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">funcname</span><span class="p">,),</span> <span class="n">src_with_lineno</span><span class="p">))</span>
            <span class="c">#ut.embed()</span>

            <span class="c">#print(&#39;\n... test error. sys.exit(1)\n&#39;)</span>
            <span class="c">#sys.exit(1)</span>
            <span class="c">#failed_execline = traceback.format_tb(tb)[-1]</span>
            <span class="c">#parse_str = &#39;File {fname}, line {lineno}, in {modname}&#39;</span>
            <span class="c">#parse_dict = parse.parse(&#39;{prefix_}&#39; + parse_str + &#39;{suffix_}&#39;, failed_execline)</span>
            <span class="c">#if parse_dict[&#39;fname&#39;] == &#39;&lt;string&gt;&#39;:</span>
            <span class="c">#    lineno = int(parse_dict[&#39;lineno&#39;])</span>
            <span class="c">#    failed_line = src.splitlines()[lineno - 1]</span>
            <span class="c">#    print(&#39;Failed on line: %s&#39; % failed_line)</span>
        <span class="k">if</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">SUPER_STRICT</span><span class="p">:</span>
            <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">func_is_testtup</span><span class="p">:</span>
                <span class="c"># Remove this function from stack strace</span>
                <span class="c"># dont do this for execed code</span>
                <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">exc_traceback</span><span class="o">.</span><span class="n">tb_next</span>
            <span class="c"># Python 2*3=6</span>
            <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
                <span class="c"># FIXME: use common code</span>
                <span class="n">six</span><span class="o">.</span><span class="n">reraise</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">## PYTHON 2.7 DEPRICATED:</span>
                <span class="c">#if six.PY2:</span>
                <span class="c">#    raise exc_type, exc_value, exc_traceback.tb_next</span>
                <span class="c">#    #exec (&#39;raise exc_type, exc_value,</span>
                <span class="c">#    exc_traceback.tb_next&#39;, globals(), locals())</span>
                <span class="c">## PYTHON 3.3 NEW METHODS</span>
                <span class="c">#elif six.PY3:</span>
                <span class="c">#    ex = exc_type(exc_value)</span>
                <span class="c">#    ex.__traceback__ = exc_traceback.tb_next</span>
                <span class="c">#    raise ex</span>
                <span class="c">#else:</span>
                <span class="c">#    raise AssertionError(&#39;Weird python version&#39;)</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">SYSEXIT_ON_FAIL</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] SYSEXIT_ON_FAIL = True&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] exiting with sys.exit(1)&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c">#raise</span>
        <span class="k">if</span> <span class="n">return_error_report</span><span class="p">:</span>
            <span class="n">error_report</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error_report_lines</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">error_report</span>

</div>
<span class="k">def</span> <span class="nf">_exec_doctest</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">nocheckwant</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper for run_test</span>

<span class="sd">    block of code that r:uns doctest and was too big to be in run_test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TEST INPUT IS PYTHON CODE TEXT</span>
    <span class="c">#test_locals = {}</span>
    <span class="n">test_globals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;globals&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">want</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;want&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c">#test_globals[&#39;print&#39;] = doctest_print</span>
    <span class="c"># EXEC FUNC</span>
    <span class="c">#six.exec_(src, test_globals, test_locals)  # adds stack to debug trace</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--cmd&#39;</span><span class="p">,</span> <span class="s">&#39;--embed&#39;</span><span class="p">)):</span>
        <span class="n">src</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">import utool as ut; ut.embed()&#39;</span>  <span class="c"># TODO RECTIFY WITH TF</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># IN EXEC CONTEXT THERE IS NO DIFF BETWEEN LOCAL / GLOBALS.  ONLY PASS</span>
        <span class="c"># IN ONE DICT. OTHERWISE TREATED ODDLY</span>
        <span class="c"># References: https://bugs.python.org/issue13557</span>
        <span class="c">#exec(code, test_globals, test_locals)</span>
        <span class="n">test_locals</span> <span class="o">=</span> <span class="n">test_globals</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">test_globals</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ExitTestException</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Test exited before show&#39;</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">nocheckwant</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">nocheckwant</span> <span class="o">=</span> <span class="n">util_arg</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--no-checkwant&#39;</span><span class="p">,</span> <span class="n">help_</span><span class="o">=</span><span class="s">&#39;Turns off checking for results&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nocheckwant</span> <span class="ow">or</span> <span class="n">want</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">want</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nocheckwant</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;warning test does not want anything&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">want</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">want</span> <span class="o">=</span> <span class="n">want</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">test_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">,</span> <span class="s">&#39;NO VARIABLE NAMED result&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">want</span><span class="p">:</span>
            <span class="n">errmsg1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
                <span class="n">difftext</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_textdiff</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">util_dbg</span><span class="o">.</span><span class="n">COLORED_EXCEPTIONS</span><span class="p">:</span>
                    <span class="n">difftext</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_colored_diff</span><span class="p">(</span><span class="n">difftext</span><span class="p">)</span>
                <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;DIFF/GOT/EXPECTED</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">difftext</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">STRICT</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;REPR_GOT: result=</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">))</span>
                <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;REPR_EXPECTED: want=</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">want</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                    <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;REPR_GOT: result=</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">))</span>
                    <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;REPR_EXPECTED: want=</span><span class="se">\n</span><span class="si">%r</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">want</span><span class="p">))</span>
            <span class="n">errmsg1</span> <span class="o">+=</span> <span class="s">&#39;&#39;</span>
            <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;STR_GOT: result=</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="n">errmsg1</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;STR_EXPECTED: want=</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">want</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;result != want</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">errmsg1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">test_locals</span>


<div class="viewcode-block" id="get_module_testlines"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_module_testlines">[docs]</a><span class="k">def</span> <span class="nf">get_module_testlines</span><span class="p">(</span><span class="n">module_list</span><span class="p">,</span> <span class="n">remove_pyc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                         <span class="n">pythoncmd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds test commands for autogen tests</span>
<span class="sd">    called by autogen test scripts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="k">if</span> <span class="n">pythoncmd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pythoncmd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
        <span class="c">#&#39;python&#39;</span>
    <span class="n">testcmd_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
        <span class="n">mod_doctest_tup</span> <span class="o">=</span> <span class="n">get_module_doctest_tup</span><span class="p">(</span>
            <span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">allexamples</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">,</span> <span class="n">all_testflags</span><span class="p">,</span> <span class="n">module_</span> <span class="o">=</span> <span class="n">mod_doctest_tup</span>
        <span class="k">for</span> <span class="n">testtup</span> <span class="ow">in</span> <span class="n">enabled_testtup_list</span><span class="p">:</span>
            <span class="c">#testflag = testtup[-1]</span>
            <span class="n">testflag</span> <span class="o">=</span> <span class="n">testtup</span><span class="o">.</span><span class="n">flag</span>
            <span class="k">if</span> <span class="n">remove_pyc</span><span class="p">:</span>
                <span class="c"># FIXME python 3 __pycache__/*.pyc</span>
                <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">frame_fpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.pyc&#39;</span><span class="p">,</span> <span class="s">&#39;.py&#39;</span><span class="p">)</span>
            <span class="n">frame_rel_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_relative_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
            <span class="n">testcmd</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">pythoncmd</span><span class="p">,</span> <span class="n">frame_rel_fpath</span><span class="p">,</span> <span class="n">testflag</span><span class="p">))</span>
            <span class="n">testcmd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testcmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">testcmd_list</span>

</div>
<div class="viewcode-block" id="parse_docblocks_from_docstr"><a class="viewcode-back" href="../../utool.html#utool.util_tests.parse_docblocks_from_docstr">[docs]</a><span class="k">def</span> <span class="nf">parse_docblocks_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse_docblocks_from_docstr</span>
<span class="sd">    Depth 5)</span>
<span class="sd">    called by parse_doctest_from_docstr</span>
<span class="sd">    TODO: move to util_inspect</span>

<span class="sd">    Args:</span>
<span class="sd">        docstr (str):</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: docstr_blocks tuples</span>
<span class="sd">            [(blockname, blockstr, offset)]</span>


<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; #import ibeis</span>
<span class="sd">        &gt;&gt;&gt; #import ibeis.algo.hots.query_request</span>
<span class="sd">        &gt;&gt;&gt; #func_or_class = ibeis.algo.hots.query_request.QueryParams</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.parse_docblocks_from_docstr</span>
<span class="sd">        &gt;&gt;&gt; docstr = ut.get_docstr(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; docstr_blocks = parse_docblocks_from_docstr(docstr)</span>
<span class="sd">        &gt;&gt;&gt; result = str(docstr_blocks)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># FIXME Requires tags to be separated by two spaces</span>
    <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="kn">import</span> <span class="nn">parse</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="kn">import</span> <span class="nn">itertools</span>
    <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_unicode</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
    <span class="n">initial_docblocks</span> <span class="o">=</span> <span class="n">docstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">docblock_len_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">str_</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">str_</span> <span class="ow">in</span> <span class="n">initial_docblocks</span><span class="p">]</span>
    <span class="n">offset_iter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">ut</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">docblock_len_list</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">initial_line_offsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">offset</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">offset_iter</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;__________&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;__Initial Docblocks__&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">---</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">initial_docblocks</span><span class="p">))</span>
    <span class="n">docstr_blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">initial_docblocks</span><span class="p">,</span> <span class="n">initial_line_offsets</span><span class="p">):</span>
        <span class="n">docblock</span> <span class="o">=</span> <span class="n">docblock</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_indentation</span><span class="p">(</span><span class="n">docblock</span><span class="p">)</span>
        <span class="n">parse_result</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;{tag}:</span><span class="se">\n</span><span class="s">{rest}&#39;</span><span class="p">,</span> <span class="n">docblock</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">parse_result</span><span class="p">[</span><span class="s">&#39;tag&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">docstr_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">))</span>
    <span class="c">#print(docstr_blocks)</span>

    <span class="n">docblock_headers</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">docstr_blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">docblock_bodys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">docstr_blocks</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">docblock_offsets</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">docstr_blocks</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test]   * found </span><span class="si">%d</span><span class="s"> docstr_blocks&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">docstr_blocks</span><span class="p">),))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test]   * docblock_headers = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">docblock_headers</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test]   * docblock_offsets = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">docblock_offsets</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test]  * docblock_bodys:&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">-=-</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docblock_bodys</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">docstr_blocks</span>

</div>
<div class="viewcode-block" id="read_exampleblock"><a class="viewcode-back" href="../../utool.html#utool.util_tests.read_exampleblock">[docs]</a><span class="k">def</span> <span class="nf">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">nonheader_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docblock</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">nonheader_lines</span> <span class="o">=</span> <span class="n">nonheader_src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">reversed_src_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reversed_want_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">finished_want</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Read the example block backwards to get the want string</span>
    <span class="c"># and then the rest should all be source</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">nonheader_lines</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">finished_want</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&gt;&gt;&gt; &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;... &#39;</span><span class="p">):</span>
                <span class="n">finished_want</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reversed_want_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">reversed_src_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">test_src</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reversed_src_lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">test_want</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reversed_want_lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">test_src</span><span class="p">,</span> <span class="n">test_want</span>

</div>
<div class="viewcode-block" id="parse_doctest_from_docstr"><a class="viewcode-back" href="../../utool.html#utool.util_tests.parse_doctest_from_docstr">[docs]</a><span class="k">def</span> <span class="nf">parse_doctest_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    because doctest itself doesnt do what I want it to do</span>
<span class="sd">    called by get_doctest_examples</span>
<span class="sd">    Depth 4)</span>

<span class="sd">    CAREFUL, IF YOU GET BACK WRONG RESULTS MAKE SURE YOUR DOCSTR IS PREFFIXED</span>
<span class="sd">    WITH R</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --exec-parse_doctest_from_docstr</span>

<span class="sd">    Setup:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; #from ibeis.algo.hots import score_normalization</span>
<span class="sd">        &gt;&gt;&gt; #func_or_class = score_normalization.cached_ibeis_score_normalizer</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = parse_doctest_from_docstr</span>
<span class="sd">        &gt;&gt;&gt; docstr = ut.get_docstr(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;\n\n&#39;.join(testsrc_list))</span>
<span class="sd">        &gt;&gt;&gt; assert len(testsrc_list) == len(testwant_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">docstr_blocks</span> <span class="o">=</span> <span class="n">parse_docblocks_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>

    <span class="n">example_docblocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">example_setups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">param_grids</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span> <span class="ow">in</span> <span class="n">docstr_blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Example&#39;</span><span class="p">):</span>
            <span class="n">example_docblocks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Setup&#39;</span><span class="p">):</span>
            <span class="n">setup_src</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">example_setups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setup_src</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ParamGrid&#39;</span><span class="p">):</span>
            <span class="n">paramgrid_src</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">globals_</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">six</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="s">&#39;import utool as ut</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">paramgrid_src</span><span class="p">,</span> <span class="n">globals_</span><span class="p">)</span>
            <span class="k">assert</span> <span class="s">&#39;combos&#39;</span> <span class="ow">in</span> <span class="n">globals_</span><span class="p">,</span> <span class="s">&#39;param grid must define combos&#39;</span>
            <span class="n">combos</span> <span class="o">=</span> <span class="n">globals_</span><span class="p">[</span><span class="s">&#39;combos&#39;</span><span class="p">]</span>
            <span class="n">param_grids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">execstr_dict</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">]</span>

    <span class="n">testheader_list</span>     <span class="o">=</span> <span class="p">[]</span>
    <span class="n">testsrc_list</span>        <span class="o">=</span> <span class="p">[]</span>
    <span class="n">testwant_list</span>       <span class="o">=</span> <span class="p">[]</span>
    <span class="n">testlineoffset_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">docblock</span><span class="p">,</span> <span class="n">line_offset</span> <span class="ow">in</span> <span class="n">example_docblocks</span><span class="p">:</span>
        <span class="n">test_src</span><span class="p">,</span> <span class="n">test_want</span> <span class="o">=</span> <span class="n">read_exampleblock</span><span class="p">(</span><span class="n">docblock</span><span class="p">)</span>
        <span class="n">testheader_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">testsrc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_src</span><span class="p">)</span>
        <span class="n">testwant_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_want</span><span class="p">)</span>
        <span class="n">testlineoffset_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_offset</span><span class="p">)</span>
        <span class="c">#print(&#39;Parsed header=%r&#39; % header)</span>
        <span class="c">#print(&#39;Parsed src=%r&#39; % test_src)</span>

    <span class="c"># Hack: append setups to all sources</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_setups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;cant have more than 1 setup&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">example_setups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param_grids</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">testsrc_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">example_setups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="p">])</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span>  <span class="n">testsrc_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Implmentation to put all pgrids in the same test</span>
            <span class="n">testsrc_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">example_setups</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span>
                <span class="p">[</span>
                    <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">pgrid</span><span class="p">,</span>
                            <span class="s">&#39;print(</span><span class="se">\&#39;</span><span class="s">Grid </span><span class="si">%d</span><span class="se">\&#39;</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,),</span>
                            <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;ut.show_if_requested()&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>  <span class="c"># Megahack</span>
                            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span>
                            <span class="n">src</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">pgrid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_grids</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">testsrc_list</span><span class="p">]</span>
            <span class="c">#testsrc_list = [&#39;\n&#39;.join([example_setups[0], pgrid, src]) for pgrid in param_grids for src in  testsrc_list]</span>
            <span class="c"># implementation to make a different test for each pgrid</span>
            <span class="c">#testsrc_list = [&#39;\n&#39;.join([example_setups[0], pgrid, src]) for pgrid in param_grids for src in  testsrc_list]</span>
            <span class="c">#testheader_list = [head for pgrid in param_grids for head in testheader_list]</span>
            <span class="c">#testwant_list = [tw for pgrid in param_grids for tw in testwant_list]</span>
            <span class="c">#testwant_list = [lo for pgrid in param_grids for lo in testlineoffset_list]</span>

    <span class="k">return</span> <span class="n">testheader_list</span><span class="p">,</span> <span class="n">testsrc_list</span><span class="p">,</span> <span class="n">testwant_list</span><span class="p">,</span> <span class="n">testlineoffset_list</span>


<span class="c">#@debug_decor</span></div>
<div class="viewcode-block" id="get_doctest_examples"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_doctest_examples">[docs]</a><span class="k">def</span> <span class="nf">get_doctest_examples</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get_doctest_examples</span>

<span class="sd">    Depth 3)</span>
<span class="sd">    called by get_module_doctest_tup</span>

<span class="sd">    Args:</span>
<span class="sd">        func_or_class (function)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple (list, list): example_list, want_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --test-get_doctest_examples</span>

<span class="sd">    Example0:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = get_doctest_examples</span>
<span class="sd">        &gt;&gt;&gt; tup  = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = tup</span>
<span class="sd">        &gt;&gt;&gt; result = str(len(testsrc_list) + len(testwant_list))</span>
<span class="sd">        &gt;&gt;&gt; print(testsrc_list)</span>
<span class="sd">        &gt;&gt;&gt; print(testlinenum_list)</span>
<span class="sd">        &gt;&gt;&gt; print(func_lineno)</span>
<span class="sd">        &gt;&gt;&gt; print(testwant_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        6</span>

<span class="sd">    Example1:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ut.tryimport</span>
<span class="sd">        &gt;&gt;&gt; tup = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = tup</span>
<span class="sd">        &gt;&gt;&gt; result = str(len(testsrc_list) + len(testwant_list))</span>
<span class="sd">        &gt;&gt;&gt; print(testsrc_list)</span>
<span class="sd">        &gt;&gt;&gt; print(testlinenum_list)</span>
<span class="sd">        &gt;&gt;&gt; print(func_lineno)</span>
<span class="sd">        &gt;&gt;&gt; print(testwant_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        4</span>

<span class="sd">    Example2:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import ibeis</span>
<span class="sd">        &gt;&gt;&gt; func_or_class = ibeis.control.manual_annot_funcs.add_annots</span>
<span class="sd">        &gt;&gt;&gt; tup = get_doctest_examples(func_or_class)</span>
<span class="sd">        &gt;&gt;&gt; testsrc_list, testwant_list, testlinenum_list, func_lineno, docstr = tup</span>
<span class="sd">        &gt;&gt;&gt; result = str(len(testsrc_list) + len(testwant_list))</span>
<span class="sd">        &gt;&gt;&gt; print(testsrc_list)</span>
<span class="sd">        &gt;&gt;&gt; print(testlinenum_list)</span>
<span class="sd">        &gt;&gt;&gt; print(func_lineno)</span>
<span class="sd">        &gt;&gt;&gt; print(testwant_list)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
        <span class="n">func_or_class</span> <span class="o">=</span> <span class="n">func_or_class</span><span class="o">.</span><span class="n">__func__</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test][DEPTH 3] get_doctest_examples()&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] + parsing </span><span class="si">%r</span><span class="s"> for doctest&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_or_class</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] - name = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func_or_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">,))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">,</span> <span class="s">&#39;__ut_parent_class__&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] - __ut_parent_class__ = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">func_or_class</span><span class="o">.</span><span class="n">__ut_parent_class__</span><span class="p">,))</span>
        <span class="c">#ut.embed()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;FIXME&#39;</span><span class="p">)</span>
        <span class="c">#func_or_class._utinfo[&#39;orig_func&#39;]</span>
        <span class="n">func_lineno</span> <span class="o">=</span> <span class="n">func_or_class</span><span class="o">.</span><span class="n">func_code</span><span class="o">.</span><span class="n">co_firstlineno</span>
        <span class="c"># FIXME: doesn&#39;t handle decorators well</span>
        <span class="c">#</span>
        <span class="c"># ~~FIXME doesn&#39;t account for multiline function definitions</span>
        <span class="c"># actually parse this out~~</span>
        <span class="c"># TODO: rectify with util_insepct get_funcsource with stip def line</span>
        <span class="n">sourcecode</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">regex_get_match</span><span class="p">(</span><span class="s">&#39;def [^)]*</span><span class="se">\\</span><span class="s">):</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">sourcecode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">num_funcdef_lines</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_funcdef_lines</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">func_lineno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_funcdef_lines</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">DEBUG2</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s">&#39;[util-test] error getting function line number&#39;</span><span class="p">)</span>

    <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_docstr</span><span class="p">(</span><span class="n">func_or_class</span><span class="p">)</span>
    <span class="c"># Cache because my janky parser is slow</span>
    <span class="c">#with ut.GlobalShelfContext(&#39;utool&#39;) as shelf:</span>
    <span class="c">#    if False and docstr in shelf:</span>
    <span class="c">#        testsrc_list, testwant_list = shelf[docstr]</span>
    <span class="c">#    else:</span>
    <span class="p">(</span><span class="n">testheader_list</span><span class="p">,</span> <span class="n">testsrc_list</span><span class="p">,</span> <span class="n">testwant_list</span><span class="p">,</span>
     <span class="n">testlineoffset_list</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_doctest_from_docstr</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
    <span class="n">testlinenum_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">func_lineno</span> <span class="o">+</span> <span class="n">num_funcdef_lines</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">testlineoffset_list</span>
    <span class="p">]</span>
    <span class="c">#       shelf[docstr] = testsrc_list, testwant_list</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test] L found </span><span class="si">%d</span><span class="s"> doctests&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">testsrc_list</span><span class="p">),))</span>
    <span class="k">return</span> <span class="n">testsrc_list</span><span class="p">,</span> <span class="n">testwant_list</span><span class="p">,</span> <span class="n">testlinenum_list</span><span class="p">,</span> <span class="n">func_lineno</span><span class="p">,</span> <span class="n">docstr</span>
    <span class="c"># doctest doesnt do what i want. so I wrote my own primative but effective</span>
    <span class="c"># parser.</span>

</div>
<div class="viewcode-block" id="get_module_doctest_tup"><a class="viewcode-back" href="../../utool.html#utool.util_tests.get_module_doctest_tup">[docs]</a><span class="k">def</span> <span class="nf">get_module_doctest_tup</span><span class="p">(</span><span class="n">testable_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_flags</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">allexamples</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">needs_enable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">testslow</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses module for testable doctesttups</span>
<span class="sd">    Depth 2)</span>

<span class="sd">    Args:</span>
<span class="sd">        testable_list (list): a list of functions (default = None)</span>
<span class="sd">        check_flags (bool): (default = True)</span>
<span class="sd">        module (None): (default = None)</span>
<span class="sd">        allexamples (None): (default = None)</span>
<span class="sd">        needs_enable (None): (default = None)</span>
<span class="sd">        N (int): (default = 0)</span>
<span class="sd">        verbose (bool):  verbosity flag(default = True)</span>
<span class="sd">        testslow (bool): (default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ModuleDoctestTup : (enabled_testtup_list, frame_fpath, all_testflags, module)</span>
<span class="sd">            enabled_testtup_list (list): a list of testtup</span>
<span class="sd">                testtup (tuple): (name, num, src, want, flag) describes a valid doctest in the module</span>
<span class="sd">                    name  (str): test name</span>
<span class="sd">                    num   (str): test number of the module / function / class / method</span>
<span class="sd">                    src   (str): test source code</span>
<span class="sd">                    want  (str): expected test result</span>
<span class="sd">                    flag  (str): a valid commandline flag to enable this test</span>
<span class="sd">            frame_fpath (str):</span>
<span class="sd">                module fpath that will be tested</span>
<span class="sd">            module (module):</span>
<span class="sd">                the actual module that will be tested</span>
<span class="sd">            all_testflags (list):</span>
<span class="sd">                the command line arguments that will enable different tests</span>
<span class="sd">            exclude_inherited (bool): does not included tests defined in other modules</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m utool.util_tests --exec-get_module_doctest_tup</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import utool as ut</span>
<span class="sd">        &gt;&gt;&gt; #testable_list = [ut.util_import.package_contents]</span>
<span class="sd">        &gt;&gt;&gt; testable_list = None</span>
<span class="sd">        &gt;&gt;&gt; check_flags = False</span>
<span class="sd">        &gt;&gt;&gt; module = ut.util_cplat</span>
<span class="sd">        &gt;&gt;&gt; allexamples = False</span>
<span class="sd">        &gt;&gt;&gt; needs_enable = None</span>
<span class="sd">        &gt;&gt;&gt; N = 0</span>
<span class="sd">        &gt;&gt;&gt; verbose = True</span>
<span class="sd">        &gt;&gt;&gt; testslow = False</span>
<span class="sd">        &gt;&gt;&gt; mod_doctest_tup = get_module_doctest_tup(testable_list, check_flags, module, allexamples, needs_enable, N, verbose, testslow)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;mod_doctest_tup = %s&#39; % (ut.list_str(mod_doctest_tup, nl=4),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#+------------------------</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[util_test.get_module_doctest tup][DEPTH 2] get_module_doctest tup()&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="k">if</span> <span class="n">needs_enable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">needs_enable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--enableall&#39;</span><span class="p">)</span>
        <span class="c">#needs_enable = True</span>
    <span class="n">TEST_ALL_EXAMPLES</span> <span class="o">=</span> <span class="n">allexamples</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--allexamples&#39;</span><span class="p">,</span> <span class="s">&#39;--all-examples&#39;</span><span class="p">))</span>
    <span class="n">parse_testables</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">force_enable_testnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">testable_list</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
        <span class="c"># hack</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">testable_list</span>
        <span class="n">testable_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testable_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">testable_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">testable_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">testable_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testable_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">testable_list</span><span class="p">]</span>
        <span class="n">parse_testables</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#L________________________</span>
    <span class="c">#+------------------------</span>
    <span class="c"># GET_MODULE_DOCTEST_TUP Step 1:</span>
    <span class="c"># Inspect caller module for testable names</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="s">&#39;???&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_caller_stack_frame</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
            <span class="n">main_modname</span> <span class="o">=</span> <span class="s">&#39;__main__&#39;</span>
            <span class="n">frame_name</span>  <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="s">&#39;__name__&#39;</span><span class="p">]</span>
            <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="s">&#39;__file__&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_name</span> <span class="o">==</span> <span class="n">main_modname</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">main_modname</span><span class="p">]</span>
                <span class="n">entry_modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
                <span class="c">#ut.embed()</span>
                <span class="k">if</span> <span class="n">entry_modname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;kernprof&#39;</span><span class="p">,</span> <span class="s">&#39;kernprof-script&#39;</span><span class="p">]:</span>
                    <span class="c"># kernprof clobbers the __main__ variable.</span>
                    <span class="c"># workaround by reimporting the module name</span>
                    <span class="kn">import</span> <span class="nn">importlib</span>
                    <span class="n">modname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">(</span><span class="n">frame_fpath</span><span class="p">)</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;frame&#39;</span><span class="p">,</span> <span class="s">&#39;module&#39;</span><span class="p">])</span>
            <span class="k">raise</span>
        <span class="n">allexamples</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frame_fpath</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__file__</span>
        <span class="n">allexamples</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c">#L________________________</span>

    <span class="c">#+------------------------</span>
    <span class="c"># GET_MODULE_DOCTEST_TUP Step 2:</span>
    <span class="c"># --- PARSE TESTABLE FUNCTIONS ---</span>
    <span class="c"># FIXME:</span>
    <span class="c"># BUG: We need to verify that this function actually belongs to this</span>
    <span class="c"># module. In util_type ndarray is imported and we try to parse it</span>

    <span class="c"># Get testable functions</span>
    <span class="k">if</span> <span class="n">parse_testables</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">VERBOSE_TEST</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ut.test] Iterating over module funcs&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ut.test] module =</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,))</span>

            <span class="n">_testableiter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">iter_module_doctestable</span><span class="p">(</span><span class="n">module</span><span class="p">,</span>
                                                       <span class="n">include_inherited</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                <span class="n">_testableiter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_testableiter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_testableiter</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
                    <span class="n">docstr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">__func__</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">docstr</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">docstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_unicode</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">docstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Example&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">testable_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">testable_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span> <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">NOT_QUIET</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">docstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Example&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ut.test] Ignoring (disabled) : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;[ut.test] Ignoring (no Example) : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;FAILED&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;frame&#39;</span><span class="p">])</span>
            <span class="k">raise</span>

    <span class="c"># OUTPUTS: testable_list</span>
    <span class="c">#L________________________</span>
    <span class="c">#+------------------------</span>
    <span class="c"># GET_MODULE_DOCTEST_TUP Step 3:</span>
    <span class="c"># --- FILTER TESTABLES_---</span>

    <span class="c"># Get testable function examples</span>

    <span class="n">test_sentinals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;ENABLE_DOCTEST&#39;</span><span class="p">,</span>
        <span class="c">#&#39;ENABLE_TEST&#39;,</span>
        <span class="c">#&#39;ENABLE_DOCTEST&#39;,</span>
        <span class="c">#&#39;ENABLE_UTOOL_DOCTEST&#39;,</span>
        <span class="c">#&#39;UTOOL_TEST&#39;,</span>
        <span class="c">#&#39;UTOOLTEST&#39;</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">testslow</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--testall&#39;</span><span class="p">,</span> <span class="s">&#39;--testslow&#39;</span><span class="p">,</span> <span class="s">&#39;--test-slow&#39;</span><span class="p">)):</span>
        <span class="n">test_sentinals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;SLOW_DOCTEST&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testslow</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--testall&#39;</span><span class="p">,</span> <span class="s">&#39;--testunstable&#39;</span><span class="p">)):</span>
        <span class="n">test_sentinals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;UNSTABLE_DOCTEST&#39;</span><span class="p">)</span>

    <span class="c">#conditional_sentinals = [  # TODO</span>
        <span class="c">#&#39;ENABLE_IF&#39;</span>
    <span class="c">#]</span>

    <span class="c"># FIND THE TEST NAMES REQUESTED</span>
    <span class="c"># Grab sys.argv enabled tests</span>
    <span class="n">valid_prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--exec-&#39;</span><span class="p">,</span> <span class="s">&#39;--test-&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">valid_prefix_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">testname</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">force_enable_testnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
                <span class="c"># TODO: parse out requested number up here</span>
                <span class="k">break</span>
    <span class="c">#print(force_enable_testnames)</span>
    <span class="k">def</span> <span class="nf">_get_testable_name</span><span class="p">(</span><span class="n">testable</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">testable</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
            <span class="n">testable</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">__func__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">testable_name</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">func_name</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">testable_name</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex2</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex1</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">testable</span><span class="p">)))</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex2</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">testable</span><span class="p">)))</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">testable_name</span>

    <span class="n">sorted_testable</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">testable_list</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="n">_get_testable_name</span><span class="p">)</span>
    <span class="c"># Append each testable example</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Vars:&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * needs_enable = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">needs_enable</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * force_enable_testnames = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">force_enable_testnames</span><span class="p">,))</span>
        <span class="n">indenter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[CHECK_EX]&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;len(sorted_testable) = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_testable</span><span class="p">),))</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c"># PARSE OUT THE AVAILABLE TESTS FOR EACH REQUEST</span>
    <span class="n">local_testtup_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">testable</span> <span class="ow">in</span> <span class="n">sorted_testable</span><span class="p">:</span>
        <span class="n">testname</span> <span class="o">=</span> <span class="n">_get_testable_name</span><span class="p">(</span><span class="n">testable</span><span class="p">)</span>
        <span class="n">testname2</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">testable</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
            <span class="n">testable</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">__func__</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">testable</span><span class="p">,</span> <span class="s">&#39;__ut_parent_class__&#39;</span><span class="p">):</span>
            <span class="c"># HACK for getting classname.funcname</span>
            <span class="n">testname2</span> <span class="o">=</span> <span class="n">testable</span><span class="o">.</span><span class="n">__ut_parent_class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">testname</span>
            <span class="c">#print(&#39;TESTNAME2&#39;)</span>
            <span class="c">#print(&#39;testname2 = %r&#39; % (testname2,))</span>
        <span class="n">examples</span><span class="p">,</span> <span class="n">wants</span><span class="p">,</span> <span class="n">linenums</span><span class="p">,</span> <span class="n">func_lineno</span><span class="p">,</span> <span class="n">docstr</span> <span class="o">=</span> <span class="n">get_doctest_examples</span><span class="p">(</span><span class="n">testable</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">testno</span> <span class="p">,</span> <span class="n">srcwant_tup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">wants</span><span class="p">)):</span>
                <span class="n">src</span><span class="p">,</span> <span class="n">want</span> <span class="o">=</span> <span class="n">srcwant_tup</span>
                <span class="n">src_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">regex_replace</span><span class="p">(</span><span class="s">&#39;from __future__ import.*$&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
                <span class="n">test_disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">src_</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">test_sentinals</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">needs_enable</span> <span class="ow">and</span> <span class="n">test_disabled</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">testname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">force_enable_testnames</span><span class="p">:</span>
                        <span class="c"># HACK</span>
                        <span class="k">if</span> <span class="n">testname2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">force_enable_testnames</span><span class="p">:</span>
                            <span class="c">#print(force_enable_testnames)</span>
                            <span class="c">#print(testname2)</span>
                            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                                <span class="k">print</span><span class="p">(</span><span class="s">&#39; * skipping: </span><span class="si">%r</span><span class="s"> / </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">testname2</span><span class="p">))</span>
                                <span class="c">#print(src)</span>
                                <span class="c">#print(&#39; * skipping&#39;)</span>
                            <span class="k">continue</span>
                        <span class="c">#else:</span>
                        <span class="c">#    testname = testname2</span>
                <span class="c">#ut.embed()</span>
                <span class="c">#. FIXME: you probably should only add one version of the testname to the list,</span>
                <span class="c"># and classname prefixes should probably be enforced</span>
                <span class="k">if</span> <span class="n">testname2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * HACK adding testname=</span><span class="si">%r</span><span class="s"> to local_testtup_list&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testname</span><span class="p">,))</span>
                    <span class="c">#local_testtup = (testname2, testno, src_, want)</span>
                    <span class="n">local_testtup</span> <span class="o">=</span> <span class="p">((</span><span class="n">testname2</span><span class="p">,</span> <span class="n">testname</span><span class="p">),</span> <span class="n">testno</span><span class="p">,</span> <span class="n">src_</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
                    <span class="n">local_testtup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_testtup</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39; * adding testname=</span><span class="si">%r</span><span class="s"> to local_testtup_list&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">testname</span><span class="p">,))</span>
                    <span class="n">local_testtup</span> <span class="o">=</span> <span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">testno</span><span class="p">,</span> <span class="n">src_</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
                    <span class="n">local_testtup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_testtup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;WARNING: no examples in </span><span class="si">%r</span><span class="s"> for testname=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame_fpath</span><span class="p">,</span> <span class="n">testname</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">testable</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">examples</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">wants</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39; --&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="c">#L________________________</span>
    <span class="c">#+------------------------</span>
    <span class="c"># Get enabled (requested) examples</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">-----</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">indenter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Indenter</span><span class="p">(</span><span class="s">&#39;[CHECK_ENABLED]&#39;</span><span class="p">)</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Need to find which examples are enabled&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;len(local_testtup_list) = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_testtup_list</span><span class="p">),))</span>
        <span class="c">#print(&#39;local_testtup_list = %r&#39; % (local_testtup_list,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;local_testtup_list.T[0:2].T = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">local_testtup_list</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])))</span>
        <span class="c">#print(&#39;(local_testtup_list) = %r&#39; % (local_testtup_list,))</span>
    <span class="n">all_testflags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enabled_testtup_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">distabled_testflags</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span><span class="s">&#39;--subx&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">help_</span><span class="o">=</span><span class="s">&#39;Only tests the subxth example&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">local_testtup</span> <span class="ow">in</span> <span class="n">local_testtup_list</span><span class="p">:</span>
        <span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_testtup</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nametup</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">nametup</span> <span class="o">=</span> <span class="p">(</span><span class="n">nametup</span><span class="p">,)</span>
        <span class="n">valid_flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exec_mode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">(</span><span class="n">valid_prefix_list</span><span class="p">,</span> <span class="n">nametup</span><span class="p">):</span>
            <span class="c">#prefix = &#39;--test-&#39;</span>
            <span class="n">flag1</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="n">flag2</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span>
            <span class="n">flag3</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
            <span class="n">flag4</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">valid_flags</span> <span class="o">+=</span> <span class="p">[</span><span class="n">flag1</span><span class="p">,</span> <span class="n">flag2</span><span class="p">,</span> <span class="n">flag3</span><span class="p">,</span> <span class="n">flag4</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Checking for flags*: &#39;</span> <span class="o">+</span> <span class="n">flag1</span><span class="p">)</span>
                <span class="c">#print(&#39; checking sys.argv for:\n %s&#39; % (ut.list_str(valid_flags),))</span>
            <span class="n">testflag</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="n">valid_flags</span><span class="p">)</span>
            <span class="c"># TODO: run in exec mode</span>
            <span class="n">exec_mode</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s">&#39;--exec-&#39;</span>  <span class="c"># NOQA</span>
            <span class="k">if</span> <span class="n">testflag</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">testenabled</span> <span class="o">=</span> <span class="n">TEST_ALL_EXAMPLES</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_flags</span> <span class="ow">or</span> <span class="n">testflag</span>
        <span class="k">if</span> <span class="n">subx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">subx</span> <span class="o">!=</span> <span class="n">num</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">all_testflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">testenabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;... enabling test&#39;</span><span class="p">)</span>
            <span class="n">testtup</span> <span class="o">=</span> <span class="n">TestTuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">flag1</span><span class="p">,</span>
                                <span class="n">frame_fpath</span><span class="o">=</span><span class="n">frame_fpath</span><span class="p">,</span>
                                <span class="n">exec_mode</span><span class="o">=</span><span class="n">exec_mode</span><span class="p">)</span>
            <span class="n">enabled_testtup_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testtup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;... disableing test&#39;</span><span class="p">)</span>
            <span class="n">distabled_testflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">VERBOSE_TEST</span><span class="p">:</span>
        <span class="n">indenter</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s">&#39;--list&#39;</span><span class="p">):</span>
        <span class="c"># HACK: Should probably just return a richer structure</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;testable_name_list = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span><span class="n">testable_name_list</span><span class="p">),))</span>

    <span class="n">mod_doctest_tup</span> <span class="o">=</span> <span class="n">ModuleDoctestTup</span><span class="p">(</span><span class="n">enabled_testtup_list</span><span class="p">,</span> <span class="n">frame_fpath</span><span class="p">,</span>
                                       <span class="n">all_testflags</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
    <span class="c">#L________________________</span>
    <span class="k">return</span> <span class="n">mod_doctest_tup</span>

</div>
<div class="viewcode-block" id="doctest_was_requested"><a class="viewcode-back" href="../../utool.html#utool.util_tests.doctest_was_requested">[docs]</a><span class="k">def</span> <span class="nf">doctest_was_requested</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; lets a  __main__ codeblock know that util_test should do its thing &quot;&quot;&quot;</span>
    <span class="n">valid_prefix_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--exec-&#39;</span><span class="p">,</span> <span class="s">&#39;--test-&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s">&#39;--tf&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">valid_prefix_list</span><span class="p">])</span>
                                      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="find_doctestable_modnames"><a class="viewcode-back" href="../../utool.html#utool.util_tests.find_doctestable_modnames">[docs]</a><span class="k">def</span> <span class="nf">find_doctestable_modnames</span><span class="p">(</span><span class="n">dpath_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_doctests_fnames</span><span class="o">=</span><span class="p">[],</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to find files with a call to ut.doctest_funcs in the __main__ part</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">fpath_list</span><span class="p">,</span> <span class="n">lines_list</span><span class="p">,</span> <span class="n">lxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="s">&#39;doctest_funcs&#39;</span><span class="p">,</span>
                                               <span class="n">dpath_list</span><span class="o">=</span><span class="n">dpath_list</span><span class="p">,</span>
                                               <span class="n">include_patterns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;*.py&#39;</span><span class="p">],</span>
                                               <span class="n">exclude_dirs</span><span class="o">=</span><span class="n">exclude_dirs</span><span class="p">,</span>
                                               <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">exclude_doctests_fnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude_doctests_fnames</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">is_not_excluded</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_doctests_fnames</span>
    <span class="n">doctest_modpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_not_excluded</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">))</span>
    <span class="n">doctest_modname_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_modname_from_modpath</span><span class="p">,</span> <span class="n">doctest_modpath_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">doctest_modname_list</span>

</div>
<div class="viewcode-block" id="find_untested_modpaths"><a class="viewcode-back" href="../../utool.html#utool.util_tests.find_untested_modpaths">[docs]</a><span class="k">def</span> <span class="nf">find_untested_modpaths</span><span class="p">(</span><span class="n">dpath_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_doctests_fnames</span><span class="o">=</span><span class="p">[],</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="p">[]):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">fpath_list</span><span class="p">,</span> <span class="n">lines_list</span><span class="p">,</span> <span class="n">lxs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="s">&#39;&gt;&gt;&gt; # ENABLE_DOCTEST&#39;</span><span class="p">,</span>
                                               <span class="n">dpath_list</span><span class="o">=</span><span class="n">dpath_list</span><span class="p">,</span>
                                               <span class="n">include_patterns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;*.py&#39;</span><span class="p">],</span>
                                               <span class="n">exclude_dirs</span><span class="o">=</span><span class="n">exclude_dirs</span><span class="p">,</span>
                                               <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                               <span class="n">inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">exclude_doctests_fnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exclude_doctests_fnames</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;__init__.py&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">is_not_excluded</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_doctests_fnames</span>
    <span class="n">doctest_modpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_not_excluded</span><span class="p">,</span> <span class="n">fpath_list</span><span class="p">))</span>
    <span class="c">#doctest_modname_list = list(map(ut.get_modname_from_modpath, doctest_modpath_list))</span>
    <span class="k">return</span> <span class="n">doctest_modpath_list</span>

</div>
<div class="viewcode-block" id="show_was_requested"><a class="viewcode-back" href="../../utool.html#utool.util_tests.show_was_requested">[docs]</a><span class="k">def</span> <span class="nf">show_was_requested</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns True if --show is specified on the commandline or you are in</span>
<span class="sd">    IPython (and presumably want some sort of interaction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">show_was_requested</span><span class="p">()</span>
    <span class="c">#import utool as ut</span>
    <span class="c">#return ut.get_argflag(&#39;--show&#39;) or ut.inIPython()</span>

</div>
<div class="viewcode-block" id="ExitTestException"><a class="viewcode-back" href="../../utool.html#utool.util_tests.ExitTestException">[docs]</a><span class="k">class</span> <span class="nc">ExitTestException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="quit_if_noshow"><a class="viewcode-back" href="../../utool.html#utool.util_tests.quit_if_noshow">[docs]</a><span class="k">def</span> <span class="nf">quit_if_noshow</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--show&#39;</span><span class="p">,</span> <span class="s">&#39;--save&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">inIPython</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">ExitTestException</span><span class="p">(</span><span class="s">&#39;This should be caught gracefully by ut.run_test&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="show_if_requested"><a class="viewcode-back" href="../../utool.html#utool.util_tests.show_if_requested">[docs]</a><span class="k">def</span> <span class="nf">show_if_requested</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">plottool</span> <span class="kn">as</span> <span class="nn">pt</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">show_if_requested</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="find_testfunc"><a class="viewcode-back" href="../../utool.html#utool.util_tests.find_testfunc">[docs]</a><span class="k">def</span> <span class="nf">find_testfunc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">test_funcname</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[],</span>
                  <span class="n">func_to_module_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">modname_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">package_contents</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="n">ignore_prefix</span><span class="p">,</span>
                                       <span class="n">ignore_suffix</span><span class="o">=</span><span class="n">ignore_suffix</span><span class="p">)</span>
    <span class="c"># Get only the modules already imported</span>
    <span class="n">have_modnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">modname_</span> <span class="k">for</span> <span class="n">modname_</span> <span class="ow">in</span> <span class="n">modname_list</span>
                     <span class="k">if</span> <span class="n">modname_</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">]</span>
    <span class="c">#missing_modnames = [modname for modname in modname_list</span>
    <span class="c">#                    if modname not in sys.modules]</span>
    <span class="n">module_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">,</span> <span class="n">have_modnames</span><span class="p">)</span>
    <span class="c"># Search for the module containing the function</span>
    <span class="n">test_func</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">test_module</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">test_classname</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">test_classname</span><span class="p">,</span> <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">test_funcname</span><span class="p">,</span> <span class="n">testno</span> <span class="o">=</span> <span class="n">test_funcname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">testno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">testno</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">test_classname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">module_</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
            <span class="c">#test_funcname = &#39;find_installed_tomcat&#39;</span>
            <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">in</span> <span class="n">module_</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
                <span class="n">test_module</span> <span class="o">=</span> <span class="n">module_</span>
                <span class="n">test_func</span> <span class="o">=</span> <span class="n">test_module</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">test_funcname</span><span class="p">]</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">module_</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">:</span>
            <span class="c">#test_funcname = &#39;find_installed_tomcat&#39;</span>
            <span class="k">if</span> <span class="n">test_classname</span> <span class="ow">in</span> <span class="n">module_</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
                <span class="n">test_module</span> <span class="o">=</span> <span class="n">module_</span>
                <span class="n">test_class</span> <span class="o">=</span> <span class="n">test_module</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">test_classname</span><span class="p">]</span>
                <span class="n">test_func</span> <span class="o">=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">test_funcname</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">test_func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Did not find any function named </span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Searched &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">([</span><span class="n">mod</span><span class="o">.</span><span class="n">__name__</span>
                                         <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">module_list</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">test_func</span><span class="p">,</span> <span class="n">testno</span>

</div>
<div class="viewcode-block" id="main_function_tester"><a class="viewcode-back" href="../../utool.html#utool.util_tests.main_function_tester">[docs]</a><span class="k">def</span> <span class="nf">main_function_tester</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span> <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[],</span>
                         <span class="n">test_funcname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">func_to_module_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows a shorthand for __main__ packages of modules to run tests with</span>
<span class="sd">    unique function names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">colorprint</span><span class="p">(</span><span class="s">&#39;[utool] main_function_tester&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">)</span>

    <span class="n">test_funcname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argval</span><span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;--test-func&#39;</span><span class="p">,</span> <span class="s">&#39;--tfunc&#39;</span><span class="p">,</span> <span class="s">&#39;--tf&#39;</span><span class="p">,</span> <span class="s">&#39;--testfunc&#39;</span><span class="p">),</span>
        <span class="n">type_</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">test_funcname</span><span class="p">,</span>
        <span class="n">help_</span><span class="o">=</span><span class="s">&#39;specify a function to doctest&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;test_funcname = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">in</span> <span class="n">func_to_module_dict</span><span class="p">:</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">func_to_module_dict</span><span class="p">[</span><span class="n">test_funcname</span><span class="p">]</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">test_funcname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#locals_ = {}</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">inject_colored_exceptions</span><span class="p">()</span>
        <span class="c"># print(&#39;[utool] __main__ Begin Function Test&#39;)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;[utool] __main__ Begin Function Test&#39;</span><span class="p">)</span>
        <span class="n">test_func</span><span class="p">,</span> <span class="n">testno</span> <span class="o">=</span> <span class="n">find_testfunc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">test_funcname</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="p">,</span>
                                          <span class="n">ignore_suffix</span><span class="p">,</span> <span class="n">func_to_module_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">test_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">globals_</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">func_globals</span> <span class="o">=</span> <span class="n">meta_util_six</span><span class="o">.</span><span class="n">get_funcglobals</span><span class="p">(</span><span class="n">test_func</span><span class="p">)</span>
            <span class="n">globals_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">func_globals</span><span class="p">)</span>
            <span class="n">testsrc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_doctest_examples</span><span class="p">(</span><span class="n">test_func</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">testno</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s">&#39;--cmd&#39;</span><span class="p">,</span> <span class="s">&#39;--embed&#39;</span><span class="p">)):</span>
                <span class="n">testsrc</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">import utool as ut; ut.embed()&#39;</span>  <span class="c"># TODO RECTIFY WITH EXEC DOCTEST</span>
            <span class="n">doctest_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s">&#39;&gt;&gt;&gt; &#39;</span><span class="p">)</span>
            <span class="n">doctest_src</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%3d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doctest_src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
            <span class="n">colored_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">doctest_src</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;testsrc = </span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colored_src</span><span class="p">,))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
                <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">globals_</span><span class="p">)</span>  <span class="c"># , locals_)</span>
            <span class="k">except</span> <span class="n">ExitTestException</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Test exited before show&#39;</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="n">retcode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Finished function test.&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...exiting&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">retcode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Did not find any function named </span><span class="si">%r</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_funcname</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;...exiting&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="execute_doctest"><a class="viewcode-back" href="../../utool.html#utool.util_tests.execute_doctest">[docs]</a><span class="k">def</span> <span class="nf">execute_doctest</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">testnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a function doctest. Can optionaly specify func name and module to</span>
<span class="sd">    run from ipython notebooks.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from utool.util_tests import *  # NOQA</span>

<span class="sd">    IPython:</span>
<span class="sd">        import utool as ut</span>
<span class="sd">        ut.execute_doctest(func=&#39;dummy_example_depcacahe&#39;, module=&#39;dtool.example_depcache&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="n">funcname</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">modname</span> <span class="o">=</span> <span class="n">module</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">import_modname</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">_testno</span> <span class="o">=</span> <span class="n">find_testfunc</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">ignore_prefix</span><span class="o">=</span><span class="p">[],</span>
                                      <span class="n">ignore_suffix</span><span class="o">=</span><span class="p">[])</span>
    <span class="c"># TODO RECTIFY WITH EXEC DOCTEST</span>
    <span class="n">globals_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">testsrc</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_doctest_examples</span><span class="p">(</span><span class="n">func</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">testnum</span><span class="p">]</span>
    <span class="c"># colored_src = ut.highlight_code(ut.indent(testsrc, &#39;&gt;&gt;&gt; &#39;))</span>
    <span class="n">doctest_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s">&#39;&gt;&gt;&gt; &#39;</span><span class="p">)</span>
    <span class="n">doctest_src</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%3d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doctest_src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">colored_src</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">highlight_code</span><span class="p">(</span><span class="n">doctest_src</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;testsrc = </span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colored_src</span><span class="p">,))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">testsrc</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">globals_</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ExitTestException</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Test exited before show&#39;</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -c &quot;import utool, utool.util_tests; utool.doctest_funcs(utool.util_tests)&quot;</span>
<span class="sd">        python -m utool.util_tests</span>
<span class="sd">        python -m utool.util_tests --allexamples</span>
<span class="sd">        python -m utool.util_tests</span>

<span class="sd">        python -c &quot;import utool; utool.doctest_funcs(module=utool.util_tests, needs_enable=False)&quot;</span>
<span class="sd">        /model/preproc/preproc_chip.py --allexamples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="kn">as</span> <span class="nn">ut</span>  <span class="c"># NOQA</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
    <span class="c">#doctest_funcs()</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>


  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Jon Crall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>





    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.1.2.dev1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>





    <script type="text/javascript" src="../../_static/js/theme.js"></script>




  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>


</body>
</html>